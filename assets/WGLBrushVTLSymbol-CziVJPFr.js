import{l3 as tt,aq as k,tu as w,pe as O,or as N,h as et,ow as at,o as it,tv as H,ak as q,tw as G,os as b,tx as nt,ty as A,tz as Y,rv as B,k_ as rt,tA as Q}from"./index-BS4ejk0L.js";import{r as st}from"./vec4f32-CjrfB-0a.js";let F=class{constructor(){this.name=this.constructor.name||"UnnamedBrush",this.brushEffect=null}prepareState(i,e){}draw(i,e,t){}drawMany(i,e,t){for(const n of e)n.visible&&this.draw(i,n,t)}},mt=class extends F{constructor(){super(...arguments),this._color=st(1,0,0,1),this._patternMatrix=tt(),this._programOptions={id:!1,pattern:!1}}dispose(){this._vao&&(this._vao.dispose(),this._vao=null)}drawMany(i,e){const{context:t,painter:n,requestRender:l,allowDelayedRender:_}=i;this._loadWGLResources(i);const f=i.displayLevel,s=i.styleLayer,U=s.backgroundMaterial,d=n.vectorTilesMaterialManager,v=s.getPaintValue("background-color",f),p=s.getPaintValue("background-opacity",f),S=s.getPaintValue("background-pattern",f),y=S!==void 0,P=1|window.devicePixelRatio,M=i.spriteMosaic;let x,E;const c=P>H?2:1,g=this._programOptions;g.pattern=y;const r=d.getMaterialProgram(t,U,g);if(!_||l==null||r.compiled){if(t.bindVAO(this._vao),t.useProgram(r),y){const a=M.getMosaicItemPosition(S,!0);if(a!=null){const{tl:u,br:m,page:o}=a;x=m[0]-u[0],E=m[1]-u[1];const T=M.getPageSize(o);T!=null&&(M.bind(t,k.LINEAR,o,w),r.setUniform4f("u_tlbr",u[0],u[1],m[0],m[1]),r.setUniform2fv("u_mosaicSize",T),r.setUniform1i("u_texture",w))}r.setUniform1f("u_opacity",p)}else{const a=v[3]*p;this._color[0]=a*v[0],this._color[1]=a*v[1],this._color[2]=a*v[2],this._color[3]=a,r.setUniform4fv("u_color",this._color)}r.setUniform1f("u_depth",s.z||0);for(const a of e){if(r.setUniform1f("u_coord_range",a.rangeX),r.setUniformMatrix3fv("u_dvsMat3",a.transforms.displayViewScreenMat3),y){const u=Math.max(2**(Math.round(f)-a.key.level),1),m=c*a.width*u,o=m/q(x),T=m/q(E);this._patternMatrix[0]=o,this._patternMatrix[4]=T,r.setUniformMatrix3fv("u_pattern_matrix",this._patternMatrix)}t.setStencilFunction(O.EQUAL,0,255),t.drawArrays(N.TRIANGLE_STRIP,0,4)}}else l()}_loadWGLResources(i){if(this._vao)return;const{context:e,styleLayer:t}=i,n=t.backgroundMaterial,l=new Int8Array([0,0,1,0,0,1,1,1]),_=et.createVertex(e,at.STATIC_DRAW,l),f=new it(e,n.getAttributeLocations(),n.getLayoutInfo(),{geometry:_});this._vao=f}};class yt extends F{constructor(){super(...arguments),this._programOptions={id:!1}}dispose(){}drawMany(i,e){const{context:t,displayLevel:n,requiredLevel:l,state:_,painter:f,spriteMosaic:s,styleLayerUID:U,requestRender:d,allowDelayedRender:v}=i;if(!e.some(r=>{var a;return((a=r.layerData.get(U))==null?void 0:a.circleIndexCount)??!1}))return;const p=i.styleLayer,S=p.circleMaterial,y=f.vectorTilesMaterialManager,P=1.2,M=p.getPaintValue("circle-translate",n),x=p.getPaintValue("circle-translate-anchor",n),E=this._programOptions,c=y.getMaterialProgram(t,S,E);if(v&&d!=null&&!c.compiled)return void d();t.useProgram(c),c.setUniformMatrix3fv("u_displayMat3",x===G.VIEWPORT?_.displayMat3:_.displayViewMat3),c.setUniform2fv("u_circleTranslation",M),c.setUniform1f("u_depth",p.z),c.setUniform1f("u_antialiasingWidth",P);let g=-1;for(const r of e){if(!r.layerData.has(U))continue;r.key.level!==g&&(g=r.key.level,S.setDataUniforms(c,n,p,g,s));const a=r.layerData.get(U);if(!a.circleIndexCount)continue;a.prepareForRendering(t);const u=a.vao;u!=null&&(t.bindVAO(u),c.setUniformMatrix3fv("u_dvsMat3",r.transforms.displayViewScreenMat3),l!==r.key.level?t.setStencilFunction(O.EQUAL,r.stencilRef,255):t.setStencilFunction(O.GREATER,255,255),t.drawElements(N.TRIANGLES,a.circleIndexCount,b.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*a.circleIndexStart),r.triangleCount+=a.circleIndexCount/3)}}}const X=1/65536;class _t extends F{constructor(){super(...arguments),this._fillProgramOptions={id:!1,pattern:!1},this._outlineProgramOptions={id:!1}}dispose(){}drawMany(i,e){const{displayLevel:t,renderPass:n,spriteMosaic:l,styleLayerUID:_}=i;let f=!1;for(const c of e)if(c.layerData.has(_)){const g=c.layerData.get(_);if(g.fillIndexCount>0||g.outlineIndexCount>0){f=!0;break}}if(!f)return;const s=i.styleLayer,U=s.getPaintProperty("fill-pattern"),d=U!==void 0,v=d&&U.isDataDriven;let p;if(d&&!v){const c=U.getValue(t);p=l.getMosaicItemPosition(c,!0)}const S=!d&&s.getPaintValue("fill-antialias",t);let y=!0,P=1;if(!d){const c=s.getPaintProperty("fill-color"),g=s.getPaintProperty("fill-opacity");if(!(c!=null&&c.isDataDriven)&&!(g!=null&&g.isDataDriven)){const r=s.getPaintValue("fill-color",t);P=s.getPaintValue("fill-opacity",t)*r[3],P>=1&&(y=!1)}}if(y&&n==="opaque")return;const M=s.getPaintValue("fill-translate",t),x=s.getPaintValue("fill-translate-anchor",t);(y||n!=="translucent")&&this._drawFill(i,_,s,e,M,x,d,p,v);const E=!s.hasDataDrivenOutlineColor&&s.outlineUsesFillColor&&P<1;S&&n!=="opaque"&&!E&&this._drawOutline(i,_,s,e,M,x)}_drawFill(i,e,t,n,l,_,f,s,U){if(f&&!U&&s==null)return;const{context:d,displayLevel:v,state:p,painter:S,pixelRatio:y,spriteMosaic:P,requestRender:M,allowDelayedRender:x}=i,E=t.fillMaterial,c=S.vectorTilesMaterialManager,g=y>H?2:1,r=this._fillProgramOptions;r.pattern=f;const a=c.getMaterialProgram(d,E,r);if(x&&M!=null&&!a.compiled)return void M();if(d.useProgram(a),s!=null){const{page:m}=s,o=P.getPageSize(m);o!=null&&(P.bind(d,k.LINEAR,m,w),a.setUniform2fv("u_mosaicSize",o),a.setUniform1i("u_texture",w))}a.setUniformMatrix3fv("u_displayMat3",_===G.VIEWPORT?p.displayMat3:p.displayViewMat3),a.setUniform2fv("u_fillTranslation",l),a.setUniform1f("u_depth",t.z+X);let u=-1;for(const m of n){if(!m.layerData.has(e))continue;m.key.level!==u&&(u=m.key.level,E.setDataUniforms(a,v,t,u,P));const o=m.layerData.get(e);if(!o.fillIndexCount)continue;o.prepareForRendering(d);const T=o.fillVAO;if(T!=null){if(d.bindVAO(T),a.setUniformMatrix3fv("u_dvsMat3",m.transforms.displayViewScreenMat3),d.setStencilFunction(O.EQUAL,m.stencilRef,255),f){const h=Math.max(2**(Math.round(v)-m.key.level),1),R=m.rangeX/(g*m.width*h);a.setUniform1f("u_patternFactor",R)}if(U){const h=o.patternMap;if(!h)continue;for(const[R,D]of h){const z=P.getPageSize(R);z!=null&&(P.bind(d,k.LINEAR,R,w),a.setUniform2fv("u_mosaicSize",z),a.setUniform1i("u_texture",w),d.drawElements(N.TRIANGLES,D[1],b.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*D[0]))}}else d.drawElements(N.TRIANGLES,o.fillIndexCount,b.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*o.fillIndexStart);m.triangleCount+=o.fillIndexCount/3}}}_drawOutline(i,e,t,n,l,_){const{context:f,displayLevel:s,state:U,painter:d,pixelRatio:v,spriteMosaic:p,requestRender:S,allowDelayedRender:y}=i,P=t.outlineMaterial,M=d.vectorTilesMaterialManager,x=.75/v,E=this._outlineProgramOptions,c=M.getMaterialProgram(f,P,E);if(y&&S!=null&&!c.compiled)return void S();f.useProgram(c),c.setUniformMatrix3fv("u_displayMat3",_===G.VIEWPORT?U.displayMat3:U.displayViewMat3),c.setUniform2fv("u_fillTranslation",l),c.setUniform1f("u_depth",t.z+X),c.setUniform1f("u_outline_width",x);let g=-1;for(const r of n){if(!r.layerData.has(e))continue;r.key.level!==g&&(g=r.key.level,P.setDataUniforms(c,s,t,g,p));const a=r.layerData.get(e);if(a.prepareForRendering(f),!a.outlineIndexCount)continue;const u=a.outlineVAO;u!=null&&(f.bindVAO(u),c.setUniformMatrix3fv("u_dvsMat3",r.transforms.displayViewScreenMat3),f.setStencilFunction(O.EQUAL,r.stencilRef,255),f.drawElements(N.TRIANGLES,a.outlineIndexCount,b.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*a.outlineIndexStart),r.triangleCount+=a.outlineIndexCount/3)}}}class Mt extends F{constructor(){super(...arguments),this._programOptions={id:!1,pattern:!1,sdf:!1}}dispose(){}drawMany(i,e){const{context:t,displayLevel:n,state:l,painter:_,pixelRatio:f,spriteMosaic:s,styleLayerUID:U,requestRender:d,allowDelayedRender:v}=i;if(!e.some(h=>{var R;return((R=h.layerData.get(U))==null?void 0:R.lineIndexCount)??!1}))return;const p=i.styleLayer,S=p.lineMaterial,y=_.vectorTilesMaterialManager,P=p.getPaintValue("line-translate",n),M=p.getPaintValue("line-translate-anchor",n),x=p.getPaintProperty("line-pattern"),E=x!==void 0,c=E&&x.isDataDriven;let g,r;if(E&&!c){const h=x.getValue(n);g=s.getMosaicItemPosition(h)}let a=!1;if(!E){const h=p.getPaintProperty("line-dasharray");if(r=h!==void 0,a=r&&h.isDataDriven,r&&!a){const R=h.getValue(n),D=p.getDashKey(R,p.getLayoutValue("line-cap",n));g=s.getMosaicItemPosition(D)}}const u=1/f,m=this._programOptions;m.pattern=E,m.sdf=r;const o=y.getMaterialProgram(t,S,m);if(v&&d!=null&&!o.compiled)return void d();if(t.useProgram(o),o.setUniformMatrix3fv("u_displayViewMat3",l.displayViewMat3),o.setUniformMatrix3fv("u_displayMat3",M===G.VIEWPORT?l.displayMat3:l.displayViewMat3),o.setUniform2fv("u_lineTranslation",P),o.setUniform1f("u_depth",p.z),o.setUniform1f("u_antialiasing",u),g&&g!=null){const{page:h}=g,R=s.getPageSize(h);R!=null&&(s.bind(t,k.LINEAR,h,w),o.setUniform2fv("u_mosaicSize",R),o.setUniform1i("u_texture",w))}let T=-1;for(const h of e){if(!h.layerData.has(U))continue;h.key.level!==T&&(T=h.key.level,S.setDataUniforms(o,n,p,T,s));const R=2**(n-T)/f;o.setUniform1f("u_zoomFactor",R);const D=h.layerData.get(U);if(!D.lineIndexCount)continue;D.prepareForRendering(t);const z=D.vao;if(z!=null){if(t.bindVAO(z),o.setUniformMatrix3fv("u_dvsMat3",h.transforms.displayViewScreenMat3),t.setStencilFunction(O.EQUAL,h.stencilRef,255),c||a){const $=D.patternMap;if(!$)continue;for(const[I,C]of $){const L=s.getPageSize(I);L!=null&&(s.bind(t,k.LINEAR,I,w),o.setUniform2fv("u_mosaicSize",L),o.setUniform1i("u_texture",w),t.drawElements(N.TRIANGLES,C[1],b.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*C[0]))}}else t.drawElements(N.TRIANGLES,D.lineIndexCount,b.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*D.lineIndexStart);h.triangleCount+=D.lineIndexCount/3}}}}const ot=256/360,lt=1/Math.LN2;function ct(V,i){return(V%=i)>=0?V:V+i}function j(V){return ct(V*ot,256)}function ht(V){return Math.log(V)*lt}const ut=1/65536;class Ut extends F{constructor(){super(...arguments),this._iconProgramOptions={id:!1,sdf:!1},this._sdfProgramOptions={id:!1},this._spritesTextureSize=nt()}dispose(){}drawMany(i,e){const t=i.styleLayer;this._drawIcons(i,t,e),this._drawText(i,t,e)}_drawIcons(i,e,t){const{context:n,displayLevel:l,painter:_,spriteMosaic:f,state:s,styleLayerUID:U,requestRender:d,allowDelayedRender:v}=i,p=e.iconMaterial,S=_.vectorTilesMaterialManager;let y,P=!1;for(const o of t)if(o.layerData.has(U)&&(y=o.layerData.get(U),y.iconPerPageElementsMap.size>0)){P=!0;break}if(!P)return;const M=e.getPaintValue("icon-translate",l),x=e.getPaintValue("icon-translate-anchor",l);let E=e.getLayoutValue("icon-rotation-alignment",l);E===A.AUTO&&(E=e.getLayoutValue("symbol-placement",l)===Y.POINT?A.VIEWPORT:A.MAP);const c=E===A.MAP,g=e.getLayoutValue("icon-keep-upright",l)&&c,r=y.isIconSDF,a=this._iconProgramOptions;a.sdf=r;const u=S.getMaterialProgram(n,p,a);if(v&&d!=null&&!u.compiled)return void d();n.useProgram(u),u.setUniformMatrix3fv("u_displayViewMat3",E===A.MAP?s.displayViewMat3:s.displayMat3),u.setUniformMatrix3fv("u_displayMat3",x===G.VIEWPORT?s.displayMat3:s.displayViewMat3),u.setUniform2fv("u_iconTranslation",M),u.setUniform1f("u_depth",e.z),u.setUniform1f("u_mapRotation",j(s.rotation)),u.setUniform1f("u_keepUpright",g?1:0),u.setUniform1f("u_level",10*l),u.setUniform1i("u_texture",w),u.setUniform1f("u_fadeDuration",B/1e3);let m=-1;for(const o of t){if(!o.layerData.has(U)||(o.key.level!==m&&(m=o.key.level,p.setDataUniforms(u,l,e,m,f)),y=o.layerData.get(U),y.iconPerPageElementsMap.size===0))continue;y.prepareForRendering(n),y.updateOpacityInfo();const T=y.iconVAO;if(T!=null){n.bindVAO(T),u.setUniformMatrix3fv("u_dvsMat3",o.transforms.displayViewScreenMat3),u.setUniform1f("u_time",(performance.now()-y.lastOpacityUpdate)/1e3);for(const[h,R]of y.iconPerPageElementsMap)this._renderIconRange(i,u,R,h,o)}}}_renderIconRange(i,e,t,n,l){const{context:_,spriteMosaic:f}=i;this._spritesTextureSize[0]=f.getWidth(n)/4,this._spritesTextureSize[1]=f.getHeight(n)/4,e.setUniform2fv("u_mosaicSize",this._spritesTextureSize),f.bind(_,k.LINEAR,n,w),this._setStencilState(i,l),_.drawElements(N.TRIANGLES,t[1],b.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*t[0]),l.triangleCount+=t[1]/3}_drawText(i,e,t){const{context:n,displayLevel:l,glyphMosaic:_,painter:f,pixelRatio:s,spriteMosaic:U,state:d,styleLayerUID:v,requestRender:p,allowDelayedRender:S}=i,y=e.textMaterial,P=f.vectorTilesMaterialManager;let M,x=!1;for(const L of t)if(L.layerData.has(v)&&(M=L.layerData.get(v),M.glyphPerPageElementsMap.size>0)){x=!0;break}if(!x)return;const E=e.getPaintProperty("text-opacity");if(E&&!E.isDataDriven&&E.getValue(l)===0)return;const c=e.getPaintProperty("text-color"),g=!c||c.isDataDriven||c.getValue(l)[3]>0,r=e.getPaintProperty("text-halo-width"),a=e.getPaintProperty("text-halo-color"),u=(!r||r.isDataDriven||r.getValue(l)>0)&&(!a||a.isDataDriven||a.getValue(l)[3]>0);if(!g&&!u)return;const m=24/8;let o=e.getLayoutValue("text-rotation-alignment",l);o===A.AUTO&&(o=e.getLayoutValue("symbol-placement",l)===Y.POINT?A.VIEWPORT:A.MAP);const T=o===A.MAP,h=e.getLayoutValue("text-keep-upright",l)&&T,R=.8*m/s;this._glyphTextureSize||(this._glyphTextureSize=rt(_.width/4,_.height/4));const D=e.getPaintValue("text-translate",l),z=e.getPaintValue("text-translate-anchor",l),$=this._sdfProgramOptions,I=P.getMaterialProgram(n,y,$);if(S&&p!=null&&!I.compiled)return void p();n.useProgram(I),I.setUniformMatrix3fv("u_displayViewMat3",o===A.MAP?d.displayViewMat3:d.displayMat3),I.setUniformMatrix3fv("u_displayMat3",z===G.VIEWPORT?d.displayMat3:d.displayViewMat3),I.setUniform2fv("u_textTranslation",D),I.setUniform1f("u_depth",e.z+ut),I.setUniform2fv("u_mosaicSize",this._glyphTextureSize),I.setUniform1f("u_mapRotation",j(d.rotation)),I.setUniform1f("u_keepUpright",h?1:0),I.setUniform1f("u_level",10*l),I.setUniform1i("u_texture",Q),I.setUniform1f("u_antialiasingWidth",R),I.setUniform1f("u_fadeDuration",B/1e3);let C=-1;for(const L of t){if(!L.layerData.has(v)||(L.key.level!==C&&(C=L.key.level,y.setDataUniforms(I,l,e,C,U)),M=L.layerData.get(v),M.glyphPerPageElementsMap.size===0))continue;M.prepareForRendering(n),M.updateOpacityInfo();const W=M.textVAO;if(W==null)continue;n.bindVAO(W),I.setUniformMatrix3fv("u_dvsMat3",L.transforms.displayViewScreenMat3),this._setStencilState(i,L);const K=(performance.now()-M.lastOpacityUpdate)/1e3;I.setUniform1f("u_time",K),M.glyphPerPageElementsMap.forEach((J,Z)=>{this._renderGlyphRange(n,J,Z,_,I,u,g,L)})}}_renderGlyphRange(i,e,t,n,l,_,f,s){n.bind(i,k.LINEAR,t,Q),_&&(l.setUniform1f("u_halo",1),i.drawElements(N.TRIANGLES,e[1],b.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*e[0]),s.triangleCount+=e[1]/3),f&&(l.setUniform1f("u_halo",0),i.drawElements(N.TRIANGLES,e[1],b.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*e[0]),s.triangleCount+=e[1]/3)}_setStencilState(i,e){const{context:t,is3D:n,stencilSymbols:l}=i;if(t.setStencilTestEnabled(!0),l)return t.setStencilWriteMask(255),void t.setStencilFunction(O.ALWAYS,e.stencilRef,255);t.setStencilWriteMask(0),n?t.setStencilFunction(O.EQUAL,e.stencilRef,255):t.setStencilFunction(O.GREATER,255,255)}}export{Ut as d,ht as e,_t as f,yt as n,Mt as s,F as t,mt as u};
