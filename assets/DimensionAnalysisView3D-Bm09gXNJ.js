import{yW as zt,yX as Ht,eL as b,f0 as T,gg as g,sK as Rt,v_ as Le,m6 as Ge,iO as Ie,iS as k,eI as F,eX as V,wW as tt,gf as W,eJ as kt,fi as De,f4 as de,fV as J,yG as Ue,fc as Et,f7 as Me,E as d,F as u,J as G,O as Y,yY as fe,eq as ae,br as v,by as A,co as Vt,aU as it,a3 as B,mo as Lt,nX as Gt,tP as nt,ms as It,g6 as ee,eU as se,tV as R,ue as Ut,P as te,yZ as Ft,ee as x,cv as we,g2 as at,t_ as jt,fO as st,gi as ot,eK as rt,g0 as P,g5 as q,f$ as ce,bW as j,fR as Pe,fP as be,fQ as lt,xK as Fe,es as Bt,et as je,eu as Be,f8 as Nt,fY as qt,o7 as dt,D as Kt,n_ as ue,bs as Ce,M as Te,c5 as Ae,y_ as Oe,ck as Ne,am as ct,y$ as Wt,fA as Yt,z0 as Xt,gh as Zt,z1 as ut,mh as Jt,mi as Qt,z2 as ei,z3 as X,nM as ti,nO as ii,bc as ni,em as qe}from"./index-D2dWKXoe.js";import{s as ai}from"./AnalysisView3D-aRBWBZ1U.js";import{t as _,r as si,u as oi}from"./LengthDimension-pSDH8mxQ.js";import{e as ri}from"./getDefaultUnitForView-C9_kBQfj.js";import{c as pt}from"./quantityUtils-D4B7S4Ay.js";import{m as N,f as li}from"./Segment-DxQywQEc.js";import{m as di,Z as ci,a as ui}from"./automaticLengthMeasurementUtils-DBSEsgkJ.js";import{r as mt}from"./geodesicMeasurementUtils-DzAxKO3X.js";import{e as _e,d as pi,a as z,b as ht,w as xe,h as re,c as mi}from"./RenderObject-D5Q-6X4H.js";import{z as hi,O as gt,q as ze}from"./dragEventPipeline3D-DWNt5svV.js";import{T as ft}from"./ImageMaterial.glsl-CNIN8YCo.js";import{x as oe,M as He,Y as gi}from"./InteractiveToolBase-DdeEXL8I.js";import{t as fi}from"./memoize-DsJmrG76.js";import{l as _i}from"./Factory-Dg8YpCEB.js";import{O as vi}from"./SnappingVisualizer3D-Qhs1S7SG.js";import{f as I,r as yi,t as Si}from"./LineVisualElement-BTtzjko4.js";import{d as Mi}from"./VerticesVisualElement-D27SrEpt.js";import{V as wi,p as Pi,P as bi}from"./EditGeometryOperations-DkXj4dsd.js";import{a as Ci}from"./SceneSnappingManagerPool-3s4cBmfO.js";import{e as Oi}from"./SnappingContext-Cpn1WUY8.js";import{f as $i}from"./SnappingDragPipelineStep-f7zmgLEk.js";import{p as Di}from"./SnappingOperation-tRM3weLJ.js";import{N as Ti,e as Ke}from"./angularMeasurementUtils-D3zeviIM.js";import{o as Ai}from"./ShadedColorMaterial.glsl-BEwQAGcL.js";import{t as xi}from"./ToolIntersector-DNI5g4Id.js";import{h as zi}from"./quantityFormatUtils-D3--B9Q6.js";import{r as Hi,t as Ri}from"./vec4f32-CjrfB-0a.js";import{a as ki}from"./Object3DVisualElement-nzfHUdKZ.js";import{a as Ei,v as Vi,l as Li}from"./analysisViewUtils-mIiZe11E.js";import"./VisualElement-Bkfawgun.js";import"./viewUtils-jOSSHAZP.js";import"./TextOverlayItem-BbxI4F5t.js";import"./measurementUtils-CD0kjjPG.js";import"./SnappingManager-BCnKLkaT.js";import"./geometryEngine-Bmlaqucx.js";import"./geometryEngineBase-C1UOpB5A.js";import"./hydrated-CRFlPVgK.js";import"./geodesicUtils-0BUrW_mO.js";import"./geometry2dUtils-14ZJrqSH.js";import"./drawUtils-CLrYXPOv.js";import"./ExtendedLineVisualElement-BQOWz5Rf.js";import"./EngineVisualElement-Bohb_G5_.js";import"./LaserlineVisualElement-o2-a7s0w.js";import"./Laserlines.glsl-QXBQSV5f.js";import"./RightAngleQuadVisualElement-DcIuX5Lg.js";import"./SnappingVisualizer-BHFuzFxX.js";import"./PointSnappingHint-BIO8m24G.js";import"./dehydratedFeatureComparison-DMPz3V4Q.js";import"./unitFormatUtils-BobBl4gB.js";function Gi(e,t,i){if(e==null)return null;let n;if(t===_.Horizontal)n=di(e.elevationAlignedStartPoint,e.elevationAlignedEndPoint);else{const{startRenderSpace:s,endRenderSpace:o}=e.dimensionSegment;n=ci(s,o,e.spatialReference)}if(n==null)return null;const a=t===_.Vertical?zt(n.value,n.unit,i):Ht(n.value,n.unit,i);return pt(n,a)}function pe(e){const{elevationAlignedStartPoint:t,elevationAlignedEndPoint:i,dimension:{offset:n,measureType:a,orientation:s}}=e;return{elevationAlignedStartPoint:t,elevationAlignedEndPoint:i,offset:n,measureType:a,orientation:s}}function me({elevationAlignedStartPoint:e,elevationAlignedEndPoint:t,offset:i,measureType:n,orientation:a},s,o=null){if(e==null||t==null)return null;const l=vt((o==null?void 0:o.directSegment)??new N,{elevationAlignedStartPoint:e,elevationAlignedEndPoint:t},s),r=(o==null?void 0:o.primaryOffsetAxis)??b();ve(r,{measureType:n,elevationAlignedStartPoint:e,elevationAlignedEndPoint:t,directSegment:l,orientation:a,renderCoordsHelper:s});const c=(o==null?void 0:o.dimensionSegment)??new N;return Re({elevationAlignedStartPoint:e,elevationAlignedEndPoint:t})&&n===_.Vertical?(T(c.startRenderSpace,l.startRenderSpace),T(c.endRenderSpace,l.endRenderSpace)):yt(c,{offsetAxis:r,offset:i,relativeToSegment:l,renderCoordsHelper:s}),{elevationAlignedStartPoint:e,elevationAlignedEndPoint:t,directSegment:l,dimensionSegment:c,primaryOffsetAxis:r,spatialReference:s.spatialReference}}function We(e,t,i,n){return t===ie.Start?(T(e.startRenderSpace,i.startRenderSpace),T(e.endRenderSpace,n.startRenderSpace)):(T(e.startRenderSpace,i.endRenderSpace),T(e.endRenderSpace,n.endRenderSpace)),e}var ie;function Ii(e,t,i,n){de(e.startRenderSpace,t.startRenderSpace,i,n),de(e.endRenderSpace,t.endRenderSpace,i,n)}function _t(e,t,i,n){switch(t){case _.Direct:return vt(e,i,n);case _.Horizontal:case _.Vertical:{const{elevationAlignedStartPoint:a,elevationAlignedEndPoint:s,dimension:o,geometry:l}=i;let r;o.measureType===_.Direct?(r=Ui(l,n)===a.z>s.z,t===_.Horizontal&&(r=!r)):r=!Fi(l);const[c,p]=r?[a,s]:[s,a],h=J(p,ji);return t===_.Horizontal?h.z=c.z:(h.x=c.x,h.y=c.y),n.toRenderCoords(c,e.startRenderSpace),n.toRenderCoords(h,e.endRenderSpace),e}}}function vt(e,t,i){return i.toRenderCoords(t.elevationAlignedStartPoint,e.startRenderSpace),i.toRenderCoords(t.elevationAlignedEndPoint,e.endRenderSpace),e}function Ui(e,t){const i=e.directSegment.eval(.5,g.get()),n=t.worldUpAtPosition(i,g.get()),a=e.dimensionSegment.eval(.5,g.get()),s=k(g.get(),a,i);return!tt(s,W)&&V(s,n)>0}function Fi(e){const{startRenderSpace:t,endRenderSpace:i}=e.dimensionSegment,{startRenderSpace:n,endRenderSpace:a}=e.directSegment;return Ue(n,t)<Ue(a,i)}(function(e){e[e.Start=0]="Start",e[e.End=1]="End"})(ie||(ie={}));const ji=Et(0,0,0,null);function Bi(e,t,i,n){const{directSegment:a}=i,s=ve(g.get(),{measureType:t,directSegment:a,renderCoordsHelper:n}),o=yt(Ni,{offsetAxis:s,offset:0,relativeToSegment:a,renderCoordsHelper:n}).eval(.5,g.get()),l=k(g.get(),e,o);return V(l,s)*n.unitInMeters}const Ni=new N;function ve(e,t){const{measureType:i,elevationAlignedStartPoint:n,elevationAlignedEndPoint:a,directSegment:{startRenderSpace:s,endRenderSpace:o},directSegment:l,renderCoordsHelper:r}=t,c=l.eval(.5,g.get()),p=r.worldUpAtPosition(c,g.get()),h=r.worldBasisAtPosition(c,Rt.Y,g.get());switch(i){case _.Horizontal:T(e,p);break;case _.Vertical:V(s,p)<V(o,p)?k(e,o,s):k(e,s,o),F(e,e,p),F(e,e,p);break;case _.Direct:{const m=t.orientation??0;if(Re({elevationAlignedStartPoint:n,elevationAlignedEndPoint:a}))Le(le,-Ge(m),p),Ie(e,h,le);else{const S=k(g.get(),o,s),f=F(g.get(),S,p);F(f,f,S),Le(le,Ge(m),S),Ie(e,f,le)}break}}return tt(e,W)?T(e,h):kt(e,e)}const le=De();function Re({elevationAlignedStartPoint:e,elevationAlignedEndPoint:t}){return e!=null&&t!=null&&e.x===t.x&&e.y===t.y}function yt(e,t){const{offsetAxis:i,offset:n,relativeToSegment:{startRenderSpace:a,endRenderSpace:s},relativeToSegment:o,renderCoordsHelper:l}=t,r=n/l.unitInMeters,[c,p]=qi(a,s,i,r);return de(e.startRenderSpace,o.startRenderSpace,i,c),de(e.endRenderSpace,o.endRenderSpace,i,p),e}function qi(e,t,i,n=0){const a=V(t,i),s=V(e,i),o=Math.abs(a-s)+n;return a>s?[o,n]:[n,o]}function ye(e,t,i){const n=t.directSegment.eval(.5,g.get());return i.worldUpAtPosition(n,e)}function ke(e,t){const{startRenderSpace:i,endRenderSpace:n}=t.directSegment;return k(e,n,i)}function Ee(e,t,i={invert:!1}){const{startRenderSpace:n,endRenderSpace:a}=t.dimensionSegment;return i.invert?k(e,n,a):k(e,a,n)}function $e(e,t){const i=e.directSegment.eval(.5,g.get());return t.headingAtPosition(i,e.primaryOffsetAxis)}function Ki(e,t){return Me(Ee(Wi,e))/t**2}const Wi=b();function St(e){const{elevationAlignedStartPoint:t,elevationAlignedEndPoint:i}=e;if(t==null||i==null)return!1;const n=ui(t,i);return n!=null&&pt(n,"meters").value>mt}function ne(e){return e.geometry!=null}let U=class extends Y{constructor(t){super(t)}initialize(){const t=fe(()=>this.analysisViewData.computations,({computation:i})=>this._watchComputation(i));this.addHandles(ae(t))}get analysis(){return this.analysisViewData.analysis}get _defaultUnit(){return ri(this.view)}_watchComputation(t){return v(()=>pe(t),i=>{const{measureType:n}=i;if(St(i)&&n!==_.Direct){const s=Math.round(Vt(mt,"meters","kilometers"));return it.getLogger(this).warnOnce(`A ${n} dimension in the analysis (id: '${this.analysis.id}') will not display, because only direct dimensions can measure lengths greater than ${s} km. Update the measureType of the affected dimension to "direct" to display it.`),void(t.geometry=null)}const a=me(i,this.view.renderCoordsHelper,t.geometry);t.geometry=a,t.result.length=Gi(a,n,this._defaultUnit)},A)}};d([u({constructOnly:!0})],U.prototype,"analysisViewData",void 0),d([u({constructOnly:!0})],U.prototype,"view",void 0),d([u()],U.prototype,"analysis",null),d([u()],U.prototype,"_defaultUnit",null),U=d([G("esri.views.3d.analysis.Dimension.support.DimensionController")],U);function he(e){return Lt(e.accentColor,.5)}function Yi(e){return Gt(e.accentColor)}const Mt=5,Xi=new B([127,127,127,.5]),wt=.8,Zi=4,Ji=6,Qi=.1,Pt=.5,en=18,tn=2,nn=.3,an=2,sn=.25,on=20,rn=5,Ye=5,Xe=10,ln=2500,dn=50,cn=2;class un{constructor(t){this.start=t.start,this.end=t.end,this.offset=t.offset,this.heading=t.heading,this.rotation=t.rotation,this.direct=t.direct,this.horizontal=t.horizontal,this.vertical=t.vertical}manipulatorName(t){return Object.keys(this).find(i=>this.hasOwnProperty(i)&&t===this[i])}values(){return[this.start,this.end,this.offset,this.heading,this.rotation,this.direct,this.horizontal,this.vertical]}forEachMeasureTypeManipulator(t){for(const i of si)t(this.manipulatorForMeasureType(i),i)}manipulatorForMeasureType(t){switch(t){case _.Direct:return this.direct;case _.Horizontal:return this.horizontal;case _.Vertical:return this.vertical}}}class pn extends _e{constructor(t,i){const n=pi(B.toUnitRGBA(he(t.effectiveTheme))),a=[new z(It(n,1,32,32),E)];super({view:t,renderObjects:a,metadata:i.metadata,available:!1,grabCursor:"crosshair",radius:Mt,collisionPriority:1}),this._themeHandle=v(()=>({color:B.toUnitRGBA(he(t.effectiveTheme))}),s=>n.setParameters(s))}destroy(){this._themeHandle.remove(),super.destroy()}}function mn(e,t){const i=[ce(-.5,0,0),ce(.5,0,0)],n=ee(t.unfocusedMaterial,i.map(s=>se(b(),s,Pt))),a=n.instantiate({material:t.focusedMaterial});return new _e({view:e,renderObjects:[new z(n,R.Unfocused|R.Selected|E),new z(a,R.Focused|E)],collisionType:{type:"line",paths:[i]},radius:Ve(t.lineSizePt)/2,metadata:t.metadata,available:!1,...ht})}class Ze extends _e{constructor(t,{lineSizePt:i,material:n,metadata:a}){super({view:t,autoScaleRenderObjects:!1,collisionPriority:1,metadata:a}),this._options={calloutColor:Ut(),lineSizePt:i,material:n},this._themeHandle=v(()=>B.toUnitRGBA(he(t.effectiveTheme)),s=>{this._options.calloutColor=s,Qe(this,Je({...this._options,metadata:this.metadata}))},te)}update({lineSizePt:t,material:i}){this._options.lineSizePt=t,this._options.material=i,Qe(this,Je({...this._options,metadata:this.metadata}))}destroy(){this._themeHandle.remove(),super.destroy()}}function Je({calloutColor:e,lineSizePt:t,material:i,metadata:n}){return{calloutLength:.25*Ft*wt*x(t)+en,calloutColor:e,calloutWidth:tn,customStateMask:E,discScale:nn,focusMultiplier:an,material:i,metadata:n}}function hn(e,t){const i=[ce(-.5,0,0),ce(.5,0,0)],n=ee(t.thinOffsetManipulatorMaterial,i),a=ee(t.unfocusedMaterial,i.map(o=>se(b(),o,Pt))),s=a.instantiate({material:t.focusedMaterial});return new _e({view:e,renderObjects:[new z(a,R.Unfocused|E),new z(s,R.Focused|E),new z(n,E)],collisionType:{type:"line",paths:[i]},radius:Ve(t.lineSizePt)/2,available:!1,metadata:t.metadata,...ht})}function gn(e,{isStart:t,createSnappingPipelineStep:i,dimension:n,onUpdate:a,view:s}){const o=t?"startPoint":"endPoint";return[oe(e,(r,c,p,h)=>{const m=ze(r),{snappingStep:S,cancelSnapping:f}=i(h);p=p.next(m).next(He(n,[o,"measureType","orientation"])).next(f),c.next(m).next(hi(s)).next(...S).next(M=>{const y=J(M.mapEnd,new j);a(o==="startPoint"?{startPoint:y}:{endPoint:y})})})]}function fn(e,{computation:t,view:i}){return[oe(e,(n,a,s)=>{if(!ne(t)||!n.selected)return;const{geometry:o,dimension:l}=t,r=ze(n);a.next(r).next(Ct(i,l,o.dimensionSegment,o.primaryOffsetAxis)),s.next(r).next(He(l,["offset"]))})]}function _n(e,{computation:t,view:i}){return[oe(e,(n,a,s)=>{bt({cancel:s,computation:t,settingHeading:!0,steps:a,view:i})})]}function vn(e,{computation:t,view:i}){return[oe(e,(n,a,s)=>{bt({cancel:s,computation:t,settingHeading:!1,steps:a,view:i})}),e.events.on("immediate-click",n=>{yn(n,t,i)})]}function yn(e,t,i){const{dimension:n,geometry:a}=t;if(n.orientation===90||n.orientation===270)return n.orientation=0,void e.stopPropagation();if(a==null)return;const{renderCoordsHelper:s}=i,o=me({...pe(t),orientation:90},s),l=me({...pe(t),orientation:270},s);if(o==null||l==null)return;const r=$e(o,s),c=$e(l,s),p=Ot(a,i),h=we.shortestSignedDiff(p,r),m=we.shortestSignedDiff(p,c);n.orientation=Math.abs(h)<Math.abs(m)?90:270,e.stopPropagation()}function bt(e){const{cancel:t,computation:i,settingHeading:n,steps:a,view:s}=e;if(!ne(i))return;const{renderCoordsHelper:o}=s,{dimension:l,geometry:r}=i,c=b(),p=Dt(b(),r,r.directSegment,o),h=Tt(g.get(),{forHeading:n,geometry:r,renderCoordsHelper:o}),m=Pe(p,h,be()),S=n?l.orientation??$e(r,s.renderCoordsHelper):l.orientation??0;a.next(gt(s,m)).next(f=>{f.action==="start"&&T(c,f.renderStart);const M=Nt(m),y=mi(c,f.renderEnd,p,M);let L=S-qt(y);n||(L=Sn(L)),l.orientation=L}),t.next(He(l,["orientation"]))}function Sn(e){const t=we.normalize(e)%90;return t<Ye?e-t:90-t<Ye?e+(90-t):e}function Mn(e,{computation:t,manipulatorMeasureType:i,view:n}){let a=_.Direct,s=0,o=0;return[e.events.on("grab-changed",l=>{if(l.action!=="start"||!ne(t))return;const{dimension:r,geometry:c}=t;a=r.measureType,s=r.offset,o=r.orientation;const p=T(g.get(),e.renderLocation);r.measureType=i,r.offset=Bi(p,i,c,n.renderCoordsHelper),r.orientation=0}),oe(e,(l,r,c)=>{if(!ne(t))return;const{geometry:p,dimension:h}=t,{renderCoordsHelper:m}=n,S=_t(At,i,t,m),f=ve(g.get(),{measureType:i,directSegment:p.directSegment,renderCoordsHelper:m}),M=ze(l);r.next(M).next(Ct(n,h,S,f)),c.next(M).next(y=>(h.measureType=a,h.offset=s,h.orientation=o,y))})]}function Ct(e,t,i,n){const a=lt(g.get(),i.endRenderSpace,i.startRenderSpace);F(a,a,n);const s=Pe(i.startRenderSpace,a,be()),o=Pe(i.startRenderSpace,n,be()),l=t.offset;let r,c=0;const p=new gi;return p.next(gt(e,s)).next(h=>{h.action==="start"&&(c=Fe(o,h.renderStart));const m=(Fe(o,h.renderEnd)-c)*e.renderCoordsHelper.unitInMeters;t.offset=l+m,r=h}),h=>(p.execute(h),r)}function Ot(e,t){const{directSegment:i}=e,{renderCoordsHelper:n}=t,a=ye(g.get(),e,n),s=ke(g.get(),e),o=F(g.get(),s,a),{viewForward:l}=t.state.camera;V(o,l)>0&&se(o,o,-1);const r=i.eval(.5,g.get());return n.headingAtPosition(r,o)}function wn(e,t,i){const{dimensionSegment:n,primaryOffsetAxis:a}=t,s=Ee(Q,t),o=at(s,W)?jt(ge):xe(s,a,W,ge),l=Math.max(st(s),Qi/i.unitInMeters);ot(o,o,rt(Q,l,l,l)),e.modelTransform=o,e.renderLocation=n.eval(.5,Q)}function Pn(e,t,i){$t(e,t,i,{forHeading:!0})}function bn(e,t,i){$t(e,t,i,{forHeading:!1})}function $t(e,t,i,{forHeading:n}){const{dimension:a,geometry:s}=t,{primaryOffsetAxis:o}=s,l=se(Cn,o,a.offset>=0?1:-1),r=Tt(On,{forHeading:n,geometry:s,renderCoordsHelper:i});F(r,r,l);const c=xe(l,r,W,ge);e.modelTransform=c,e.renderLocation=Dt(Q,s,s.dimensionSegment,i)}const Cn=b(),On=b();function $n(e,t,i,n){const{geometry:a}=t,s=_t(At,i,t,n),o=ve(Q,{measureType:i,directSegment:a.directSegment,renderCoordsHelper:n}),l=k(Se,s.endRenderSpace,s.startRenderSpace),r=xe(l,o,W,ge),c=st(l);ot(r,r,rt(Se,c,c,c)),e.modelTransform=r,e.renderLocation=s.eval(.5,Se)}function Dt(e,t,i,n){const{startRenderSpace:a,endRenderSpace:s}=i,o=Dn(t,n)?a:s;return T(e,o)}function Tt(e,{forHeading:t,geometry:i,renderCoordsHelper:n}){return t?ye(e,i,n):Ee(e,i,{invert:!0})}function Dn(e,t){const i=ke(Tn,e),n=ye(An,e,t);return V(i,n)>0}const Tn=b(),An=b();function xn(e){return x(e)+Zi}function Ve(e){return x(e)+Ji}function Qe(e,t){var S;const i=t.material??new ft({transparent:!0,writeDepth:!1,textureId:(S=t.texture)==null?void 0:S.id,renderOccluded:P.Opaque,isDecoration:!0}),n=t.focusMultiplier??re.focusMultiplier,a=t.calloutLength??re.calloutLength,s=re.discRadius*(t.discScale??1),o=s*n,l=(f,M)=>{const y=[0,1,2,2,3,0];return new Bt(M,[[je.POSITION,new Be([a-f,-f,0,a+f,-f,0,a+f,f,0,a-f,f,0],y,3,!0)],[je.UV0,new Be([0,0,1,0,1,1,0,1],y,2,!0)]])},r=t.calloutWidth??re.calloutWidth,c=new q({width:r,color:t.calloutColor,renderOccluded:P.OccludeAndTransparent,isDecoration:!0}),p=ee(c,[[0,0,0],[a-s,0,0]]),h=ee(c,[[0,0,0],[a-o,0,0]]),m=t.customStateMask??nt.None;e.collisionType={type:"disc",direction:[0,0,1],offset:[a,0,0]},e.focusMultiplier=n,e.metadata=t.metadata,e.radius=s,e.renderObjects=[new z(l(s,i),R.Unfocused|m),new z(p,R.Unfocused|m),new z(l(o,i),R.Focused|m),new z(h,R.Focused|m)]}const E=nt.Custom1,Q=b(),Se=b(),ge=De(),At=new N;var D;function zn(e,t){return{enabled:t.effectiveFeatureEnabled,elevationAlignedStartPoint:e.elevationAlignedStartPoint,elevationAlignedEndPoint:e.elevationAlignedEndPoint,geometry:e.geometry}}function Hn(e,t){if(St(e))return D.Direct;if(!e.enabled)return null;const{geometry:i}=e;if(i==null||at(i.directSegment.startRenderSpace,i.directSegment.endRenderSpace))return null;const{camera:n}=t.state,a=ye(g.get(),i,t.renderCoordsHelper),s=ke(g.get(),i),o=se(g.get(),a,V(s,a)),l=lt(g.get(),s,o),r=Me(l),c=Me(o),{startRenderSpace:p,endRenderSpace:h}=i.directSegment,m=Math.max(n.computeScreenPixelSizeAt(p)*Xe,n.computeScreenPixelSizeAt(h)*Xe)**2;return r<m?D.Vertical:c<m?D.Horizontal:null}function Rn(e,t,{constraint:i,view:n}){const{unconstrainedGeometry:a}=e;if(a==null)return;const{renderCoordsHelper:s,spatialReference:o}=n,{startRenderSpace:l,endRenderSpace:r}=a.directSegment,c=s.fromRenderCoords(l,new j({spatialReference:o})),p=s.fromRenderCoords(r,new j({spatialReference:o}));let h;h=t==="start"?{startPoint:c}:{endPoint:p},xt(e,h,{constraint:i,elevationAlignedStartPoint:e.elevationAlignedStartPoint,elevationAlignedEndPoint:e.elevationAlignedEndPoint,unconstrainedGeometry:a,view:n})}function xt(e,t,i){const{constraint:n,elevationAlignedStartPoint:a,elevationAlignedEndPoint:s,unconstrainedGeometry:o,view:l}=i,{dimension:r,previousConstraint:c,preConstraintProperties:p}=e;if(a==null||s==null)return;const h=()=>{"startPoint"in t?r.startPoint=t.startPoint:"endPoint"in t&&(r.endPoint=t.endPoint)};if(n==null)h(),c!=null&&p!=null&&(r.measureType=p.measureType,r.orientation=p.orientation);else switch(r.measureType=_.Direct,n){case D.Horizontal:if(n!==c&&(r.orientation=0),"startPoint"in t){const m=t.startPoint;m!=null&&(m.z=s.z),r.startPoint=m}else if("endPoint"in t){const m=t.endPoint;m!=null&&(m.z=a.z),r.endPoint=m}break;case D.Vertical:if(n!==c&&(r.orientation=Ot(o,l)),"startPoint"in t){const m=t.startPoint;m!=null&&(m.x=s.x,m.y=s.y),r.startPoint=m}else if("endPoint"in t){const m=t.endPoint;m!=null&&(m.x=a.x,m.y=a.y),r.endPoint=m}break;case D.Direct:n!==c&&p!=null&&(r.orientation=p.orientation),h()}e.previousConstraint=n,e.unconstrainedGeometry=o}(function(e){e[e.Horizontal=0]="Horizontal",e[e.Vertical=1]="Vertical",e[e.Direct=2]="Direct"})(D||(D={}));let w=class extends Y{constructor(e){super(e),this._stagedDimension=null,this._computationManipulators=new Map,this._computationHandles=new dt,this._orientationManipulatorTexture=null,this._updatingHandles=new Kt,this._getSnappingContext=fi(n=>new Oi({elevationInfo:{mode:"absolute-height",offset:0},pointer:n,editGeometryOperations:new wi(new Pi("point",bi(!0,!1,this.view.spatialReference))),visualizer:new vi}));const{view:t}=e;this._snappingManagerResult=Ci(t),this.addHandles(this._snappingManagerResult),this._unfocusedOffsetManipulatorMaterial=this._createOffsetManipulatorMaterial(),this._focusedOffsetManipulatorMaterial=this._createOffsetManipulatorMaterial(),this._thinOffsetManipulatorMaterial=this._createOffsetManipulatorMaterial(),this._thinOffsetManipulatorMaterial.setParameters({stipplePattern:ue(2)}),this._constraintSnappingIndicator=new I({view:t,attached:!0,width:1,renderOccluded:P.OccludeAndTransparent,stipplePattern:ue(5),isDecoration:!0});const i=B.toUnitRGBA(Xi);this._stagedStartIndicator=new Mi({view:t,attached:!1,elevationInfo:{mode:"absolute-height",offset:0},spatialReference:e.view.renderCoordsHelper.spatialReference,color:i,size:2*Mt,outlineSize:0,renderOccluded:P.OccludeAndTransparent,isDecoration:!0})}initialize(){var n;const{view:e}=this;this._snappingOperation=new Di({view:e});const t=!((n=e._stage)!=null&&n.renderView.renderingContext.driverTest.svgPremultipliesAlpha.result);this._orientationManipulatorMaterial=new ft({transparent:!0,writeDepth:!1,renderOccluded:P.Opaque,isDecoration:!0}),this.addHandles(v(()=>({accentColor:he(e.effectiveTheme),contrastColor:Yi(e.effectiveTheme)}),({accentColor:a,contrastColor:s})=>{const o=this._orientationManipulatorTexture,l=_i(e.textures,{accentColor:a,contrastColor:s,preMultiplyAlpha:t});this._orientationManipulatorMaterial.setParameters({textureId:l.texture.id}),this._orientationManipulatorTexture=l,o==null||o.release();const r=B.toUnitRGBA(a);this._unfocusedOffsetManipulatorMaterial.setParameters({color:r}),this._focusedOffsetManipulatorMaterial.setParameters({color:r}),this._thinOffsetManipulatorMaterial.setParameters({color:r}),this._constraintSnappingIndicator.color=r},te));const i=fe(()=>this.analysisViewData.computations,({computation:a})=>this._createManipulators(a));this.addHandles(ae(i)),this.addHandles([v(()=>({stagedPoint:this._snappingOperation.stagedPoint,stagedComputation:this._stagedComputation}),({stagedPoint:a,stagedComputation:s})=>{if(s==null||a==null)return;const o=J(a,new j);this._applyPointUpdate(s,{endPoint:o})},Ce),v(()=>({stagedDimension:this._stagedDimension,selectedComputation:this.analysisViewData.selectedComputation,firstGrabbedManipulator:this.firstGrabbedManipulator}),(a,s)=>{const{stagedDimension:o,selectedComputation:l,firstGrabbedManipulator:r}=a;if(o===(s==null?void 0:s.stagedDimension)&&r===(s==null?void 0:s.firstGrabbedManipulator)){for(const c of[l,s==null?void 0:s.selectedComputation])if(c!=null){const p=this._computationManipulators.get(c);p!=null&&this._updateManipulators(c,p,a)}}else for(const[c,p]of this._computationManipulators)this._updateManipulators(c,p,a)},A),v(()=>this.analysis.style.lineSize,a=>{this._updateManipulatorStyle(a)},te),v(()=>this.view.state.camera,()=>{this._stagedComputation!=null&&this._updateStagedDimensionOffset(this._stagedComputation)}),v(()=>{const a=this._stagedComputation;if(!a)return null;const s=a.elevationAlignedStartPoint,o=b();return s!=null&&this.view.renderCoordsHelper.toRenderCoords(s,o)?o:null},a=>{a!=null?(this._stagedStartIndicator.vertices=[a],this._stagedStartIndicator.attached=!0):this._stagedStartIndicator.attached=!1})]),this.addHandles(this._constraintHandles),this.addHandles(this._snappingIndicatorHandles),Ti(this,()=>{const a=this._activeComputation,s=this._stagedComputation;if(a==null||s!=null){const o=this.view.inputManager.latestPointerType??"mouse",l=this._getSnappingContext(o);this._updatingHandles.addPromise(Ne(this._snappingOperation.snapAgainNearPreviousMapPoint(this._snappingManager,l)))}if(a!=null){const{start:o,end:l}=this._computationManipulators.get(a);if(o.grabbing||l.grabbing){const r=o.grabbing?"start":"end",c=this._computeConstraint(a);Rn(a,r,{constraint:c,view:this.view})}}})}destroy(){var e;this._snappingOperation=Te(this._snappingOperation),this._computationHandles.destroy(),this._constraintSnappingIndicator.destroy(),this._stagedStartIndicator.destroy(),(e=this._orientationManipulatorTexture)==null||e.release()}get updating(){return this._updatingHandles.updating||this._snappingManager.updating}get firstGrabbedManipulator(){return this.parentTool.firstGrabbedManipulator}get hasGrabbedManipulators(){return this.parentTool.hasGrabbedManipulators}get snappingOptions(){return this._snappingManager.options}get _snappingManager(){return this._snappingManagerResult.snappingManager}get _activeComputation(){if(this._stagedComputation!=null)return this._stagedComputation;const{selectedComputation:e}=this.analysisViewData;return this.hasGrabbedManipulators&&e!=null?e:null}get _stagedComputation(){var i;const e=this._stagedDimension,t=(i=this.analysisViewData.computations.at(-1))==null?void 0:i.computation;return e==null||t==null||t.dimension!==e?null:t}get _constraintHandles(){return[Ae(()=>this.analysisViewData.selectedComputation,e=>{e.previousConstraint=this._computeConstraint(e)},{...A,equals:Oe}),v(()=>{const e=this._activeComputation;if(e==null)return null;const{measureType:t,orientation:i}=e.dimension;return{measureType:t,orientation:i,computation:e}},(e,t)=>{if(e!=null&&t==null){const{measureType:i,orientation:n,computation:a}=e;switch(a.previousConstraint){case D.Horizontal:a.preConstraintProperties={measureType:_.Horizontal,orientation:0};break;case D.Vertical:a.preConstraintProperties={measureType:_.Vertical,orientation:0};break;case D.Direct:a.preConstraintProperties={measureType:_.Direct,orientation:n};break;default:a.preConstraintProperties={measureType:i,orientation:n}}}e==null&&t!=null&&(t.computation.preConstraintProperties=null)},Ce)]}get _snappingIndicatorHandles(){const e="snapping-indicator-event-handles";return[v(()=>({stagedComputation:this._stagedComputation,activeComputation:this._activeComputation}),({stagedComputation:t,activeComputation:i})=>{const n=this._constraintSnappingIndicator;if(this.removeHandles(e),i!=null)if(i===t)n.attached=!0;else{const{start:a,end:s}=this._computationManipulators.get(i),o=()=>{n.attached=a.grabbing||s.grabbing};o(),this.addHandles([a.events.on("grab-changed",o),s.events.on("grab-changed",o)],e)}else n.attached=!1}),v(()=>{const t=this._activeComputation;return t!=null?{geometry:t.geometry,constraint:t.previousConstraint}:{}},({geometry:t,constraint:i})=>{const n=this._constraintSnappingIndicator;t!=null&&i!=null&&i!==D.Direct?(n.visible=!0,n.setGeometryFromSegment(t.directSegment)):n.visible=!1})]}removeStaged(){return this._stagedDimension!=null&&(this.analysis.dimensions.remove(this._stagedDimension),this._stagedDimension=null,!0)}onDeactivate(){this.removeStaged(),this._resetSnappingState()}onClick(e){const{_stagedDimension:t}=this;if(t==null){const i=this._onUnstagedClick(e);return this.analysis.dimensions.add(i),null}return this._onStagedClick(e),t}onPointerMove({mapPoint:e,pointerType:t}){if(t==="touch")return;const i=this._getSnappingContext(t);this._updatingHandles.addPromise(Ne(this._snappingOperation.snap({point:e},this._snappingManager,i)))}onManipulatorSelectionChanged(){this.analysisViewData.selectedComputation!=null&&(this._computationManipulators.get(this.analysisViewData.selectedComputation).offset.selected||(this.analysisViewData.selectedDimension=null))}_onUnstagedClick({mapPoint:e,pointerType:t}){let i=e;if(t==="mouse"){const a=this._getSnappingContext(t);i=this._snappingManager.update({point:e,context:a})}const n=new oi({startPoint:J(i,new j),endPoint:null,measureType:_.Horizontal});return this._stagedDimension=n,this._resetSnappingState(),n}_onStagedClick({mapPoint:e,pointerType:t}){const i=this._stagedComputation;if(i==null)return;let n=e;if(t==="mouse"){const s=this._getSnappingContext(t);n=this._snappingManager.update({point:e,context:s})}const a=J(n,new j);this._applyPointUpdate(i,{endPoint:a}),this._stagedDimension=null,this._resetSnappingState()}_resetSnappingState(){this._snappingManager.doneSnapping(),this._snappingOperation.abort(),this._snappingOperation.stagedPoint=null}_createManipulators(e){const t=this._setupPointManipulator(e,{isStart:!0}),i=this._setupPointManipulator(e,{isStart:!1}),n=this._setupOffsetManipulator(e),a=this._setupHeadingManipulator(e),s=this._setupRotationManipulator(e),o=this._setupMeasureTypeManipulator(e,_.Direct),l=this._setupMeasureTypeManipulator(e,_.Horizontal),r=this._setupMeasureTypeManipulator(e,_.Vertical),c=new un({start:t,end:i,offset:n,heading:a,rotation:s,direct:o,horizontal:l,vertical:r});return this._setupComputationToManipulatorsSync(e,c),this._computationManipulators.set(e,c),this.manipulators.addMany(c.values()),{manipulators:c,remove:()=>{this._computationHandles.remove(e),this._computationManipulators.delete(e);for(const p of c.values())this.manipulators.remove(p)}}}_setupComputationToManipulatorsSync(e,t){this._computationHandles.add([v(()=>e.geometry,()=>this._updateManipulators(e,t),{...A,equals:Oe})],e)}_setupPointManipulator(e,t){const{view:i}=this,{dimension:n}=e,a=new pn(i,{metadata:n}),s=gn(a,{isStart:t.isStart,createSnappingPipelineStep:o=>$i({snappingContext:this._getSnappingContext(o),snappingManager:this._snappingManager,updatingHandles:this._updatingHandles}),dimension:n,onUpdate:o=>this._applyPointUpdate(e,o),view:i});return this._computationHandles.add(s,e),a}_setupOffsetManipulator(e){const{view:t}=this,i=mn(t,{lineSizePt:this.analysis.style.lineSize,unfocusedMaterial:this._unfocusedOffsetManipulatorMaterial,focusedMaterial:this._focusedOffsetManipulatorMaterial,metadata:e.dimension}),n=fn(i,{computation:e,view:t});return this._computationHandles.add(n,e),i}_setupHeadingManipulator(e){const{view:t}=this,i=new Ze(t,{lineSizePt:this.analysis.style.lineSize,material:this._orientationManipulatorMaterial,metadata:e.dimension}),n=_n(i,{computation:e,view:t});return this._computationHandles.add(n,e),i}_setupRotationManipulator(e){const{view:t}=this,i=new Ze(t,{lineSizePt:this.analysis.style.lineSize,material:this._orientationManipulatorMaterial,metadata:e.dimension}),n=vn(i,{computation:e,view:t});return this._computationHandles.add(n,e),i}_setupMeasureTypeManipulator(e,t){const{view:i}=this,n=hn(i,{lineSizePt:this.analysis.style.lineSize,unfocusedMaterial:this._unfocusedOffsetManipulatorMaterial,focusedMaterial:this._focusedOffsetManipulatorMaterial,thinOffsetManipulatorMaterial:this._thinOffsetManipulatorMaterial,metadata:e.dimension}),a=Mn(n,{computation:e,manipulatorMeasureType:t,view:i});return this._computationHandles.add(a,e),n}_updateManipulators(e,t,i={stagedDimension:this._stagedDimension,selectedComputation:this.analysisViewData.selectedComputation,firstGrabbedManipulator:this.firstGrabbedManipulator}){const{stagedDimension:n,selectedComputation:a,firstGrabbedManipulator:s}=i,{start:o,end:l,offset:r,heading:c,rotation:p}=t,h=a===e,m=ne(e),{dimension:S}=e;for(const y of t.values()){const L=m&&n==null&&(s==null||y===s);y===r?(y.available=L,y.selected=h):y.available=L&&h}if(!m)return;this._computeConstraint(e)!=null?t.forEachMeasureTypeManipulator(y=>y.available=!1):t.manipulatorForMeasureType(S.measureType).available=!1;for(const y of[c,p])S.measureType===_.Direct&&S.offset!==0||(y.available=!1);Re(e)?p.available=!1:c.available=!1;const{geometry:f}=e;o.renderLocation=f.directSegment.startRenderSpace,l.renderLocation=f.directSegment.endRenderSpace;const{renderCoordsHelper:M}=this.view;wn(r,f,M),c.available&&Pn(c,e,M),p.available&&bn(p,e,M),t.forEachMeasureTypeManipulator((y,L)=>{y.available&&$n(y,e,L,M)})}_updateManipulatorStyle(e){const t=xn(e),i=Ve(e),n={lineSizePt:e,material:this._orientationManipulatorMaterial};for(const{offset:a,heading:s,rotation:o}of this._computationManipulators.values())a.radius=i/2,s.update(n),o.update(n);this._unfocusedOffsetManipulatorMaterial.setParameters({width:t}),this._focusedOffsetManipulatorMaterial.setParameters({width:i})}_applyPointUpdate(e,t){const{view:i}=this,n=pe(e);"startPoint"in t&&(n.elevationAlignedStartPoint=t.startPoint),"endPoint"in t&&(n.elevationAlignedEndPoint=t.endPoint);const a=me(n,i.renderCoordsHelper);if(a==null)return;const s=this._computeConstraint({...n,geometry:a});xt(e,t,{...n,constraint:s,unconstrainedGeometry:a,view:i}),e===this._stagedComputation&&this._updateStagedDimensionOffset(e)}_updateStagedDimensionOffset(e){if(e.geometry==null)return;e.geometry.directSegment.eval(.5,et);const t=this.view.state.camera.computeScreenPixelSizeAt(et);e.dimension.offset=dn*t}_computeConstraint(e){return Hn(zn(e,this._snappingManager.options),this.view)}_createOffsetManipulatorMaterial(){return new q({width:1,renderOccluded:P.OccludeAndTransparent,writeDepth:!1,hasPolygonOffset:!0,isDecoration:!0})}get testInfo(){const e=t=>{var i;return(i=this.analysisViewData.computations.find(({computation:n})=>n.dimension===t))==null?void 0:i.computation};return{disableManipulatorPartialOcclusion:()=>{this._stagedStartIndicator.renderOccluded=P.Occlude,this.manipulators.forEach(({manipulator:t})=>{for(const{geometry:i}of t.renderObjects)i.material.setParameters({renderOccluded:P.Occlude})})},getManipulatorsForDimension:t=>this._computationManipulators.get(e(t)),getComputationForDimension:t=>e(t),getConstraintForDimension:t=>{const i=e(t);return i!=null?this._computeConstraint(i):null},stagedDimension:this._stagedDimension,stagedStartIndicator:this._stagedStartIndicator,constraintSnappingIndicator:this._constraintSnappingIndicator,snappingManager:this._snappingManager}}};d([u({constructOnly:!0})],w.prototype,"analysis",void 0),d([u({constructOnly:!0})],w.prototype,"analysisViewData",void 0),d([u({constructOnly:!0})],w.prototype,"manipulators",void 0),d([u({constructOnly:!0})],w.prototype,"parentTool",void 0),d([u({constructOnly:!0,nonNullable:!0})],w.prototype,"view",void 0),d([u({readOnly:!0})],w.prototype,"updating",null),d([u()],w.prototype,"firstGrabbedManipulator",null),d([u()],w.prototype,"hasGrabbedManipulators",null),d([u()],w.prototype,"snappingOptions",null),d([u()],w.prototype,"_stagedDimension",void 0),d([u()],w.prototype,"_activeComputation",null),d([u()],w.prototype,"_stagedComputation",null),w=d([G("esri.views.3d.analysis.Dimension.LengthDimensionSubTool")],w);const et=b();var K;(function(e){e.Ready="ready",e.Creating="creating",e.Created="created"})(K||(K={}));let O=class extends Ai{constructor(e){super(e),this.automaticManipulatorSelection=!1,this.removeIncompleteOnCancel=!1,this._pointerMoveTimerMs=ln,this._prevPointerMoveTimeout=null}initialize(){this._intersector=xi(this.view.state.viewingMode),this._lengthDimensionSubTool=new w({analysis:this.analysis,analysisViewData:this.analysisViewData,manipulators:this.manipulators,parentTool:this,view:this.view}),this.addHandles([ae(this._lengthDimensionSubTool),ct(()=>this._clearPointerMoveTimeout()),v(()=>this.state,e=>{e===K.Created&&this.finishToolCreation()},A),Ae(()=>this.firstGrabbedManipulator,e=>{this.selectedDimension=e.metadata},A),v(()=>this.selectedDimension,()=>this._resetPointerMoveTimeout(),A)])}get state(){return this.analysis.dimensions.some(e=>e.type==="length")?this._activeSubTool!=null?K.Creating:K.Created:K.Ready}get updating(){return this._lengthDimensionSubTool.updating}get cursor(){return this.active?"crosshair":null}get selectedDimension(){return this.analysisViewData.selectedDimension}set selectedDimension(e){this.analysisViewData.selectedDimension=e}onInputEvent(e){switch(e.type){case"immediate-click":this._clickHandler(e);break;case"immediate-double-click":this._doubleClickHandler(e);break;case"pointer-move":this._pointerMoveHandler(e);break;case"key-down":if(Ke.cancel===e.key){if(this._activeSubTool!=null&&this._activeSubTool.removeStaged())return void e.stopPropagation();this.active||(this.selectedDimension=null)}else Ke.delete.includes(e.key)&&this._deleteKeyHandler()}}onActivate(){this._activeSubTool=this._lengthDimensionSubTool}onDeactivate(){this._activeSubTool!=null&&(this._activeSubTool.onDeactivate(),this._activeSubTool=null)}onShow(){this._resetPointerMoveTimeout()}onManipulatorSelectionChanged(){this._lengthDimensionSubTool.onManipulatorSelectionChanged()}onHide(){this.selectedDimension=null}_clickHandler(e){if(this.hasFocusedManipulators)return void e.stopPropagation();if(this._activeSubTool==null)return;const t=this._intersectScreen(e);t!=null&&(this.selectedDimension=this._activeSubTool.onClick({mapPoint:t,pointerType:e.pointerType}),e.stopPropagation())}_doubleClickHandler(e){this.active&&(this.view.activeTool=null,e.stopPropagation())}_pointerMoveHandler(e){if(this._resetPointerMoveTimeout(),this._activeSubTool==null||this.hasFocusedManipulators)return;const t=this._intersectScreen(e);t!=null&&this._activeSubTool.onPointerMove({mapPoint:t,pointerType:e.pointerType})}_deleteKeyHandler(){this._activeSubTool!=null&&this._activeSubTool.removeStaged(),this._removeSelected()}_intersectScreen(e){const t=Wt(e);this.view.sceneIntersectionHelper.intersectToolIntersectorScreen(t,this._intersector);const i=this._intersector.results.min,n=g.get();return i.getIntersectionPoint(n)?this.view.renderCoordsHelper.fromRenderCoords(n,new j({spatialReference:this.view.spatialReference})):null}_removeSelected(){this.selectedDimension!=null&&(this.analysis.dimensions.remove(this.selectedDimension),this.selectedDimension=null)}_clearPointerMoveTimeout(){this._prevPointerMoveTimeout=Yt(this._prevPointerMoveTimeout)}_resetPointerMoveTimeout(){this._clearPointerMoveTimeout(),this.manipulators.forEach(e=>e.manipulator.state|=E),this._prevPointerMoveTimeout=Xt.setTimeout(()=>{this.manipulators.forEach(e=>e.manipulator.state&=~E)},this._pointerMoveTimerMs)}get testInfo(){return{...this._lengthDimensionSubTool.testInfo,setManipulatorAutoHideDelay:e=>{this._pointerMoveTimerMs=e,this._resetPointerMoveTimeout()}}}};d([u({constructOnly:!0})],O.prototype,"view",void 0),d([u({constructOnly:!0})],O.prototype,"analysis",void 0),d([u({readOnly:!0})],O.prototype,"state",null),d([u({readOnly:!0})],O.prototype,"updating",null),d([u({readOnly:!0})],O.prototype,"cursor",null),d([u({constructOnly:!0})],O.prototype,"analysisViewData",void 0),d([u()],O.prototype,"selectedDimension",null),d([u()],O.prototype,"automaticManipulatorSelection",void 0),d([u()],O.prototype,"_activeSubTool",void 0),d([u()],O.prototype,"_lengthDimensionSubTool",void 0),O=d([G("esri.views.3d.analysis.Dimension.DimensionTool")],O);class kn extends ki{constructor(t,i){super(t),this._hasExternalMaterial=!1,this._renderOccluded=P.OccludeAndTransparent,this._width=1,this._color=Hi(1,0,1,1),this._placement="end",this._markerPrimitive="arrow",this._material=i,this._hasExternalMaterial=i!=null,this.applyProperties(t)}setGeometryFromSegment(t,i){const n=t.endRenderSpace;this.transform=Zt(En,n),this._normal=i;const{points:a}=t.createRenderGeometry(n,this.view.renderCoordsHelper);this.geometry=[a]}get renderOccluded(){return this._material!=null?this._material.parameters.renderOccluded:this._renderOccluded}set renderOccluded(t){this._renderOccluded=t,this._material!=null&&this._material.setParameters({renderOccluded:t})}get geometry(){return this._geometry}set geometry(t){this._geometry=t,this.recreateGeometry()}get normal(){return this._normal}set normal(t){this._normal=t,this.recreateGeometry()}get width(){return this._material!=null?this._material.parameters.width:this._width}set width(t){this._width=t,this._material!=null&&this._material.setParameters({width:t})}get color(){return this._material!=null?this._material.parameters.color:this._color}set color(t){this._color=Ri(t),this._material!=null&&this._material.setParameters({color:this._color})}get placement(){return this._material!=null?this._material.parameters.placement:this._placement}set placement(t){this._placement=t,this._material!=null&&this._material.setParameters({placement:this._placement})}get markerPrimitive(){var t;return((t=this._material)==null?void 0:t.parameters.markerPrimitive)??this._markerPrimitive}set markerPrimitive(t){this._markerPrimitive=t,this._material!=null&&this._material.setParameters({markerPrimitive:t})}createExternalResources(){this._hasExternalMaterial||(this._material=new ut({width:this._width,color:this._color,placement:this._placement,renderOccluded:this._renderOccluded,markerPrimitive:this._markerPrimitive,isDecoration:this.isDecoration}))}destroyExternalResources(){this._hasExternalMaterial||(this._material=null)}createGeometries(t){for(const i of Jt(this.geometry,this.normal)){const n=Qt(this._material,i);t.addGeometry(n)}}forEachExternalMaterial(t){this._hasExternalMaterial||t(this._material)}}const En=De();class Vn{set visible(t){for(const i of this._visualElements.values())i.attached=t}constructor(t){this.destroyed=!1,this._handles=new dt,this._messages=null,this._labelSegment=new N;const{analysis:i,computation:n,view:a,messages:s,isDecoration:o}=t;this.analysis=i,this.computation=n,this.view=a,this._messages=s;const l=t.visible,r={view:a,attached:l,isDecoration:o},{fontSize:c,textColor:p,textBackgroundColor:h}=i.style;this._visualElements=new Un({marker:new kn(r,t.markerMaterial),dimension:new I(r,t.dimensionLineMaterial),startOffset:new I(r,t.offsetLineMaterial),endOffset:new I(r,t.offsetLineMaterial),dimensionSmall:new I(r,t.smallDimensionLineMaterial),startOffsetSmall:new I(r,t.smallOffsetLineMaterial),endOffsetSmall:new I(r,t.smallOffsetLineMaterial),label:new li({view:a,attached:l,distance:0,geometry:{type:"segment",sampleLocation:"center",segment:this._labelSegment,callout:!1},fontSize:x(c),textColor:p.clone(),backgroundColor:h.clone(),isDecoration:o})}),this._handles.add([v(()=>n.geometry,m=>{this.updateCameraDependentElements(a.state.camera,m,i.style),n.geometry!=null&&this._updateLines(n.geometry)},{...te,equals:Oe}),v(()=>n.length,m=>this._updateLabelContent(m),te)])}destroy(){this.destroyed=!0,this._handles=Te(this._handles);for(const t of this._visualElements.values())t.destroy()}get testInfo(){return{dimensionVisualElement:this._visualElements.dimension,label:this._visualElements.label}}_updateLines(t){const i=We(Ln,ie.Start,t.directSegment,t.dimensionSegment),n=We(Gn,ie.End,t.directSegment,t.dimensionSegment),a=this._visualElements;a.marker.setGeometryFromSegment(t.dimensionSegment,t.primaryOffsetAxis),a.dimension.setGeometryFromSegment(t.dimensionSegment),a.startOffset.setGeometryFromSegment(i),a.endOffset.setGeometryFromSegment(n),a.dimensionSmall.setGeometryFromSegment(t.dimensionSegment),a.startOffsetSmall.setGeometryFromSegment(i),a.endOffsetSmall.setGeometryFromSegment(n)}updateCameraDependentElements(t,i,n){const a=this._visualElements;if(i==null){for(const M of a.values())M.visible=!1;return}const s=t.computeScreenPixelSizeAt(i.dimensionSegment.eval(.5,In)),o=Ki(i,s),l=o<(x(n.lineSize)*cn)**2,r=!l;a.marker.visible=r,a.dimension.visible=r,a.startOffset.visible=r,a.endOffset.visible=r,a.dimensionSmall.visible=l,a.startOffsetSmall.visible=l,a.endOffsetSmall.visible=l;const c=x(n.fontSize)*rn,{label:p}=a;if(p.visible=o>=c**2,!p.visible)return;const{dimensionSegment:h,primaryOffsetAxis:m}=i,{offset:S}=this.computation.dimension,f=(Math.sign(S)>=0?1:-1)*this._labelOffsetPx(n)*s;Ii(this._labelSegment,h,m,f),p.updateLabelPosition()}updateLabelStyle(t){const{label:i}=this._visualElements;i.fontSize=x(t.fontSize),i.textColor=t.textColor,i.backgroundColor=t.textBackgroundColor}updateUnitsMessages(t){this._messages=t;const{length:i}=this.computation;this._updateLabelContent(i)}_updateLabelContent(t){const{label:i}=this._visualElements;t!=null&&this._messages!=null?i.text=zi(this._messages,t,t.unit):i.text=""}_labelOffsetPx(t){return 1.5*x(t.fontSize)+on+x(t.lineSize/2)}}const Ln=new N,Gn=new N,In=b();class Un{constructor(t){this.marker=t.marker,this.dimension=t.dimension,this.startOffset=t.startOffset,this.endOffset=t.endOffset,this.dimensionSmall=t.dimensionSmall,this.startOffsetSmall=t.startOffsetSmall,this.endOffsetSmall=t.endOffsetSmall,this.label=t.label}values(){return[this.marker,this.dimension,this.startOffset,this.endOffset,this.dimensionSmall,this.startOffsetSmall,this.endOffsetSmall,this.label]}}let H=class extends Y{get analysis(){return this.analysisViewData.analysis}get visible(){return this.analysisViewData.visible}constructor(e){super(e),this.loadingMessages=!1,this._messages=null}initialize(){const e=this.isDecoration;this._markerMaterial=new ut({width:1,anchor:ei.Tip,color:X,placement:"begin-end",worldSpace:!0,hideOnShortSegments:!0,hasTip:!0,renderOccluded:P.OccludeAndTransparent,markerPrimitive:"triangle",isDecoration:e}),this._dimensionLineMaterial=new q({width:1,color:X,renderOccluded:P.OccludeAndTransparent,markerParameters:this._markerMaterial.parameters,isDecoration:e}),this._offsetLineMaterial=new q({width:1,color:X,renderOccluded:P.OccludeAndTransparent,stipplePattern:ue(5),isDecoration:e}),this._smallDimensionLineMaterial=new q({width:1,color:X,renderOccluded:P.OccludeAndTransparent,isDecoration:e}),this._smallOffsetLineMaterial=new q({width:1,color:X,renderOccluded:P.OccludeAndTransparent,stipplePattern:ue(5),isDecoration:e});for(const i of this._lineMaterials())this.view._stage.add(i),this.addHandles(ct(()=>{var n;(n=this.view._stage)==null||n.remove(i)}));const t=fe(()=>this.analysisViewData.computations,({computation:i})=>this._createVisualization(i));this._dimensionVisualizations=t,this.addHandles([ae(t),v(()=>B.toUnitRGBA(this.analysis.style.color),i=>{for(const n of this._lineMaterials())n.setParameters({color:i})},A),v(()=>this.analysis.style.lineSize,i=>{const n=x(i);this._markerMaterial.setParameters({width:n*wt}),this._dimensionLineMaterial.setParameters({width:n,markerParameters:this._markerMaterial.parameters});const a=Math.max(n*sn,1);this._offsetLineMaterial.setParameters({width:a})},A),v(()=>({camera:this.view.state.camera,style:Fn(this.analysis)}),({camera:i,style:n})=>{for(const{visualization:a}of this._dimensionVisualizations)a.updateCameraDependentElements(i,a.computation.geometry,n),a.updateLabelStyle(n)}),v(()=>this.visible,i=>{for(const{visualization:n}of this._dimensionVisualizations)n.visible=i})]),this.addHandles([ti(()=>this._updateMessageBundle()),Ae(()=>!this.loadingMessages,()=>{for(const{visualization:i}of this._dimensionVisualizations)i.updateUnitsMessages(this._messages)},Ce)]),this._updateMessageBundle()}get testInfo(){return{visualizations:this._dimensionVisualizations.items.map(({visualization:e})=>e),disablePartialOcclusion:()=>{for(const e of this._lineMaterials())e.setParameters({renderOccluded:P.Occlude})}}}_createVisualization(e){const t=new Vn({analysis:this.analysis,computation:e,view:this.view,visible:this.visible,markerMaterial:this._markerMaterial,dimensionLineMaterial:this._dimensionLineMaterial,offsetLineMaterial:this._offsetLineMaterial,smallDimensionLineMaterial:this._smallDimensionLineMaterial,smallOffsetLineMaterial:this._smallOffsetLineMaterial,messages:this._messages,isDecoration:this.isDecoration});return{visualization:t,remove:()=>t.destroy()}}_lineMaterials(){return[this._markerMaterial,this._dimensionLineMaterial,this._offsetLineMaterial,this._smallDimensionLineMaterial,this._smallOffsetLineMaterial]}async _updateMessageBundle(){this.loadingMessages=!0;try{this._messages=await ii("esri/core/t9n/Units")}finally{this.loadingMessages=!1}}};function Fn(e){const{fontSize:t,lineSize:i,textColor:n,textBackgroundColor:a}=e.style;return{fontSize:t,lineSize:i,textBackgroundColor:a.clone(),textColor:n.clone()}}d([u({constructOnly:!0})],H.prototype,"analysisViewData",void 0),d([u({constructOnly:!0,nonNullable:!0})],H.prototype,"view",void 0),d([u({constructOnly:!0})],H.prototype,"isDecoration",void 0),d([u()],H.prototype,"analysis",null),d([u()],H.prototype,"visible",null),d([u()],H.prototype,"loadingMessages",void 0),H=d([G("esri.views.3d.analysis.Dimension.DimensionVisualization")],H);let Z=class extends Y{constructor(e){super(e),this.dimension=null,this.length=null}};d([u({constructOnly:!0,nonNullable:!0})],Z.prototype,"dimension",void 0),d([u()],Z.prototype,"length",void 0),Z=d([G("esri.views.3d.analysis.LengthDimensionResult")],Z);const jn=Z;let $=class extends Y{constructor(e){super(e),this.geometry=null,this.unconstrainedGeometry=null,this.elevationAlignedStartPoint=null,this.elevationAlignedEndPoint=null}normalizeCtorArgs(e){const{dimension:t,...i}=e;return{result:new jn({dimension:t}),...i}}initialize(){this.addHandles([v(()=>this.dimension.startPoint,e=>this.elevationAlignedStartPoint=this.projectAndAlignPoint(e),A),v(()=>this.dimension.endPoint,e=>this.elevationAlignedEndPoint=this.projectAndAlignPoint(e),A)])}get dimension(){return this.result.dimension}get length(){return this.result.length}};d([u({constructOnly:!0,nonNullable:!0})],$.prototype,"result",void 0),d([u({constructOnly:!0,nonNullable:!0})],$.prototype,"projectAndAlignPoint",void 0),d([u()],$.prototype,"dimension",null),d([u()],$.prototype,"length",null),d([u()],$.prototype,"geometry",void 0),d([u()],$.prototype,"unconstrainedGeometry",void 0),d([u()],$.prototype,"elevationAlignedStartPoint",void 0),d([u()],$.prototype,"elevationAlignedEndPoint",void 0),d([u()],$.prototype,"preConstraintProperties",void 0),d([u()],$.prototype,"previousConstraint",void 0),$=d([G("esri.views.3d.analysis.LengthDimensionComputation")],$);const Bn=e=>{let t=class extends e{constructor(...i){super(...i),this.analysis=null,this.tool=null,this.selectedDimension=null,this.interactive=!1,this.visible=null}get results(){return new ni}createLengthDimensions(i){throw new Error("Method not implemented.")}};return d([u({constructOnly:!0})],t.prototype,"view",void 0),d([u({constructOnly:!0,nonNullable:!0})],t.prototype,"analysis",void 0),d([u()],t.prototype,"tool",void 0),d([u({readOnly:!0})],t.prototype,"results",null),d([u()],t.prototype,"selectedDimension",void 0),d([u()],t.prototype,"interactive",void 0),d([u()],t.prototype,"visible",void 0),t=d([G("esri.views.analysis.DimensionAnalysisView")],t),t};let C=class extends Bn(ai(Y)){constructor(e){super(e),this.type="dimension-view-3d",this.tool=null,this.selectedDimension=null,this._dimensionsToComputations=new Map,this._placementTask=null,this._projectAndAlignPoint=null}initialize(){this._projectAndAlignPoint=t=>{if(t==null)return null;const{spatialReference:i,elevationProvider:n}=this.view,a=yi(t,i,n);return a==null&&Si(this.analysis,t.spatialReference,it.getLogger(this)),a};const e=fe(()=>this.analysis.dimensions,t=>this._createComputation(t));this.computations=e,this.addHandles([Ei(this,O),ae(e)]),this._analysisVisualization=new H({analysisViewData:this,view:this.view,isDecoration:!this.parent}),this._analysisController=new U({analysisViewData:this,view:this.view})}destroy(){this._placementTask=qe(this._placementTask),this._analysisVisualization=Te(this._analysisVisualization),Vi(this)}get updating(){var e;return((e=this._analysisVisualization)==null?void 0:e.loadingMessages)??!1}get results(){return this.analysis.dimensions.map(e=>this._dimensionsToComputations.get(e).result)}get selectedComputation(){const{selectedDimension:e}=this;return e==null?null:this._dimensionsToComputations.get(e)}get testInfo(){return{visualization:this._analysisVisualization,controller:this._analysisController}}async createLengthDimensions(e){return this.selectedDimension=null,this._placementTask=qe(this._placementTask),this._placementTask=Li(this,e),this._placementTask.promise}_createComputation(e){const{_dimensionsToComputations:t}=this,i=new $({dimension:e,projectAndAlignPoint:this._projectAndAlignPoint});return t.set(e,i),{computation:i,remove:()=>this._removeComputation(i)}}_removeComputation(e){const{dimension:t}=e;t===this.selectedDimension&&(this.selectedDimension=null),this._dimensionsToComputations.delete(t),e.destroy()}};d([u({readOnly:!0})],C.prototype,"type",void 0),d([u()],C.prototype,"tool",void 0),d([u()],C.prototype,"updating",null),d([u({readOnly:!0})],C.prototype,"results",null),d([u()],C.prototype,"computations",void 0),d([u()],C.prototype,"selectedDimension",void 0),d([u()],C.prototype,"selectedComputation",null),d([u()],C.prototype,"_analysisVisualization",void 0),d([u()],C.prototype,"_analysisController",void 0),d([u()],C.prototype,"_dimensionsToComputations",void 0),d([u()],C.prototype,"_placementTask",void 0),C=d([G("esri.views.3d.analysis.DimensionAnalysisView3D")],C);const Ua=C;export{Ua as default};
