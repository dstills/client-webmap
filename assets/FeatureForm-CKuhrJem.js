function __vite__mapDeps(indexes) {
  if (!__vite__mapDeps.viteFileDeps) {
    __vite__mapDeps.viteFileDeps = ["assets/index-BS4ejk0L.js","assets/index-DvE0Cji0.css","assets/calcite-button-BEiwyGvk.js","assets/button-CTlumxno.js","assets/calcite-combobox-CXXlFLP6.js","assets/combobox-BY5gvlAi.js","assets/filter-C2cemdNK.js","assets/utils2-DMbAlmau.js","assets/core-Bizuf87v.js","assets/Validation-Pfa6caJE.js","assets/chip-BpprsELZ.js","assets/combobox-item-C4Xn7Gan.js","assets/input-message-CuciggWc.js","assets/calcite-combobox-item-BesItn9b.js","assets/calcite-combobox-item-group-D87srIwh.js","assets/calcite-icon-BkHotFMP.js","assets/calcite-input-QgysYMCD.js","assets/input2-CDCfA0lA.js","assets/input-kBVpmtEZ.js","assets/progress-B2N2lbwf.js","assets/calcite-input-date-picker-DWn4WYL3.js","assets/input-text-BYseP8Rn.js","assets/calcite-input-message-C1DV76vZ.js","assets/calcite-input-number-CYtM_EwB.js","assets/input-number-wewWyIvH.js","assets/calcite-input-time-picker-N84mbiCR.js","assets/math-BEjMmqe5.js","assets/calcite-input-time-zone-Y6IdxQPT.js","assets/calcite-label-CumKmLeQ.js","assets/calcite-list-DBGYLCXn.js","assets/utils3-C4KfsP4-.js","assets/calcite-list-item-CwXGdoVL.js","assets/calcite-loader-MUF21uuE.js","assets/calcite-notice-C1QyOSTw.js","assets/calcite-radio-button-DQEp-7Eh.js","assets/calcite-radio-button-group-3_gtbEcw.js","assets/calcite-switch-CtAlbgd2.js","assets/calcite-text-area-ckJFZTv3.js","assets/throttle-Q3rBAhpL.js"]
  }
  return indexes.map((i) => __vite__mapDeps.viteFileDeps[i])
}
import{E as l,F as u,J as O,O as H,ig as Se,aD as Ne,aB as Z,z as te,A as ce,hw as je,hx as Ge,xW as fe,D as $e,aE as Pe,bE as Ue,e7 as ie,bs as ye,b9 as He,bt as L,lm as z,aT as q,P as Ze,cM as Le,bb as _e,a$ as Be,cL as We,c6 as qe,M as ge,xX as ze,hl as ve,q8 as Ke,q9 as Je,cy as be,nc as Ye,j0 as Q,nL as Qe,j1 as Xe,w as et,j2 as tt,_ as w,j3 as _,nF as Ce,pZ as it,p_ as nt,b$ as ne,xY as st,cz as ot,cA as at,xZ as Fe,x_ as X,x$ as se,y0 as oe,y1 as Ve,y2 as rt,y3 as lt}from"./index-BS4ejk0L.js";import{d as U,A as ut,_ as he,O as dt,c as W,j as pt,T as ae,b as ct,x as xe,f as Y,L as we,k as ht,y as re,v as Ee,S as mt,M as ft,U as yt}from"./featureFormUtils-DsXg5bmB.js";import{r as _t,l as gt,q as Ie}from"./FieldInput-VhZeY3W_.js";import{createArcadeProfile as vt,createArcadeExecutor as bt}from"./arcade-C3EXu1Ns.js";import{F as Ct}from"./FeatureRelationshipViewModel-BjNiMh-f.js";import{J as Ft}from"./featureUtils-CGogJx99.js";const T="esri-feature-form",le=`${T}__group`,S=`${T}__input`,ue=`${T}__related-records`,C={base:T,form:`${T}__form`,formHeader:`${T}__form-header`,label:`${T}__label`,labelTextContent:`${T}__label-text-content`,fieldInput:`${S}`,inputRadio:`${S}--radio`,inputRadioGroup:`${S}--radio-group`,inputRadioLabel:`${S}--radio-label`,inputDisabled:`${S}--disabled`,inputSwitch:`${S}--switch`,inputInvalid:`${S}--invalid`,centeredButton:`${T}__centered-button`,description:`${T}__description-text`,listObserver:`${T}__list-observer`,relatedRecordsHeader:`${ue}_header`,relatedRecordsLabel:`${ue}_label`,relatedRecordsList:`${ue}_list`,dateInputContainer:`${`${T}__date`}-input-container`,group:le,groupSequential:`${le}--sequential`,groupActive:`${le}--active`};let j=class extends H{constructor(t){super(t),this.maxValue=null,this.minValue=null,this.codedValue=null}};l([u()],j.prototype,"objectType",void 0),l([u()],j.prototype,"maxValue",void 0),l([u()],j.prototype,"minValue",void 0),l([u()],j.prototype,"codedValue",void 0),j=l([O("esri.layers.support.ContingentValue")],j);const E=j;let G=class extends H{constructor(t){super(t),this.isRetired=!1}};l([u()],G.prototype,"id",void 0),l([u()],G.prototype,"isRetired",void 0),l([u()],G.prototype,"subtype",void 0),l([u()],G.prototype,"values",void 0),G=l([O("esri.layers.support.Contingency")],G);const Re=G;let K=class extends H{constructor(t){super(t)}};l([u()],K.prototype,"fieldGroup",void 0),l([u()],K.prototype,"type",void 0),K=l([O("esri.layers.support.ContingencyConstraintViolation")],K);const Te=K;let J=class extends H{constructor(e){super(e)}};l([u()],J.prototype,"contingentValuesAllGroups",void 0),l([u()],J.prototype,"contingentValuesByFieldGroup",void 0),J=l([O("esri.layers.support.ContingentValuesResult")],J);const Vt=J;let P=class extends H{constructor(e){super(e),this.fields=null,this.isEditingRestrictive=!1}};l([u()],P.prototype,"name",void 0),l([u()],P.prototype,"fields",void 0),l([u()],P.prototype,"isEditingRestrictive",void 0),l([u()],P.prototype,"contingencies",void 0),P=l([O("esri.layers.support.FieldGroup")],P);const me=P;var M;let k=M=class extends Se(Ne){constructor(e){super(e),this.request=Z,this.fieldGroups=null,this.fieldGroupDefinitions=null}initialize(){}get subtypeFieldName(){const{layer:e}=this;return e.type==="subtype-group"?e.subtypeField:e.typeIdField}static async createLoadedLayerContingentValuesCache(e){await e.load();const t=e.sourceJSON;if(e.layerId===void 0)return null;const i=t.hasContingentValuesDefinition;if(i)return new M({layer:e}).load();if(i===void 0){const n=te(e.url);if(n==null)return null;const s=n.url.path;if((await M._staticFetchEnterpriseFeatureRoot(s)).supportsQueryDataElements){const o=e.layerId.toString(),a=await M._staticFetchEnterpriseFieldGroup(s,o);if(a){const r=a.map(d=>({name:d.name,isEditingRestrictive:d.isEditingRestrictive,fields:d.fieldNames.names.map(h=>e.fieldsIndex.normalizeFieldName(h))}));return new M({layer:e,fieldGroupDefinitions:r}).load()}}}return null}async load(e){const t=this.layer.load(e).then(()=>this._initializeContingentValues(this.fieldGroupDefinitions,e));return this.addResolvingPromise(t),this}validateContingencyConstraints(e,t){const i=Object.keys(e),n=[],s=[];for(const o of this.fieldGroups){const a=o.isEditingRestrictive?"error":"warning";if(t&&!o.fields.some(p=>t.includes(p)))continue;if(!o.fields.every(p=>i.includes(p))){s.push(new Te({fieldGroup:o,type:a}));continue}let r=!1;const d=e[this.subtypeFieldName],h=o.contingencies.filter(p=>!(!p.isRetired&&p.subtype)||p.subtype.code===d);for(const p of h){let c=!0;for(const m in p.values){const f=p.values[m];if(f.objectType!=="any"){if(f.objectType==="null"){if(e[m]!=null){c=!1;break}}else if(f.objectType==="code"){if(e[m]!==f.codedValue.code){c=!1;break}}else if(f.objectType==="range"){const y=e[m];if(y<f.minValue||y>f.maxValue){c=!1;break}}}}if(c){r=!0;break}}r||n.push(new Te({fieldGroup:o,type:a}))}return{invalid:n,incomplete:s}}getContingentValues(e,t,i=!1){const n=e[this.subtypeFieldName],s=n!=null,o={};let a=[];const r=this.fieldGroups.filter(d=>d.fields.includes(t));a.push(new E({objectType:"any"}));for(const d of r){let h=[];const p=d.contingencies.filter(f=>!(f.isRetired||f.subtype&&s&&f.subtype.code!==n));let c=!1;const m={};for(const f of p){let y,b=!0;for(const g in f.values){const x=f.values[g];if(t!==g){if(e[g]!==void 0&&x.objectType!=="any"){if(x.objectType==="null")e[g]!==null&&(b=!1);else if(x.objectType==="code")e[g]!==x.codedValue.code&&(b=!1);else if(x.objectType==="range"){const R=e[g];(R<x.minValue||R>x.maxValue)&&(b=!1)}}}else y=x,c=c||x.objectType==="range"}if(y&&b){if(y.objectType==="any"){h.length=0,h.push(y);break}const g=this._generateKey(y);m[g]||h.push(y),m[g]=!0}}c&&(h=this._joinRange(h)),o[d.name]=h,a=i?this._filterIntersection(a,h):[]}return r.length===1&&i&&(a=[]),new Vt({contingentValuesAllGroups:a,contingentValuesByFieldGroup:o})}_generateKey(e){switch(e.objectType){case"any":return"@any@";case"null":return"@null@";case"code":return e.codedValue.name+e.codedValue.code.toString();case"range":return e.minValue.toString()+"-"+e.maxValue.toString()}}_joinRange(e){let t,i;e.sort((s,o)=>s.objectType==="null"?-1:o.objectType==="null"?1:s.minValue-o.minValue);const n=[];for(const s of e)s.objectType!=="null"?t!=null&&i!=null?i<s.minValue?(n.push(new E({objectType:"range",minValue:t,maxValue:i})),t=s.minValue,i=s.maxValue):i<s.maxValue&&(i=s.maxValue):(t=s.minValue,i=s.maxValue):n.push(s);return n.push(new E({objectType:"range",minValue:t,maxValue:i})),n}_filterIntersection(e,t){var s,o;if(e.length===0||t.length===0)return[];if(e[0].objectType==="any")return t;if(t[0].objectType==="any")return e;const i=e[0].objectType==="range"||((s=e[1])==null?void 0:s.objectType)==="range",n=t[0].objectType==="range"||((o=t[1])==null?void 0:o.objectType)==="range";return i||n?this._intersectRanges(e,t):this._intersectValues(e,t)}_intersectRanges(e,t){const i=[];let n,s=0;for(const o of e)for(;s<t.length;s++){const a=t[s];if(o.objectType==="null"&&a.objectType==="null")i.push(new E({objectType:"null"}));else{if(o.objectType==="null")break;if(a.objectType==="null")continue}if(o.maxValue<a.minValue)break;if(o.maxValue===a.minValue){i.push(new E({objectType:"range",minValue:o.maxValue,maxValue:a.minValue}));break}if(!(o.minValue>a.maxValue))if(o.minValue!==a.maxValue){if(n=o.minValue>a.minValue?o.minValue:a.minValue,o.maxValue<a.maxValue){i.push(new E({objectType:"range",minValue:n,maxValue:o.maxValue}));break}i.push(new E({objectType:"range",minValue:n,maxValue:a.maxValue}))}else i.push(new E({objectType:"range",minValue:o.minValue,maxValue:a.maxValue}))}return i}_intersectValues(e,t){const i=[];for(const n of e)t.some(s=>{if(n.objectType===s.objectType)switch(n.objectType){case"any":case"null":return!0;case"code":return n.codedValue.code===s.codedValue.code&&n.codedValue.name===s.codedValue.name}return!1})&&i.push(n);return i}static async _staticFetchEnterpriseFeatureRoot(e,t){return Z(e,{responseType:"json",query:{f:"json"},...t}).then(i=>i.data)}static async _staticFetchEnterpriseFieldGroup(e,t,i){return Z(`${e}/queryDataElements`,{responseType:"json",query:{layers:JSON.stringify([t]),f:"json"},...i}).then(n=>{var s;return((s=n.data.layerDataElements)==null?void 0:s[0].dataElement.fieldGroups)??[]})}async _initializeContingentValues(e,t){const i=e??await this._fetchFieldGroupDefs(t);if(i.length===0)return void(this.fieldGroups=[]);const n=await this._fetchContingentValues(i,t);this.fieldGroups=n}async _fetchFieldGroupDefs(e){if(this.layer.layerId===void 0)return[];const t=this.layer.sourceJSON,i=this.layer.layerId.toString(),n=te(this.layer.url).url.path;return t.hasContingentValuesDefinition?(await this._fetchAGOLFieldGroup(n,i,e)).map(s=>({name:s.name,isEditingRestrictive:s.restrictive,fields:s.fields.map(o=>this.layer.fieldsIndex.normalizeFieldName(o))})):t.hasContingentValuesDefinition!==void 0?[]:this._fetchEnterpriseFeatureRoot(n,e).then(async s=>s.supportsQueryDataElements?(await this._fetchEnterpriseFieldGroup(n,i,e)).map(o=>({name:o.name,isEditingRestrictive:o.isEditingRestrictive,fields:o.fieldNames.names.map(a=>this.layer.fieldsIndex.normalizeFieldName(a))})):[])}async _fetchAGOLFieldGroup(e,t,i){return Z(`${e}/${t}/fieldgroups`,{responseType:"json",query:{f:"json"},...i}).then(n=>n.data.fieldGroups??[])}async _fetchEnterpriseFieldGroup(e,t,i){return M._staticFetchEnterpriseFieldGroup(e,t,i)}async _fetchEnterpriseFeatureRoot(e,t){return M._staticFetchEnterpriseFeatureRoot(e,t)}async _fetchContingentValues(e,t){if(this.layer.layerId===void 0)return[];const i=this.layer.sourceJSON,n=this.layer.layerId.toString(),s=te(this.layer.url).url.path;if(i.hasContingentValuesDefinition){const a=await this._fetchAGOLContingentValues(s,n,t);return this._constructFieldGroupsAGOL(e,a)}const o=await this._fetchEnterpriseContingentValues(s,n,t);return this._constructFieldGroupsEnterprise(e,o)}_constructFieldGroupsAGOL(e,t){return e.map(i=>{const n=t.contingentValuesDefinition.fieldGroups.find(s=>s.name===i.name);if(n){let s=[];return s=t.contingentValuesDefinition.hasSubType?this._parseAGOLFieldGroupSubtype(i,t,n.subTypes):this._parseAGOLFieldGroup(i,t,n.contingentValues),new me({name:i.name,isEditingRestrictive:i.isEditingRestrictive,fields:i.fields,contingencies:s})}return null}).filter(ce)}_parseAGOLFieldGroupSubtype(e,t,i){let n=[];return i==null||i.forEach(s=>{const o=this._getSubtypeAGOL(s.name);n=n.concat(this._parseAGOLFieldGroup(e,t,s.contingentValues,o))}),n}_parseAGOLFieldGroup(e,t,i,n=null){const s=[];for(const o of i??[]){const a=this._parseAGOLContingency(o,e,t,n);s.push(a)}return s}_parseAGOLContingency(e,t,i,n){const s=e.id,o=!!e.retired&&e.retired===1,a={};for(let r=0,d=0;r<t.fields.length;r++){const h=t.fields[r],p=i.typeCodes[e.types[r]];if(p==="Code"){let c=e.values[d];d++;const m=this._getDomain(n,h),f=this.layer.getField(h);if((f==null?void 0:f.type)==="string"){const g=i.stringDicts.find(x=>x.domain===(m==null?void 0:m.name));g&&(c=g.entries[c])}const y=m==null?void 0:m.codedValues.find(g=>g.code===c),b=new E({codedValue:y,objectType:"code"});a[h]=b}else if(p==="Range"){const c=e.values[d];d++;const m=c.range[0],f=c.range[1],y=new E({minValue:m,maxValue:f,objectType:"range"});a[h]=y}else if(p==="Any"){const c=new E({objectType:"any"});a[h]=c}else{const c=new E({objectType:"null"});a[h]=c}}return new Re({id:s,isRetired:o,subtype:n,values:a})}_constructFieldGroupsEnterprise(e,t){const i=t.fieldGroups;return e.map(n=>{const s=i.find(o=>o.name===n.name);if(s){const o=s.contingencies.map(a=>{const r=a.id,d=a.isRetired||!1,h=this._getSubtypeEnterprise(a.subtypeCode),p={};for(let c=0;c<n.fields.length;c++){const m=n.fields[c];let f=a.values[c];if(typeof f=="number"||typeof f=="string"){const y=this._getDomain(h,m),b=this.layer.getField(m);je(b)?f=t.stringDictionary[f]:Ge(b)&&(f=new Date(`${f}+00:00`).getTime());const g=y==null?void 0:y.codedValues.find(R=>R.code===f),x=new E({codedValue:g,objectType:"code"});p[m]=x}else if(typeof f=="object"){const y=f.minValue,b=f.maxValue,g=new E({minValue:y,maxValue:b,objectType:"range"});p[m]=g}else if(f){const y=new E({objectType:"any"});p[m]=y}else{const y=new E({objectType:"null"});p[m]=y}}return new Re({id:r,isRetired:d,subtype:h,values:p})});return new me({name:n.name,isEditingRestrictive:n.isEditingRestrictive,fields:n.fields,contingencies:o})}return null}).filter(ce)}async _fetchEnterpriseContingentValues(e,t,i){return Z(`${e}/queryContingentValues`,{responseType:"json",query:{layers:JSON.stringify([t]),f:"json"},...i}).then(n=>{var s;return(s=n.data.contingentValueSets)==null?void 0:s[0]})}async _fetchAGOLContingentValues(e,t,i){return Z(`${e}/${t}/contingentValues`,{responseType:"json",query:{f:"json"},...i}).then(n=>n.data)}_getSubtypeEnterprise(e){const t=this.layer.sourceJSON;let i;if(t.subtypes){const n=t.subtypes.find(s=>s.code===e);i=fe.fromJSON(n)}return i||null}_getSubtypeAGOL(e){const t=this.layer.sourceJSON;let i;if(t.subtypes){const n=t.subtypes.find(s=>s.name===e);i=fe.fromJSON(n)}return i||null}_findDomainByFieldName(e,t){const i=e.domains;if(i){const[n,s]=Object.entries(i).find(([o])=>o.trim().toLowerCase()===t.trim().toLowerCase())||[];return s||null}return null}_getDomain(e,t){const i=e?this._findDomainByFieldName(e,t):this.layer.getFieldDomain(t);return(i==null?void 0:i.type)==="inherited"?this.layer.getFieldDomain(t):i}};l([u({constructOnly:!0})],k.prototype,"layer",void 0),l([u({constructOnly:!0})],k.prototype,"request",void 0),l([u({type:[me]})],k.prototype,"fieldGroups",void 0),l([u({constructOnly:!0})],k.prototype,"fieldGroupDefinitions",void 0),l([u()],k.prototype,"subtypeFieldName",null),k=M=l([O("esri.layers.support.LayerContingentValuesCache")],k);const xt=k;var Me;const wt=Symbol("FormExpressionArcadeExecutor");let I=class extends H{constructor(t){super(t),this[Me]=!0,this._lastEvaluatedValue=null,this._abortController=new AbortController,this._stale=!1,this._updatingTracking=new $e,this._executeAsyncDebounced=Pe(async(i,n,s)=>{const o=await this.executor.executeAsync(i,{...n,abortSignal:s});return s.aborted?this._lastEvaluatedValue:(this._lastEvaluatedValue=o,this._stale=!1,o)})}get isAsync(){return this.executor.isAsync}get fieldsUsed(){return this.executor.fieldsUsed}get syntaxTree(){return this.executor.syntaxTree}get updating(){return this._updatingTracking.updating}get stale(){return this._stale}get geometryUsed(){return this.executor.geometryUsed}get variablesUsed(){return this.executor.variablesUsed}get lastEvaluatedValue(){return this._lastEvaluatedValue}abort(){this._abortController.abort()}execute(t,i){this._abortController=new AbortController;const n=this.executor.execute(t,{...i,abortSignal:this._abortController.signal});return this._lastEvaluatedValue=n,n}async executeAsync(t,i){return this._abortController=new AbortController,this._updatingTracking.addPromise(this._executeAsyncDebounced(t,i??{},this._abortController.signal))}markStale(){this._stale=!0}reset(){this.abort(),this._lastEvaluatedValue=null,this._stale=!1}};Me=wt,l([u()],I.prototype,"_lastEvaluatedValue",void 0),l([u()],I.prototype,"_stale",void 0),l([u()],I.prototype,"_updatingTracking",void 0),l([u({constructOnly:!0})],I.prototype,"executor",void 0),l([u()],I.prototype,"isAsync",null),l([u()],I.prototype,"fieldsUsed",null),l([u()],I.prototype,"syntaxTree",null),l([u()],I.prototype,"updating",null),l([u()],I.prototype,"stale",null),l([u()],I.prototype,"geometryUsed",null),l([u()],I.prototype,"variablesUsed",null),l([u()],I.prototype,"lastEvaluatedValue",null),I=l([O("esri.widgets.FeatureForm.FormExpressionArcadeExecutor")],I);const Et=async(e,t)=>{const i=vt("form-calculation"),n=await bt(e,i,{});return t!=null&&t.fieldsIndex&&(n.fieldsUsed=Ue(t.fieldsIndex,n.fieldsUsed)),new I({executor:n})},de="#JSAPI_FORM_EXPRESSIONS_MANAGER_GEOMETRY",It="esri.widgets.FeatureForm.FormExpressionsManager";let A=class extends H{constructor(e){super(e),this._fieldReferencesLookup=new Map,this._fieldsAffectedLookup=new Map,this.preserveFieldValuesWhenHidden=!0,this._latestFieldValues={...e.feature.attributes}}initialize(){this._dependencyGraph=this._buildDependencyGraph()}destroy(){this.resetExecutors()}get _asyncExecutors(){return this.executors.filter(e=>e.isAsync)}get _baseContext(){const{editType:e,layer:t,map:i,originalFeature:n,spatialReference:s,timeZone:o}=this.arcadeContextInfo,a=(t==null?void 0:t.type)==="scene"&&t.associatedLayer!=null?t.associatedLayer:t;return[{$originalfeature:n,$editcontext:{editType:e},$layer:a,$featureset:a,$datastore:t==null?void 0:t.url,$map:i},{rawOutput:!0,spatialReference:s??void 0,timeZone:o}]}set feature(e){this._latestFieldValues={...e==null?void 0:e.attributes},this._set("feature",e)}evaluateAll(){return this._evaluate(this.executors)}evaluateAsyncExpressions(){return this._evaluate(this._asyncExecutors)}evaluateExpressions(e){return this._evaluate(e)}evaluateInvalidated(e){const{_fieldReferencesLookup:t,_latestFieldValues:i,feature:n}=this,s=new Set;for(const o of e)if(i[o]=n.getAttribute(o),t.has(o))for(const a of t.get(o))s.add(a);return this._evaluate([...s])}async evaluateInvalidatedByGeometry(){if(this._fieldReferencesLookup.has(de))return this._evaluate([...this._fieldReferencesLookup.get(de)])}resetExecutors(){for(const e of this.executors)e.reset()}_buildDependencyGraph(){var r;const{_fieldReferencesLookup:e,_fieldsAffectedLookup:t,executors:i,preserveFieldValuesWhenHidden:n}=this,s=new Map(this.fieldInputs.map(d=>[d.name,d])),o=n===!1,a=new Map(i.map(d=>[d,new Array]));for(const d of i){for(const h of d.fieldsUsed){ie(e,h,()=>new Set).add(d);const p=s.get(h);[p==null?void 0:p.valueExpressionExecutor,p==null?void 0:p.editableExpressionExecutor,o?(r=p==null?void 0:p.group)==null?void 0:r.visibilityExpressionExecutor:null,o?p==null?void 0:p.visibilityExpressionExecutor:null].filter(c=>c!=null&&c!==d).forEach(c=>{a.get(c).push(d),ie(t,c,()=>new Set).add(p)})}d.geometryUsed&&ie(e,de,()=>new Set).add(d)}return a}async _evaluate(e){const t=new Map,{_dependencyGraph:i,_fieldsAffectedLookup:n,_latestFieldValues:s}=this;for(const a of e)ke(a,t,i);for(const[a,{resolver:r,dependencyPromises:d}]of t)Promise.all(d).then(async()=>{const[h,p]=this._makeContext(s);return a.executeAsync(h,p)}).then(()=>{if(n.has(a))for(const h of n.get(a))this._latestFieldValues[h.name]=h.value;r.resolve()},h=>{!h||ye(h)||Oe(h)||a.markStale(),r.reject(h)});const o=(await Promise.allSettled(Array.from(t.values(),({resolver:a})=>a.promise))).filter(a=>a.status==="rejected"&&!(ye(a.reason)||Oe(a.reason)));if(o.length>0)throw new AggregateError(o,"One or more expression executions failed")}_makeContext(e){const[t,i]=this._baseContext,n=this.feature.clone();return n.attributes=e,[{...t,$feature:n},i]}get test(){return{baseContext:this._baseContext}}};l([u()],A.prototype,"_asyncExecutors",null),l([u()],A.prototype,"_baseContext",null),l([u()],A.prototype,"feature",null),l([u({constructOnly:!0})],A.prototype,"preserveFieldValuesWhenHidden",void 0),l([u()],A.prototype,"executors",void 0),l([u()],A.prototype,"fieldInputs",void 0),l([u()],A.prototype,"arcadeContextInfo",void 0),A=l([O(It)],A);const ke=(e,t,i)=>{if(t.has(e))return;const n=He();t.set(e,{resolver:n,dependencyPromises:[]}),e.abort();const s=i.get(e);for(const o of s)ke(o,t,i),t.get(o).dependencyPromises.push(n.promise)},Oe=e=>e&&typeof e=="object"&&"message"in e&&e.message==="Cancelled";let $=class extends _t{constructor(e){super(e),this._expressionTrackingHandles=new Map,this.type="group"}initialize(){this.addHandles([L(()=>[this.visible,this.inputs],([e])=>{const{inputs:t}=this,i=!!e&&void 0;for(const n of t)U(n)&&(n.required=i)},{initial:!0,equals:(e,t)=>t[0]===e[0]&&t[1]===e[1]})])}destroy(){for(const e of this._expressionTrackingHandles.values())e.remove()}get initialState(){return this.element.initialState||"expanded"}get inputs(){return this._get("inputs")}set inputs(e){this.removeAllHandles(),e&&this.addHandles(e.map(t=>L(()=>t.visible,()=>this._dirtyEvaluatedVisibilityExpression()))),this._set("inputs",e)}get label(){return this.element.label}set label(e){const{element:t}=this;t&&(t.label=e)}get open(){return this.initialState==="expanded"}set open(e){this._override("open",e)}get state(){return z(q.getLogger(this),"state",{replacement:"open",version:"4.28",warnOnce:!0}),this.open?"expanded":"collapsed"}set state(e){z(q.getLogger(this),"state",{replacement:"open",version:"4.28",warnOnce:!0}),this.open=e==="expanded"}get visible(){return this.evaluatedVisibilityExpression!==!1&&this.inputs&&this.inputs.some(e=>e.visible)}_dirtyEvaluatedVisibilityExpression(){const{element:e}=this;e.visibilityExpression&&this.notifyChange("evaluatedVisibilityExpression")}};l([u()],$.prototype,"initialState",null),l([u()],$.prototype,"inputs",null),l([u()],$.prototype,"label",null),l([u()],$.prototype,"open",null),l([u()],$.prototype,"type",void 0),l([u()],$.prototype,"visible",null),$=l([O("esri.widgets.FeatureForm.GroupInput")],$);const Rt=$,Tt=3;let F=class extends gt{constructor(e){super(e),this._relationshipVM=null,this.group=null,this.type="relationship",this.addHandles([L(()=>({feature:this.feature,element:this.element,layer:this.layer}),t=>this._createRelationshipVM(t),Ze),Le(()=>this.relatedLayer,"edits",()=>{var t;return(t=this._relationshipVM)==null?void 0:t.refresh()})])}destroy(){var e;(e=this._relationshipVM)==null||e.destroy()}get canAddRelatedFeature(){const{editable:e,featureCount:t,relationship:i}=this;if(!i||!this.loaded||!this.relatedLayerAllowsAdds)return!1;const{cardinality:n,role:s}=i;return!(n==="one-to-one"&&t>0)&&n!=="many-to-many"&&!(n==="one-to-many"&&s==="destination"&&t>0)&&e}get displayCount(){return this.element.displayCount??Tt}get displayType(){return this.element.displayType}get editable(){return!!this.relatedLayerAllowsEdits&&(this.evaluatedEditableExpression??!0)}get featureCount(){var e;return((e=this._relationshipVM)==null?void 0:e.featureCount)??0}get loaded(){var e;return((e=this._relationshipVM)==null?void 0:e.state)!=="loading"}get map(){return this._get("map")}set map(e){var t;e&&((t=this._relationshipVM)==null||t.set("map",e)),this._set("map",e)}get orderByFields(){return this.element.orderByFields}get originHasValidKey(){return!(!this.relationship||!this.feature.getAttribute(this.relationship.keyField))}get relationship(){var e;return(e=this._relationshipVM)==null?void 0:e.relationship}get relationshipId(){return this.element.relationshipId}get relatedFeatureInfos(){var a;const{_relationshipVM:e,timeZone:t}=this;if(!((a=e==null?void 0:e.relatedFeatures)!=null&&a.length)||!(e!=null&&e.relatedLayer))return[];const{itemDescriptionFieldName:i,relatedFeatures:n,relatedLayer:s}=e,o=s&&"formTemplate"in s&&s.formTemplate?s.formTemplate.title:void 0;return n.map(r=>{let d;if(i){const h=r.getAttribute(i),p=s.fieldsIndex.get(i);if(p){const c=ut({values:[h],fields:[p],timeZone:t??void 0})[i];c!=null&&(d=c.toString())}}return{feature:r,description:d,title:o?he({label:o,attributes:r.attributes,fieldsIndex:s.fieldsIndex,timeZone:t}):void 0}}).toArray()}get relatedLayer(){var e;return(e=this._relationshipVM)==null?void 0:e.relatedLayer}get relatedLayerIsTable(){var e;return!!((e=this.relatedLayer)!=null&&e.isTable)}get relatedLayerAllowsAdds(){var i;const{relatedLayer:e}=this;if(!e||!this.relatedLayerAllowsEdits)return!1;const t=_e(e);return!!((i=t==null?void 0:t.operations)!=null&&i.supportsAdd)}get relatedLayerAllowsEdits(){var i;const{relatedLayer:e}=this;if(!e)return!1;const t=_e(e);return!!((i=t==null?void 0:t.operations)!=null&&i.supportsEditing)}get showAllEnabled(){return this._get("showAllEnabled")}set showAllEnabled(e){var t;(t=this._relationshipVM)==null||t.set("showAllEnabled",e),this._set("showAllEnabled",e)}get showAllActionVisible(){return!this.showAllEnabled&&this.featureCount>0&&this.featureCount>this.displayCount}get visible(){const{relationship:e}=this;if(!e)return!1;const{cardinality:t}=e;return t!=="many-to-many"&&(this.evaluatedVisibilityExpression!=null?this.evaluatedVisibilityExpression:this.element!=null)}get updating(){var e,t;return((e=this._relationshipVM)==null?void 0:e.state)==="loading"||((t=this._relationshipVM)==null?void 0:t.state)==="querying"}incrementPage(){this._relationshipVM&&this._relationshipVM.featurePage++}getRelatedFeatureByObjectId(e){var t;return(t=this._relationshipVM)==null?void 0:t.getRelatedFeatureByObjectId(e)}_createRelationshipVM(e){var h;const{feature:t,element:i,layer:n}=e;if((h=this._relationshipVM)==null||h.destroy(),!t||!i||!n)return;const{displayCount:s,map:o,orderByFields:a,relationshipId:r,showAllEnabled:d}=this;Ft(n)&&(this._relationshipVM=new Ct({graphic:t,displayCount:s,layer:n,map:o,orderByFields:a,relationshipId:r,showAllEnabled:d}))}};l([u()],F.prototype,"_relationshipVM",void 0),l([u()],F.prototype,"canAddRelatedFeature",null),l([u()],F.prototype,"displayCount",null),l([u()],F.prototype,"displayType",null),l([u()],F.prototype,"editable",null),l([u()],F.prototype,"featureCount",null),l([u()],F.prototype,"group",void 0),l([u()],F.prototype,"loaded",null),l([u()],F.prototype,"map",null),l([u()],F.prototype,"orderByFields",null),l([u()],F.prototype,"originHasValidKey",null),l([u()],F.prototype,"relationship",null),l([u()],F.prototype,"relationshipId",null),l([u()],F.prototype,"relatedFeatureInfos",null),l([u()],F.prototype,"relatedLayer",null),l([u()],F.prototype,"relatedLayerIsTable",null),l([u()],F.prototype,"relatedLayerAllowsAdds",null),l([u()],F.prototype,"relatedLayerAllowsEdits",null),l([u()],F.prototype,"showAllEnabled",null),l([u()],F.prototype,"showAllActionVisible",null),l([u({readOnly:!0})],F.prototype,"type",void 0),l([u()],F.prototype,"visible",null),l([u()],F.prototype,"updating",null),F=l([O("esri.widgets.FeatureForm.RelationshipInput")],F);const Ot=F,pe=new Be({attributes:{}}),At=["editableExpression","requiredExpression","valueExpression","visibilityExpression"],$t=["visibilityExpression"],Lt=["editableExpression","visibilityExpression"],Mt="#JSAPI_CONTINGENT_VALUE_EMPTY_HASH",B="#JSAPI_CONTINGENT_VALUE_ANY_HASH",kt="#JSAPI_CONTINGENT_VALUE_NULL_HASH",De="esri.widgets.FeatureForm.FeatureFormViewModel",ee=()=>q.getLogger(De);let v=class extends We(qe.EventedAccessor){constructor(e){super(e),this._expressionExecutorsInUse=new Set,this._expressionExecutorLookup=new Map,this._expressionsManager=null,this._contingentValuesCache=null,this._featureClone=pe.clone(),this._initialFeature=pe.clone(),this._timeZone=null,this._updatingHandles=new $e,this.arcadeEditType="NA",this.contingencyConstraintViolations=new Map,this.disabled=!1,this.highlightHelper=null,this.inputs=[],this.map=null,this.relatedRecordCallbacks=null,this.strict=!1}initialize(){const e=L(()=>{var n;return[this.layer,!!((n=this.layer)!=null&&n.loaded),this.formTemplate,this.feature,this.timeZone,this.arcadeEditType]},async([n,s])=>{n!=null&&(s?this._updatingHandles.addPromise(this._updateInputs()):n.load().catch(()=>{}))},{equals:([n,s,o,a,r,d],[h,p,c,m,f,y])=>n===h&&s===p&&o===c&&a===m&&r===f&&d===y,initial:!0}),t=L(()=>this._arcadeContextInfo,n=>{this._expressionsManager!=null&&(this._expressionsManager.arcadeContextInfo=n,this._updatingHandles.addPromise(this._expressionsManager.evaluateAll().finally(()=>this._afterExpressionsEvaluated())))}),i=L(()=>this.layer,n=>{const s=(n==null?void 0:n.type)==="subtype-sublayer"?n.parent:(n==null?void 0:n.type)==="feature"?n:null;s&&this.addResolvingPromise(xt.createLoadedLayerContingentValuesCache(s).then(o=>{this._contingentValuesCache=o,this.notifyChange("fieldsWithContingentValues")}))},{initial:!0});this.addHandles([e,t,i])}destroy(){var e;this.feature=null,this.layer=null,this._contingentValuesCache=ge(this._contingentValuesCache),(e=this.highlightHelper)==null||e.removeAll(),this._updatingHandles.destroy()}get _expressionInfosLookup(){var e,t;return new Map((t=(e=this.formTemplate)==null?void 0:e.expressionInfos)==null?void 0:t.map(i=>[i.name,i]))}get activeRelationshipInput(){return this.allRelationshipInputs.find(e=>e.relationshipId===this.relationshipId)}get _arcadeContextInfo(){const{_initialFeature:e,arcadeEditType:t,layer:i,map:n,spatialReference:s,timeZone:o}=this;return{layer:ze(i)?i:null,originalFeature:e,editType:t,map:n,spatialReference:s,timeZone:o}}get allFieldInputs(){return dt(this.inputs)}get allGroupInputs(){return this.inputs.filter(W)}get allRelationshipInputs(){return pt(this.inputs)}get _layerFieldsByName(){var e;return new Map((e=this.layer)==null?void 0:e.fields.map(t=>[t.name,t]))}get feature(){return this._get("feature")}set feature(e){this._featureClone=e?e.clone():pe.clone(),this._initialFeature=this._featureClone.clone(),this._expressionsManager&&(this._expressionsManager.feature=this._featureClone),e?(this._resetFieldInputValues(this._featureClone),this.allRelationshipInputs.forEach(t=>t.feature=e)):(this.inputs.forEach(t=>t.destroy()),this.inputs.length=0),this.contingencyConstraintViolations.clear(),this._set("feature",e)}get fieldsWithContingentValues(){if(this._contingentValuesCache==null)return new Set;const e=this._contingentValuesCache.fieldGroups.flatMap(t=>t.fields);return new Set(e)}get fieldsWithInvalidCodedValue(){const e=this.allFieldInputs;return new Set(e.filter(t=>{const{name:i,domain:n,value:s}=t;if((n==null?void 0:n.type)==="coded-value"){const o=this.getFieldValueOptionsForField(i);return s!=null&&s!==""&&!o.flat().some(a=>a.value===s)}return!1}))}get formTemplate(){return this.layer&&"formTemplate"in this.layer?this.layer.formTemplate:null}set formTemplate(e){e===void 0?this._clearOverride("formTemplate"):this._override("formTemplate",e)}get formDescription(){const{formTemplate:e,layer:t}=this;return e!=null&&e.description&&t?he({label:e.description,attributes:this.getValues(),fieldsIndex:t.fieldsIndex,timeZone:this.timeZone}):null}get formTitle(){const{formTemplate:e,layer:t}=this;return e!=null&&e.title&&t?he({label:e.title,attributes:this.getValues(),fieldsIndex:t.fieldsIndex,timeZone:this.timeZone}):null}get formHeaderVisible(){const{activeRelationshipInput:e,formDescription:t,formTitle:i}=this;return!(e||!t&&!i)}get joinedContingentValues(){return this._joinContingentValues()}get layer(){var e;return(e=this.feature)!=null&&e.sourceLayer&&"applyEdits"in this.feature.sourceLayer?this.feature.sourceLayer:null}set layer(e){this._override("layer",e)}get relationshipId(){return this._get("relationshipId")}set relationshipId(e){const t=this.allRelationshipInputs;if(e!=null&&e===this.relationshipId||t.forEach(i=>i.showAllEnabled=!1),e!=null){const i=t.find(n=>n.relationshipId===e);i&&(i.showAllEnabled=!0)}this._set("relationshipId",e)}get spatialReference(){var e;return((e=this.layer)==null?void 0:e.spatialReference)??null}set spatialReference(e){this._override("spatialReference",e)}get state(){var e;return(e=this.layer)!=null&&e.loaded?"ready":"disabled"}get submittable(){return!!this.valid||this.allFieldInputs.filter(e=>!e.valid).every(({submittable:e})=>e)}get timeZone(){const{layer:e}=this;if(e&&"datesInUnknownTimezone"in e&&e.datesInUnknownTimezone)return ve;const t=e&&"preferredTimeZone"in e&&e.preferredTimeZone;return this._timeZone===Ke?t||ve:this._timeZone||Je}set timeZone(e){this._timeZone=e}get updating(){return this._updatingHandles.updating}get valid(){const e=this.allFieldInputs;return e.length>0&&e.every(({valid:t})=>t)}get view(){return z(ee(),"view",{replacement:"FeatureForm.map",version:"4.27"}),this._get("view")}set view(e){z(ee(),"view",{replacement:"FeatureForm.map",version:"4.27"}),this._set("view",e),e!=null&&e.map&&(this.map=e.map)}findField(e){return this.allFieldInputs.find(t=>t.name===e)}getFieldValueOptionsForField(e,t){var o;const i=this.findField(e);if(!i)return[[],[]];const n=((o=i.domain)==null?void 0:o.type)==="coded-value"?i.domain.codedValues.map(({name:a,code:r})=>({name:a,value:r})):[],s=this.fieldsWithContingentValues.has(e)?this._getContingentValueOptionsForField(e,t):[];if(s.length>0){const a=new Set(s.map(r=>r.value));return[s,n.filter(r=>!a.has(r.value))]}return[n,[]]}getValue(e){const{_featureClone:t,layer:i}=this,n=!!(i!=null&&i.getField(e));return t.getAttribute(e)??(n?null:void 0)}setValue(e,t){const{_featureClone:i,strict:n}=this,s=this.findField(e);t=t===""?null:t,s&&i.getAttribute(e)!==t&&(s.value=t,n&&!s.valid||(this._afterValueChange(s),this._expressionsManager!=null&&this._updatingHandles.addPromise(this._expressionsManager.evaluateInvalidated([s.name]).finally(()=>this._afterExpressionsEvaluated()))))}getValues(){return{...this._featureClone.attributes}}overrideInitialFeature(e){this._initialFeature=e}submit(){const e=this.allFieldInputs,t=new Set(e.filter(s=>s.valid).map(({name:s})=>s)),i=e.filter(s=>!s.valid).map(({name:s})=>s),n=this.getValues();if(this.validateContingencyConstraints(n,{includeIncompleteViolations:!0}).length>0)for(const[s,o]of this.contingencyConstraintViolations.entries())o.type==="error"&&(t.delete(s),i.push(s));this.emit("submit",{valid:[...t],invalid:i,values:n})}validateContingencyConstraints(e,t){const{_contingentValuesCache:i}=this,n=new Map;if(this.contingencyConstraintViolations=n,i==null)return[];const{invalid:s,incomplete:o}=i.validateContingencyConstraints(e),a=[...s,...t!=null&&t.includeIncompleteViolations?o:[]];for(const r of a)for(const d of r.fieldGroup.fields)n.set(d,r);return a}notifyFeatureGeometryChanged(){const{_expressionsManager:e,feature:t,_featureClone:i}=this;i.geometry=t.geometry,e!=null&&this._updatingHandles.addPromise(e.evaluateInvalidatedByGeometry().finally(()=>this._afterExpressionsEvaluated()))}_emitChangeEvent({name:e,valid:t,value:i}){this.emit("value-change",{layer:this.layer,feature:this.feature,fieldName:e,value:i,valid:t})}async _updateInputs(){this._stopExpressions();const{_featureClone:e,_initialFeature:t,arcadeEditType:i,formTemplate:n,inputs:s,layer:o,timeZone:a}=this;if(!o)return;const r={arcadeEditType:i,feature:e,initialFeature:t,layer:o,timeZone:a},d=s.slice(),h=n!=null&&n.elements&&n.elements.length>0?await this._updateInputsUsingFormElements(d,n.elements,r):this._updateInputsUsingLayerFields(d,o==null?void 0:o.fields,r);this.inputs=h,await this._startExpressions()}async _updateInputsUsingFormElements(e,t,i){const n=new Map;for(const a of e)if(W(a)){n.set(a.element,a);for(const r of a.inputs)r.element&&n.set(r.element,r)}else a.element&&n.set(a.element,a);const s=new Map,o=this._updateInputsUsingFormElementsRecursive({existingInputsByElement:n,updatedElements:t.filter(Ae),sharedInitializationProperties:i,group:null,newExpressionExecutorPromises:s});for(const[a,r]of n.entries())n.delete(a),r.destroy();return await Promise.all(Array.from(s.values())),o}_updateInputsUsingFormElementsRecursive(e){const{existingInputsByElement:t,updatedElements:i,sharedInitializationProperties:n,group:s,newExpressionExecutorPromises:o}=e,a=[];for(const r of i){const d=t.has(r),h=d?t.get(r):ae(r)?this._makeGroupInputFromElement(r,n):ct(r)?this._makeFieldInputFromElement(r,n,s):xe(r)?this._makeRelationshipInputFromElement(r,n,s):null;if(h){if(a.push(h),this._assignExpressionExecutors(h,r,o),d)if(t.delete(r),W(h)){const{feature:p,timeZone:c}=n;h.set({feature:p,timeZone:c})}else if(Y(h)){const p=this.relationshipId===r.relationshipId;h.set(n),h.set({map:this.map,showAllEnabled:p})}else h.set(n);if(ae(r)){const p=r.elements.filter(c=>Ae(c));h.inputs=this._updateInputsUsingFormElementsRecursive({existingInputsByElement:t,updatedElements:p,sharedInitializationProperties:n,group:h,newExpressionExecutorPromises:o})}}}return a}_updateInputsUsingLayerFields(e,t,i){var p;if(!Array.isArray(t))return ee().warn(this.declaredClass,"No attribute fields found."),[];const n=new Map;for(const c of e)if(W(c)){for(const m of c.inputs)m.destroy();c.inputs.length=0,c.destroy()}else Y(c)?c.destroy():U(c)&&(c.element!==null?c.destroy():n.set(c.field,c));const s=[],{arcadeEditType:o,feature:a,initialFeature:r,layer:d,timeZone:h}=i;for(const c of t){const m=n.get(c)??new Ie({arcadeEditType:o,field:c,feature:a,initialFeature:r,layer:d,value:(a==null?void 0:a.getAttribute(c.name))??null,preservesValueWhenHidden:(p=this.formTemplate)==null?void 0:p.preserveFieldValuesWhenHidden,timeZone:h});s.push(m),n.delete(c)}for(const[c,m]of n.entries())n.delete(c),m.destroy();return s}_resetFieldInputValues(e){for(const t of this.allFieldInputs)t.value=e.getAttribute(t.name)}_makeFieldInputFromElement(e,t,i){var p;const{arcadeEditType:n,feature:s,initialFeature:o,layer:a,timeZone:r}=t,{fieldName:d}=e,h=d&&this._layerFieldsByName.get(d);return h?new Ie({arcadeEditType:n,element:e,field:h,value:(s==null?void 0:s.getAttribute(e.fieldName))??null,feature:s,initialFeature:o,layer:a,group:i,preservesValueWhenHidden:(p=this.formTemplate)==null?void 0:p.preserveFieldValuesWhenHidden,timeZone:r}):null}_makeGroupInputFromElement(e,t){const{feature:i,layer:n}=t;return new Rt({element:e,inputs:[],feature:i,layer:n})}_makeRelationshipInputFromElement(e,t,i=null){const{map:n}=this,{feature:s,layer:o,timeZone:a}=t,r=new Ot({element:e,feature:s,group:i,layer:o,map:n,timeZone:a});return r.addHandles(Le(()=>r.relatedLayer,"edits",()=>{var d;return(d=this._expressionsManager)==null?void 0:d.evaluateAsyncExpressions()})),r}_assignExpressionExecutors(e,t,i){var o;const n=ae(t)?$t:xe(t)?Lt:At,s=[];for(const a of n){const r=`${a}Executor`;if(e[r]){this._useExecutor(e[r]);continue}const d=t[a],{_expressionExecutorLookup:h}=this;if(d!=null&&d!==""){const p=((o=this._expressionInfosLookup.get(d))==null?void 0:o.expression)??d;if(h.has(p))e[r]=this._useExecutor(h.get(p));else if(i.has(p)){const c=i.get(p).then(m=>(e[r]=m,m));i.set(p,c)}else{const c=Et(p,this.layer).then(m=>(e[r]=this._useExecutor(m),h.set(p,m),m));i.set(p,c)}}}return s}_createExpressionsManager(e){const{_arcadeContextInfo:t,_featureClone:i,allFieldInputs:n,formTemplate:s}=this;this._expressionsManager=new A({executors:e,feature:i,arcadeContextInfo:t,fieldInputs:n,preserveFieldValuesWhenHidden:(s==null?void 0:s.preserveFieldValuesWhenHidden)===!0})}async _startExpressions(){if(this._expressionExecutorsInUse.size===0)return;const e=Array.from(this._expressionExecutorsInUse);this._createExpressionsManager(e),await this._expressionsManager.evaluateAll().finally(()=>this._afterExpressionsEvaluated())}_stopExpressions(){this._expressionsManager=ge(this._expressionsManager),this._expressionExecutorsInUse.clear()}_useExecutor(e){return this._expressionExecutorsInUse.add(e),e}_afterValueChange(e){var h;const{name:t,value:i}=e,{_featureClone:n,formTemplate:s,layer:o}=this;if(!o)return;const a=n.getAttribute(t);n.setAttribute(t,i);const{typeFieldName:r,types:d}=we(o);if(t===r&&i!==a){if(o.type==="subtype-sublayer"){const c=(h=o.parent)==null?void 0:h.findSublayerForFeature(n);n.sourceLayer=this.feature.sourceLayer=c}const p=new Set;for(const c of d)if(c.domains&&typeof c.domains=="object")for(const m of Object.keys(c.domains))p.add(m);for(const c of p){const m=this.findField(c);m&&m.notifyChange("domain")}}if(s!=null){const{description:p,title:c}=s;c&&be(c,t)&&this.notifyChange("formTitle"),p&&be(p,t)&&this.notifyChange("formDescription")}this._emitChangeEvent(e)}_afterExpressionsEvaluated(){const{_featureClone:e}=this;for(const t of this.allFieldInputs)t.value!==e.getAttribute(t.name)&&this._afterValueChange(t)}_joinContingentValues(){const e=this._contingentValuesCache;if(e==null)return[];const{typeFieldName:t}=we(this.layer),i=t?this.getValue(t):null,n=[];for(const a of e.fieldGroups){const{contingencies:r,fields:d,name:h}=a,p=[];for(const c of r)c.isRetired||c.subtype!=null&&c.subtype.code!==i||p.push({values:c.values});p.length>0&&n.push({name:h,fields:d,contingencies:p})}const[s,o]=this._generateJoinPlan(n);return[...s.flatMap(a=>this._joinFieldGroupContingencies(a)),...o.flatMap(a=>a.contingencies)]}_generateJoinPlan(e){const t=new Map,i=[],n=new Set;for(const d of e)for(const h of d.fields)if(t.has(h)){const p=t.get(h),c=d,m=[p.name,c.name].sort().join("|");if(n.has(m))continue;i.push([p,c]),n.add(m),t.set(h,c)}else t.set(h,d);const s=new Set(i.flat()),o=new Set(e);for(const d of s)o.delete(d);const a=new Map,r=new Map;for(const d of new Set(i.flat())){const h=Symbol(d.name);a.set(h,new Set([d])),r.set(d,h)}for(const[d,h]of i){const p=r.get(d),c=r.get(h);if(p===c)continue;const m=a.get(p),f=a.get(c);for(const y of f)m.add(y),r.set(y,p);a.delete(c)}return[[...a.values()].map(d=>[...d]),[...o]]}_joinFieldGroupContingencies(e){var d,h;const t=e.slice(),i=t.shift();let n=t.shift(),s=this._generateJoinKey(i.fields,n.fields),o=new Set([...i.fields,...n.fields]),a=new Map;for(const p of i.contingencies){const[c]=this._hashContingency(p,s.codedValueFields,!0);a.has(c)?(d=a.get(c))==null||d.push(p):a.set(c,[p])}for(;t.length>0;){const p=new Map,c=t.shift(),m=this._generateJoinKey(o,c.fields);for(const f of n.contingencies){const[y,b]=this._hashContingency(f,s.codedValueFields),g=b?this._findMatchingContingenciesWithAnyHashMask(a,y):a.get(y);if(a.has(B)&&(g==null||g.push(...this._findMatchingContingenciesContainingAny(f,a.get(B),s.codedValueFields))),g!=null)for(const x of g){const R=s.rangeFields.length>0?this._joinContingenciesWithRangeDomains(x,f,s.rangeFields):this._joinContingencies(x,f);if(R==null)break;const[D]=this._hashContingency(R,m.codedValueFields,!0);p.has(D)?(h=p.get(D))==null||h.push(R):p.set(D,[R])}}a=p,n=c,s=m,o=new Set([...o,...n.fields])}const r=[];for(const p of n.contingencies){const[c,m]=this._hashContingency(p,s.codedValueFields),f=m?this._findMatchingContingenciesWithAnyHashMask(a,c):a.get(c);if(a.has(B)&&f.push(...this._findMatchingContingenciesContainingAny(p,a.get(B),s.codedValueFields)),f!=null)for(const y of f){const b=s.rangeFields.length>0?this._joinContingenciesWithRangeDomains(y,p,s.rangeFields):this._joinContingencies(y,p);b!=null&&r.push(b)}}return r}_joinContingencies(e,t){const i={values:{...e.values,...t.values}};for(const[n,s]of Object.entries(i.values))s.objectType==="any"&&e.values[n]!=null&&(i.values[n]=e.values[n]);return i}_joinContingenciesWithRangeDomains(e,t,i){const n=this._joinContingencies(e,t);for(const s of i){const o=e.values[s],a=t.values[s],{leftIsNull:r,rightIsNull:d,bothAreNull:h,leftIsAny:p,rightIsAny:c,bothAreAny:m,leftIsRange:f,rightIsRange:y}=this._compareObjectTypes(o.objectType,a.objectType);if(h||m)continue;if(r&&c||d&&p){n.values[s]=new E({objectType:"null"});continue}if(r&&y||d&&f)return null;p?(o.minValue=-1/0,o.maxValue=1/0):c&&(a.minValue=-1/0,a.maxValue=1/0);const b=Math.max(o.minValue,a.minValue),g=Math.min(o.maxValue,a.maxValue);if(b>g)return null;n.values[s]=new E({objectType:"range",minValue:b,maxValue:g})}return n}_findMatchingContingenciesContainingAny(e,t,i){return t.filter(n=>i.every(s=>{var r,d;const o=n.values[s],a=e.values[s];return o.objectType==="any"||a.objectType==="any"||((r=o.codedValue)==null?void 0:r.code)===((d=a.codedValue)==null?void 0:d.code)}))}_findMatchingContingenciesWithAnyHashMask(e,t){const i=RegExp(`${t}$`),n=[];for(const[s,o]of e){if(s===B)break;i.test(s)&&n.push(...o)}return n}_generateJoinKey(e,t){var d;const i=Array.isArray(e)?new Set(e):e,n=Array.isArray(t)?new Set(t):t,s=i.size<n.size?i:n,o=s===i?n:i,a=new Set,r=new Set;for(const h of s)if(o.has(h)){const p=(d=this.layer)==null?void 0:d.getFieldDomain(h,{feature:this.feature});if(p==null)continue;switch(p.type){case"coded-value":a.add(h);break;case"range":r.add(h)}}return{codedValueFields:[...a],rangeFields:[...r]}}_contingencyIsValid(e,t){const i={};for(const{name:n,value:s}of this.allFieldInputs)this.fieldsWithContingentValues.has(n)&&s!=null&&n!==e&&(i[n]=s);return Object.entries(i).every(([n,s])=>!t.values.hasOwnProperty(n)||ht(s,t.values[n]))}_getContingentValueOptionsForField(e,t){const i=this.joinedContingentValues.slice(),n=new Map,s={code:"",name:t??"No value"};for(const o of i){const a=o.values[e];if((a==null?void 0:a.objectType)==="code"||(a==null?void 0:a.objectType)==="null"){const{code:r,name:d}=a.codedValue&&a.objectType!=="null"?a.codedValue:s;!n.has(r)&&this._contingencyIsValid(e,o)&&n.set(r,{name:d,value:r})}}return[...n.values()]}_hashContingency(e,t,i=!1){var o;if(t.length<1)return[Mt,!1];const n=[];let s=!1;for(const a of t){const r=e.values[a];if(r.objectType==="any"){if(i)return[B,!0];s=!0,n.push(`${a}:.*`)}else r.objectType==="null"?n.push(`${a}:${kt}`):n.push(`${a}:${(o=r.codedValue)==null?void 0:o.code}`)}return[n.sort().join("&"),s]}_compareObjectTypes(e,t){return{leftIsNull:e==="null",rightIsNull:t==="null",bothAreNull:e==="null"&&t==="null",leftIsAny:e==="any",rightIsAny:t==="any",bothAreAny:e==="any"&&t==="any",leftIsRange:e==="range",rightIsRange:t==="range"}}};function Ae(e){return e.type==="field"||e.type==="group"||e.type==="relationship"||(ee().warn("form-info::unsupported-element-type","Only element types 'field', 'group' and 'relationship' are supported",`Element ${e.label} has unsupported type '${e.type}'`),!1)}l([u()],v.prototype,"_expressionInfosLookup",null),l([u()],v.prototype,"_featureClone",void 0),l([u()],v.prototype,"_timeZone",void 0),l([u()],v.prototype,"activeRelationshipInput",null),l([u()],v.prototype,"_arcadeContextInfo",null),l([u()],v.prototype,"allFieldInputs",null),l([u()],v.prototype,"allGroupInputs",null),l([u()],v.prototype,"allRelationshipInputs",null),l([u()],v.prototype,"_layerFieldsByName",null),l([u()],v.prototype,"arcadeEditType",void 0),l([u()],v.prototype,"contingencyConstraintViolations",void 0),l([u()],v.prototype,"disabled",void 0),l([u()],v.prototype,"feature",null),l([u()],v.prototype,"fieldsWithContingentValues",null),l([u()],v.prototype,"fieldsWithInvalidCodedValue",null),l([u({type:Ye})],v.prototype,"formTemplate",null),l([u()],v.prototype,"formDescription",null),l([u()],v.prototype,"formTitle",null),l([u()],v.prototype,"formHeaderVisible",null),l([u()],v.prototype,"highlightHelper",void 0),l([u()],v.prototype,"inputs",void 0),l([u()],v.prototype,"joinedContingentValues",null),l([u()],v.prototype,"layer",null),l([u()],v.prototype,"map",void 0),l([u()],v.prototype,"relatedRecordCallbacks",void 0),l([u()],v.prototype,"relationshipId",null),l([u()],v.prototype,"spatialReference",null),l([u()],v.prototype,"state",null),l([u()],v.prototype,"strict",void 0),l([u()],v.prototype,"submittable",null),l([u()],v.prototype,"timeZone",null),l([u()],v.prototype,"updating",null),l([u()],v.prototype,"valid",null),l([u()],v.prototype,"view",null),l([u()],v.prototype,"getValues",null),l([u()],v.prototype,"submit",null),v=l([O(De)],v);const Dt=v,N="data-field-name";let V=class extends Xe{constructor(e,t){super(e,t),this._attemptFocusOnNextRender=!1,this._dateComponentMap=new Map,this._inputsWithChanges=new Set,this._focusedFieldName=null,this._listObserverNode=null,this._listObserver=new IntersectionObserver(i=>{i.length&&i[0].isIntersecting&&this._incrementRelatedRecordPage()},{root:window.document}),this.groupDisplay="all",this.headingLevel=2,this.messages=null,this.messagesCommon=null,this.messagesFeature=null,this.messagesTemplates=null,this.viewModel=new Dt,this._onShowAllRelatedRecordsClick=i=>{const{feature:n,relatedRecordCallbacks:s}=this;n&&(s!=null&&s.showAllRelatedRecords)&&s.showAllRelatedRecords({parentFeature:n,relationshipId:i})},this._onAddRelatedRecordsClick=(i,n)=>{const{feature:s,relatedRecordCallbacks:o}=this;s&&(o!=null&&o.addRelatedRecord)&&o.addRelatedRecord({parentFeature:s,relatedLayer:n,relationshipId:i})},this._activeCombobox=null,this._activeComboboxClosedByWorkaround=!1,this._onFormKeyDown=this._onFormKeyDown.bind(this),this._onFormSubmit=this._onFormSubmit.bind(this),this._onGroupToggle=this._onGroupToggle.bind(this),this._onComponentBlur=this._onComponentBlur.bind(this),this._onComponentFocus=this._onComponentFocus.bind(this),this._onComponentKeyDown=this._onComponentKeyDown.bind(this),this._afterComponentCreate=this._afterComponentCreate.bind(this),this._afterComponentCreateOrUpdate=this._afterComponentCreateOrUpdate.bind(this),this._afterDateComponentCreate=this._afterDateComponentCreate.bind(this),this._afterDateComponentCreateOrUpdate=this._afterDateComponentCreateOrUpdate.bind(this),this._afterRadioGroupCreateOrUpdate=this._afterRadioGroupCreateOrUpdate.bind(this),this._onComboboxOpen=this._onComboboxOpen.bind(this),this._onComboboxClose=this._onComboboxClose.bind(this),this.onScroll=this.onScroll.bind(this)}initialize(){this.addHandles([L(()=>this.feature,()=>{this._inputsWithChanges.clear(),this._dateComponentMap.clear(),et(()=>!this.viewModel.updating).then(()=>{const e=this._getFocusableInput("forward");this._syncGroupInputStates(),this._focusedFieldName=(e==null?void 0:e.name)||null,this._attemptFocusOnNextRender=!0})}),L(()=>this.groupDisplay,()=>this._syncGroupInputStates()),this.on("submit",e=>{if(e.invalid.length>0){const[t]=e.invalid;e.invalid.forEach(i=>this._inputsWithChanges.add(i)),this._focusedFieldName=t,this._attemptFocusOnNextRender=!0,this.scheduleRender()}}),L(()=>[this.viewModel.activeRelationshipInput,this._listObserverNode],()=>this._onObserverChange())])}loadDependencies(){return tt({block:()=>w(()=>import("./index-BS4ejk0L.js").then(e=>e.Fc),__vite__mapDeps([0,1])),button:()=>w(()=>import("./calcite-button-BEiwyGvk.js"),__vite__mapDeps([2,3,0,1])),combobox:()=>w(()=>import("./calcite-combobox-CXXlFLP6.js"),__vite__mapDeps([4,5,0,1,6,7,8,9,10,11,12])),"combobox-item":()=>w(()=>import("./calcite-combobox-item-BesItn9b.js"),__vite__mapDeps([13,11,0,1,7])),"combobox-item-group":()=>w(()=>import("./calcite-combobox-item-group-D87srIwh.js"),__vite__mapDeps([14,0,1,7])),icon:()=>w(()=>import("./calcite-icon-BkHotFMP.js"),__vite__mapDeps([15,0,1])),input:()=>w(()=>import("./calcite-input-QgysYMCD.js"),__vite__mapDeps([16,17,0,1,9,18,12,19])),"input-date-picker":()=>w(()=>import("./calcite-input-date-picker-DWn4WYL3.js"),__vite__mapDeps([20,0,1,9,12,21,18,19])),"input-message":()=>w(()=>import("./calcite-input-message-C1DV76vZ.js"),__vite__mapDeps([22,12,0,1])),"input-number":()=>w(()=>import("./calcite-input-number-CYtM_EwB.js"),__vite__mapDeps([23,24,0,1,9,18,12,19])),"input-time-picker":()=>w(()=>import("./calcite-input-time-picker-N84mbiCR.js"),__vite__mapDeps([25,0,1,26,9,12,21,18,19])),"input-time-zone":()=>w(()=>import("./calcite-input-time-zone-Y6IdxQPT.js"),__vite__mapDeps([27,0,1,10,5,6,7,8,9,11,12])),label:()=>w(()=>import("./calcite-label-CumKmLeQ.js"),__vite__mapDeps([28,0,1])),list:()=>w(()=>import("./calcite-list-DBGYLCXn.js"),__vite__mapDeps([29,0,1,30,6,17,9,18,12,19])),"list-item":()=>w(()=>import("./calcite-list-item-CwXGdoVL.js"),__vite__mapDeps([31,0,1,30])),loader:()=>w(()=>import("./calcite-loader-MUF21uuE.js"),__vite__mapDeps([32,0,1])),notice:()=>w(()=>import("./calcite-notice-C1QyOSTw.js"),__vite__mapDeps([33,0,1])),"radio-button":()=>w(()=>import("./calcite-radio-button-DQEp-7Eh.js"),__vite__mapDeps([34,0,1])),"radio-button-group":()=>w(()=>import("./calcite-radio-button-group-3_gtbEcw.js"),__vite__mapDeps([35,0,1,9,12])),switch:()=>w(()=>import("./calcite-switch-CtAlbgd2.js"),__vite__mapDeps([36,0,1])),"text-area":()=>w(()=>import("./calcite-text-area-ckJFZTv3.js"),__vite__mapDeps([37,0,1,9,18,12,38]))})}destroy(){this._listObserverNode&&this._listObserver.unobserve(this._listObserverNode)}get _relatedRecordsEnabled(){const e=this.relatedRecordCallbacks;return!(!e||!(e.addRelatedRecord||e.editRelatedRecord||e.showAllRelatedRecords))}get disabled(){return this.viewModel.disabled}set disabled(e){this.viewModel.disabled=e}get feature(){return this.viewModel.feature}set feature(e){this.viewModel.feature=e}get formTemplate(){return this.viewModel.formTemplate}set formTemplate(e){this.viewModel.formTemplate=e}get label(){var e;return((e=this.messages)==null?void 0:e.widgetLabel)??""}set label(e){this._overrideIfSome("label",e)}get layer(){return this.viewModel.layer}set layer(e){this.viewModel.layer=e}get map(){return this.viewModel.map}set map(e){this.viewModel.map=e}get relatedRecordCallbacks(){return this.viewModel.relatedRecordCallbacks}set relatedRecordCallbacks(e){this.viewModel.relatedRecordCallbacks=e}get relationshipId(){return this.viewModel.relationshipId}set relationshipId(e){this.viewModel.relationshipId=e}get spatialReference(){return this.viewModel.spatialReference}set spatialReference(e){this.viewModel.spatialReference=e}get strict(){return this.viewModel.strict}set strict(e){this.viewModel.strict=e}get timeZone(){return this.viewModel.timeZone}set timeZone(e){this.viewModel.timeZone=e}get view(){return z(q.getLogger(this),"view",{replacement:"Use FeatureForm.map instead.",version:"4.27"}),this.viewModel.view}set view(e){z(q.getLogger(this),"view",{replacement:"Use FeatureForm.map instead.",version:"4.27"}),this.viewModel.view=e}getValues(){return this.viewModel.getValues()}submit(){return this.viewModel.submit()}render(){const{state:e}=this.viewModel;return _("div",{class:this.classes(C.base,Ce.widget,Ce.panel),onscroll:this.onScroll},e==="ready"?this._renderForm():null)}_renderForm(){return _("form",{class:C.form,novalidate:!0,onkeydown:this._onFormKeyDown,onsubmit:this._onFormSubmit},this._renderHeader(),this._renderContent())}_renderHeader(){const e=this.viewModel;if(!e.formHeaderVisible)return;const t=e.formTitle!=null&&_(it,{key:"title",level:this.headingLevel},e.formTitle),i=e.formDescription!=null&&_("p",{class:C.description,key:"description"},e.formDescription);return _("div",{class:C.formHeader},t,i)}_renderContent(){const{viewModel:e}=this;return e.activeRelationshipInput?this._renderActiveRelationshipInput(e.activeRelationshipInput):e.inputs.filter(ce).filter(t=>t.visible).map((t,i)=>W(t)?this._renderGroup(t,i):U(t)?this._renderLabeledField(t):Y(t)?this._renderRelationshipInput(t):void 0)}_renderActiveRelationshipInput(e){return this._renderRelationshipInput(e)}_renderDescriptionOrEmpty(e,t){return e==null?null:_("div",{class:this.classes(C.description),id:t},e)}_renderGroup(e,t){const{disabled:i,formTemplate:n,headingLevel:s}=this,{description:o,inputs:a,label:r,open:d}=e,h=a.filter(y=>y.visible),p=this.viewModel.findField(this._focusedFieldName),c=(p==null?void 0:p.group)===e,m=`${this.id}_group_${t}`,f=this.groupDisplay==="sequential";return _("calcite-block",{class:this.classes(C.group,f?C.groupSequential:null,c?C.groupActive:null,i?C.inputDisabled:null),collapsible:!0,"data-group":e,description:o||void 0,disabled:i,heading:`${r}`,headingLevel:n!=null&&n.title?nt(s):s,id:m,key:m,open:d,onCalciteBlockToggle:({target:y})=>this._onGroupToggle(y,e)},h.map(y=>U(y)?this._renderLabeledField(y):Y(y)?this._renderRelationshipInput(y):void 0))}_getFocusableInput(e,t){const i=this.viewModel.allFieldInputs,n=e==="forward"?i:i.slice().reverse();let s;if(!t||Y(t))s=0;else if(W(t)){const o=t.inputs.find(U);s=o?n.indexOf(o):0}else{let o;if(re(t)&&!t.group.open){const a=t.group.inputs.filter(U);o=e==="forward"?a[a.length-1]:a[0]}else o=t;s=n.indexOf(o)+1}for(let o=s;o<n.length;o++){const a=n[o];if(a.visible&&U(a))return a}return null}_renderLabeledField(e){var d;const{dataType:t,feature:i,label:n,layer:s,required:o}=e,a={"aria-label":o?ne(this.messages.requiredFieldLabel,{name:n}):n,class:C.label,key:`${s.id}-${i.uid}-${e.name}`},r=[_("div",{class:C.labelTextContent,key:"labelTextContainer"},n,o?_("span",{"aria-hidden":"true",title:this.messagesCommon.required},"*"):void 0),t!=="unsupported"?this._renderFieldInput(e):this._renderReadOnlyComponent(e),this._renderAuxiliaryText(e)];return t==="date"&&((d=e.domain)==null?void 0:d.type)!=="coded-value"?_("label",{...a},r):_("calcite-label",{...a},r)}_renderFieldInput(e){const{dataType:t,domain:i,inputType:n,name:s}=e,o=this.getCommonInputProps(e);if((i==null?void 0:i.type)==="coded-value"){const a=this.viewModel.getFieldValueOptionsForField(s,this.messages.empty);return n!=="switch"||e.hasInvalidSwitchValue?n==="radio-buttons"?this._renderRadioButtonComponents(e,a.flat(),o):this._renderComboBoxComponent(e,a,o):this._renderSwitchComponent(e,o)}return n==="datetime-picker"||t==="date"?this._renderDateComponents(e,o):t==="number"?this._renderNumberComponent(e,o):this._renderStringComponent(e,o)}_renderStringComponent(e,t){return e.inputType==="text-area"?t.readOnly?_("calcite-input",{...t,loading:e.updating,type:"textarea",onCalciteInputInput:i=>this._saveValueFromComponent(i.target)}):_("calcite-text-area",{...t,resize:"vertical",onCalciteTextAreaInput:i=>this._saveValueFromComponent(i.target)}):_("calcite-input",{...t,loading:e.updating,type:"text",onCalciteInputInput:i=>this._saveValueFromComponent(i.target)})}_renderNumberComponent(e,t){return _("calcite-input-number",{...t,integer:st(e.field),loading:e.updating,type:"number",onCalciteInputNumberInput:i=>this._saveValueFromComponent(i.target)})}_renderDateComponents(e,t){const{field:i}=e;switch(i.type){case"date":return this._renderDateFieldComponents(e,t);case"date-only":return this._renderDateOnlyFieldComponent(e,t);case"time-only":return this._renderTimeOnlyFieldComponent(e,t);case"timestamp-offset":return this._renderTimestampOffsetFieldComponents(e,t);default:return this._renderReadOnlyComponent(e,ot(i,t.value,{timeZone:this.timeZone,...at(i)}))}}_renderDateOnlyFieldComponent(e,t){const{range:i,valid:n,value:s}=e,{class:o,key:a,readOnly:r}=t,{rawMax:d,rawMin:h}=i;return _("calcite-input-date-picker",{afterCreate:this._afterDateComponentCreate,afterUpdate:this._afterDateComponentCreateOrUpdate,"aria-invalid":!n,class:o,"data-date-part":"date","data-field-name":t[N],key:`${a}-date-input`,max:Fe(d)?d:void 0,min:Fe(h)?h:void 0,numberingSystem:X,onblur:p=>{this._focusedFieldName=null,this._saveValueFromDateComponent(p.target)},onfocus:this._onComponentFocus,overlayPositioning:"fixed",readOnly:r,value:s!=null?`${s}`:void 0,onCalciteInputDatePickerChange:p=>this._saveValueFromDateComponent(p.target)})}_renderTimeOnlyFieldComponent(e,t){const{valid:i,value:n}=e,{class:s,key:o,readOnly:a}=t;return _("calcite-input-time-picker",{afterCreate:this._afterDateComponentCreate,afterUpdate:this._afterDateComponentCreateOrUpdate,"aria-invalid":!i,class:s,"data-date-part":"time","data-field-name":t[N],key:`${o}-time-input`,numberingSystem:X,onblur:r=>{this._focusedFieldName=null,this._saveValueFromDateComponent(r.target)},onfocus:this._onComponentFocus,overlayPositioning:"fixed",readOnly:a,step:e.timeStep,value:n!=null?`${n}`:void 0,onCalciteInputTimePickerChange:r=>this._saveValueFromDateComponent(r.target)})}_renderTimestampOffsetFieldComponents(e,t){const{name:i,range:n,timeZone:s,valid:o,value:a}=e,{class:r,key:d,readOnly:h}=t,{rawMax:p,rawMin:c}=n,m={afterCreate:this._afterDateComponentCreate,afterUpdate:this._afterDateComponentCreateOrUpdate,"aria-invalid":!o,numberingSystem:X,overlayPositioning:"fixed",readOnly:h,[N]:i,onfocus:this._onComponentFocus},f=se(p,s),y=se(c,s),b=se(a,s);return _("div",{class:C.dateInputContainer,key:`${d}-date-time-container`},_("calcite-input-date-picker",{...m,class:r,"data-date-part":"date",key:`${d}-date-input`,max:(f==null?void 0:f.date)??void 0,min:(y==null?void 0:y.date)??void 0,onblur:g=>{this._focusedFieldName=null,this._saveValueFromDateComponent(g.target)},value:b.date??void 0,onCalciteInputDatePickerChange:g=>this._saveValueFromDateComponent(g.target)}),_("calcite-input-time-picker",{...m,class:r,"data-date-part":"time",key:`${d}-time-input`,onblur:g=>{this._focusedFieldName=null,this._saveValueFromDateComponent(g.target)},step:e.timeStep,value:b.time??void 0,onCalciteInputTimePickerChange:g=>this._saveValueFromDateComponent(g.target)}),e.includeTimeOffset?_("calcite-input-time-zone",{...m,class:r,"data-date-part":"timeZone",disabled:h,key:`${d}-timezone-input`,onblur:g=>{this._focusedFieldName=null,this._saveValueFromDateComponent(g.target)},value:b.timeZoneOffset??"0",onCalciteInputTimeZoneChange:g=>this._saveValueFromDateComponent(g.target)}):null)}_renderDateFieldComponents(e,t){const{includeTime:i,name:n,valid:s,value:o}=e,{class:a,key:r,max:d,min:h,readOnly:p}=t,{timeZone:c}=this,m={afterCreate:this._afterDateComponentCreate,afterUpdate:this._afterDateComponentCreateOrUpdate,"aria-invalid":!s,numberingSystem:X,overlayPositioning:"fixed",readOnly:p,[N]:n,onfocus:this._onComponentFocus},f=oe(o,c),y=oe(d,c),b=oe(h,c);return _("div",{class:C.dateInputContainer,key:`${r}-date-time-container`},_("calcite-input-date-picker",{...m,class:a,"data-date-part":"date",key:`${r}-date-input`,max:(y==null?void 0:y.date)??void 0,min:(b==null?void 0:b.date)??void 0,onblur:g=>{this._focusedFieldName=null,this._saveValueFromDateComponent(g.target)},value:f.date??void 0,onCalciteInputDatePickerChange:g=>this._saveValueFromDateComponent(g.target)}),i?_("calcite-input-time-picker",{...m,class:a,"data-date-part":"time",key:`${r}-time-input`,onblur:g=>{this._focusedFieldName=null,this._saveValueFromDateComponent(g.target)},step:1,value:f.time??void 0,onCalciteInputTimePickerChange:g=>this._saveValueFromDateComponent(g.target)}):null)}_renderReadOnlyComponent(e,t){const i=this.getCommonInputProps(e);return _("calcite-input",{...i,class:this.classes(C.fieldInput,C.inputDisabled),readOnly:!0,type:"text",value:t!=null?`${t}`:i.value})}_renderComboBoxComponent(e,t,i){const{value:n,name:s}=e,{messages:o,messagesTemplates:a,viewModel:r,_inputsWithChanges:d}=this,h=t.map(x=>x.map(({name:R,value:D})=>_("calcite-combobox-item",{key:`#${D}`,selected:n===D,textLabel:R,value:`${D}`}))),[p,c]=h;this.viewModel.fieldsWithInvalidCodedValue.has(e)&&c.unshift(_("calcite-combobox-item",{key:"incompatible-option",readOnly:!0,textLabel:`${e.value}`,value:`${e.value}`}));const m=c.length>0?[_("calcite-combobox-item-group",{key:"recommended",label:o.recommended},p),_("calcite-combobox-item-group",{key:"other",label:a.other},c)]:p,f=r.arcadeEditType==="INSERT",y=d.has(s),b=n==null&&(!f||y);e.showNoValueOptionEnabled&&m.unshift(_("calcite-combobox-item",{key:"empty-option",selected:b,textLabel:e.showNoValueLabel||o.empty,value:""}));const g=f&&e.showNoValueOptionEnabled&&!y?()=>{}:i.onblur;return _("calcite-combobox",{...i,allowCustomValues:!1,clearDisabled:!0,disabled:i.readOnly,onblur:g,overlayPositioning:"fixed",selectionMode:"single",onCalciteComboboxBeforeOpen:this._onComboboxOpen,onCalciteComboboxChange:({target:x})=>{b&&x.selectedItems.length===0?this._ignoreDeselectionOfNoValueOption(x):this._saveValueFromComponent(x)},onCalciteComboboxClose:this._onComboboxClose},m)}_renderRadioButtonComponents(e,t,i){const{name:n,value:s}=e,o=t.map(({name:a,value:r})=>this._renderRadioButtonComponent({key:a,label:a,name:n,value:r,selected:r===s,props:i}));if(e.showNoValueOptionEnabled){const a="",r=e.showNoValueLabel||this.messages.empty,d=s===a||s===null;o.unshift(this._renderRadioButtonComponent({key:"empty-option",label:r,name:n,value:a,selected:d,props:i}))}return _("calcite-radio-button-group",{afterCreate:this._afterRadioGroupCreateOrUpdate,afterUpdate:this._afterRadioGroupCreateOrUpdate,class:C.inputRadioGroup,"data-field-name":i[N],key:`${i.key}-radio-group`,layout:"vertical",name:i.key,required:i.required},o)}_renderSwitchComponent(e,t){const{value:i}=e,n=!!Ee(e.element,"switch")&&i===e.element.input.onValue;return _("calcite-switch",{...t,checked:n,class:C.inputSwitch,disabled:t.readOnly,onblur:()=>{this._focusedFieldName=null},onCalciteSwitchChange:s=>this._saveValueFromComponent(s.target)})}_renderRadioButtonComponent({key:e,name:t,value:i,selected:n,label:s,props:o}){return _("calcite-label",{class:C.inputRadioLabel,key:e,layout:"inline"},_("calcite-radio-button",{...o,afterCreate:void 0,afterUpdate:void 0,checked:n,class:C.inputRadio,disabled:o.readOnly,name:t,onblur:()=>{this._focusedFieldName=null},value:i,onCalciteRadioButtonChange:({target:a})=>{a.checked&&this._saveValueFromComponent(a)}}),s)}_renderAuxiliaryText(e){const t=e.name,i=this._inputsWithChanges.has(t)&&!e.valid?mt(e,this.messages,this.timeZone):this.viewModel.contingencyConstraintViolations.get(t)!=null?this.messages.validationErrors.valuesIncompatible:e.valueExpressionExecutor!=null&&e.valueExpressionExecutor.stale?this.messages.valueExpressionError:null;return i!=null?_("calcite-input-message",{icon:!0,status:"invalid"},i):this._renderDescriptionOrEmpty(e.description)}_renderShowAllRelatedRecordsListItem(e){const{featureCount:t,relationshipId:i,showAllActionVisible:n}=e,{relatedRecordCallbacks:s}=this;if(!n||!(s!=null&&s.showAllRelatedRecords))return;const o=this.messages;return _("calcite-list-item",{description:ne(o.totalCount,{count:t}),label:o.showAll,value:!0,onCalciteListItemSelect:()=>this._onShowAllRelatedRecordsClick(i)},_("calcite-icon",{icon:"list",scale:"s",slot:"content-end"}))}_renderAddRelatedRecordButton(e){const{canAddRelatedFeature:t,relationshipId:i,relatedLayer:n}=e,{messages:s,relatedRecordCallbacks:o}=this;if(t&&(o!=null&&o.addRelatedRecord)&&n)return _("calcite-button",{alignment:"center",appearance:"outline-fill",class:C.centeredButton,disabled:e.updating||!e.originHasValidKey,iconStart:"plus",key:`${i}-add-button`,onclick:()=>{!e.updating&&e.originHasValidKey&&this._onAddRelatedRecordsClick(i,n)},round:!0,scale:"s",width:"half"},e.relatedLayerIsTable?s.addRecord:s.addFeature)}_renderRelatedRecordListItem(e,t){const{feature:i,description:n,title:s}=e,{feature:o,relatedRecordCallbacks:a}=this,{highlightHelper:r}=this.viewModel,d=()=>{r==null||r.removeAll(),a!=null&&a.editRelatedRecord&&o&&a.editRelatedRecord({parentFeature:o,relationshipId:t,relatedFeature:i})},h=r?()=>r.add(i):void 0,p=r?()=>r.remove(i):void 0;return _("calcite-list-item",{bind:this,description:n,key:`${t}-${i.uid}`,label:s,onclick:d,onmouseenter:h,onmouseleave:p,value:s},_("calcite-icon",{icon:ft(i),scale:"m",slot:"content-start"}),_("calcite-icon",{icon:"chevron-right",scale:"s",slot:"content-end"}))}_renderRelationshipInput(e){if(!this._relatedRecordsEnabled||!e.editable)return;const{featureCount:t,relationshipId:i,showAllEnabled:n}=e,s=n?null:this._renderDescriptionOrEmpty(e.description),o=t>0?this._renderRelatedRecordsList(e):e.loaded?e.originHasValidKey?this._renderNoRelatedRecordsNotice():this._renderNoValidOriginKeyNotice(e):void 0;return _("calcite-label",{class:this.classes(C.label,C.relatedRecordsLabel),key:`relationship-${i}-container`},_("div",null,this._renderRelatedRecordsHeaderContainer(e),s,o),this._renderAddRelatedRecordButton(e))}_renderRelatedRecordsHeaderContainer(e){var i;const t=e.updating||!e.loaded;return _("div",{class:C.relatedRecordsHeader,key:`relationship-${e.relationshipId}-header`},_("span",null,e.label),t?_("calcite-loader",{inline:!0,key:"loader",label:(i=this.messagesCommon)==null?void 0:i.loading,scale:"s",type:"indeterminate"}):void 0)}_renderRelatedRecordsList(e){const{relationshipId:t}=e;return _("calcite-list",{class:C.relatedRecordsList},e.relatedFeatureInfos.map(i=>this._renderRelatedRecordListItem(i,t)),this._renderShowAllRelatedRecordsListItem(e),this._renderObserverNode())}_renderNoValidOriginKeyNotice(e){var d,h,p;const{messages:t}=this,i=e.relatedLayerIsTable?t.noOriginKeyRecord:t.noOriginKeyFeature,n=(d=e.relationship)==null?void 0:d.keyField,s=this.viewModel.findField(n),o=(h=e.layer)==null?void 0:h.fieldsIndex.get(n),a=(s==null?void 0:s.label)||(o==null?void 0:o.alias)||n,r=ne(i,{relatedLayerName:(p=e.relatedLayer)==null?void 0:p.title,originKeyField:a});return _("calcite-notice",{icon:"information",kind:"brand",open:!0,scale:"s",width:"full"},_("div",{slot:"message"},r))}_renderNoRelatedRecordsNotice(){return _("calcite-notice",{icon:"information",kind:"brand",open:!0,scale:"s",width:"full"},_("div",{slot:"message"},this.messagesFeature.noRelatedFeatures))}_renderObserverNode(){var e;if((e=this.viewModel.activeRelationshipInput)!=null&&e.showAllEnabled)return _("div",{afterCreate:this._afterListObserverCreated,afterRemoved:this._afterListObserverRemoved,bind:this,class:C.listObserver,key:"feature-observer"})}getCommonInputProps(e){const{disabled:t}=this,{editable:i,hint:n,label:s,maxLength:o,minLength:a,name:r,range:{max:d,min:h},required:p,valid:c,value:m}=e,f=this._inputsWithChanges.has(r),y=!i||t;return{afterCreate:this._afterComponentCreate,afterUpdate:this._afterComponentCreateOrUpdate,"aria-invalid":c?"false":"true",class:this.classes(C.fieldInput,y?C.inputDisabled:null,f&&!c?C.inputInvalid:null),key:r,label:s,max:d??void 0,min:h??void 0,maxLength:o>-1?o:void 0,minLength:a>-1?a:void 0,placeholder:n??void 0,readOnly:y,required:p,value:m==null?"":`${m}`,onblur:this._onComponentBlur,onfocus:this._onComponentFocus,onkeydown:this._onComponentKeyDown,[N]:r}}_getFieldInputFromHTMLElement(e){return this.viewModel.findField(e.getAttribute(N))}_afterDateComponentCreate(e){const t=this._getFieldInputFromHTMLElement(e),i=e.dataset.datePart,n=this._dateComponentMap.get(t.name);if("valueAsDate"in e&&e.value!=null){const s=e.value,o=new ResizeObserver(()=>{e.value=void 0,e.value=s,o.unobserve(e)});o.observe(e)}if(n!=null)switch(i){case"date":n.date=e;break;case"time":n.time=e;break;case"timeZone":n.timeZone=e}else this._dateComponentMap.set(t.name,{[i]:e});this._afterDateComponentCreateOrUpdate(e)}_afterDateComponentCreateOrUpdate(e){this._afterComponentCreateOrUpdate(e)}_afterComponentCreate(e){const t=this._getFieldInputFromHTMLElement(e);yt(t)&&e.value!=null&&"setNumberValue"in e&&e.setNumberValue({committing:!1,value:e.value,origin:"direct"}),this._afterComponentCreateOrUpdate(e)}_afterRadioGroupCreateOrUpdate(e){const t=e.selectedItem,i=e.querySelector("calcite-radio-button"),n=t||i;n&&this._afterComponentCreateOrUpdate(n)}_afterComponentCreateOrUpdate(e){const{viewModel:t}=this,i=this._getFieldInputFromHTMLElement(e),n=t.findField(this._focusedFieldName);this._attemptFocusOnNextRender&&n===i&&(this._attemptFocusOnNextRender=!1,re(i)&&(i.group.open=!0),e.setFocus())}_onComponentFocus(e){const t=e.target,i=this._getFieldInputFromHTMLElement(t);this._focusedFieldName=i.name}_onComponentBlur(e){const t=e.target;this._focusedFieldName=null,this._saveValueFromComponent(t)}_saveValueFromDateComponent(e){const{timeZone:t}=this,i=this._getFieldInputFromHTMLElement(e),n=i.field.type,{name:s,range:o}=i,a=this._dateComponentMap.get(s);if(!a)return;let r=this.viewModel.getValue(s),d=null;n==="date-only"?d=e.value:n==="time-only"?(r=Ve(r),d=Ve(e.value)):d=n==="timestamp-offset"?e.value!=null?rt({dateComponent:a.date,timeComponent:a.time,timeZoneComponent:a.timeZone,oldValue:r,defaultTimeZone:t}):null:e.value!=null?lt({oldValue:r,dateComponent:a.date,timeComponent:a.time,timeZone:t,max:o.max,min:o.min}):null,d!==null&&e.value?r!==d&&this._updateFieldValue(s,d):this._updateFieldValue(s,null)}_saveValueFromComponent(e){const t=this._getFieldInputFromHTMLElement(e);this._updateFieldValue(t.name,this._parseValue(e))}_onComponentKeyDown({key:e,target:t}){const i=this._getFieldInputFromHTMLElement(t);e==="Enter"&&re(i)&&!i.group.open&&(i.group.open=!0)}_updateFieldValue(e,t){if(this.viewModel.setValue(e,t),this._inputsWithChanges.add(e),this.viewModel.fieldsWithContingentValues.has(e)){const i=Object.fromEntries(Object.entries(this.getValues()).filter(([n,s])=>s!=null));this.viewModel.validateContingencyConstraints(i)}}_parseValue(e){const t=this._getFieldInputFromHTMLElement(e),i=e.value;return Ee(t.element,"switch")?e.checked?t.element.input.onValue:t.element.input.offValue:i==null||i===""?null:t.dataType==="number"?i==="-0"||i==="-0."||i==="-0,"?i:parseFloat(i):t.field.type==="date"?parseFloat(i):i}_ignoreDeselectionOfNoValueOption(e){const{firstChild:t,selectedItems:i}=e;i.length===0&&t&&"selected"in t?t.selected=!0:q.getLogger(this).warnOnce("Failed to override user attempt to deselect 'No value' option.")}_onGroupToggle(e,t){var i;e.open?(t.open=!0,this._focusedFieldName=((i=this._getFocusableInput("forward",t))==null?void 0:i.name)||null,this._attemptFocusOnNextRender=!0,this.groupDisplay==="sequential"&&this.viewModel.allGroupInputs.forEach(n=>{n!==t&&(n.open=!1)})):t.open=!1,this.scheduleRender()}_onFormSubmit(e){e.preventDefault()}_onFormKeyDown(e){e.key==="Enter"&&this.viewModel.submit()}_afterListObserverCreated(e){this.viewModel.activeRelationshipInput&&(this._listObserverNode=e)}_afterListObserverRemoved(){this._listObserverNode=null}_onObserverChange(){this._listObserverNode&&this._listObserver.unobserve(this._listObserverNode);const e=this.viewModel.activeRelationshipInput;e&&this._listObserverNode&&e.showAllEnabled&&this._listObserver.observe(this._listObserverNode)}_incrementRelatedRecordPage(){const e=this.viewModel.activeRelationshipInput;e==null||e.incrementPage()}_syncGroupInputStates(){if(this.groupDisplay!=="sequential")return;const e=this.viewModel.allGroupInputs;if(!e.length)return;const t=e.filter(i=>i.open);t.length===0?e[0].open=!0:t.length>1&&t.slice(1).forEach(i=>i.open=!1)}_onComboboxClose(e){this._activeComboboxClosedByWorkaround||this._activeCombobox!==e.target||(this._activeCombobox=null)}_onComboboxOpen(e){this._activeComboboxClosedByWorkaround=!1,this._activeCombobox=e.target}onScroll(e){if(this._activeCombobox){const t=this._activeCombobox.getBoundingClientRect(),i=e.target.getBoundingClientRect();t.bottom>i.bottom?(this._activeComboboxClosedByWorkaround=!0,this._activeCombobox.open=!1):(this._activeComboboxClosedByWorkaround&&(this._activeCombobox.open=!0,this._activeComboboxClosedByWorkaround=!1),this._activeCombobox.reposition())}}};l([u()],V.prototype,"_listObserverNode",void 0),l([u()],V.prototype,"_relatedRecordsEnabled",null),l([u()],V.prototype,"disabled",null),l([u()],V.prototype,"feature",null),l([u()],V.prototype,"formTemplate",null),l([u()],V.prototype,"groupDisplay",void 0),l([u()],V.prototype,"headingLevel",void 0),l([u()],V.prototype,"label",null),l([u()],V.prototype,"layer",null),l([u()],V.prototype,"map",null),l([u(),Q("esri/widgets/FeatureForm/t9n/FeatureForm")],V.prototype,"messages",void 0),l([u(),Q("esri/t9n/common")],V.prototype,"messagesCommon",void 0),l([u(),Q("esri/widgets/Feature/t9n/Feature")],V.prototype,"messagesFeature",void 0),l([u(),Q("esri/widgets/FeatureTemplates/t9n/FeatureTemplates")],V.prototype,"messagesTemplates",void 0),l([u()],V.prototype,"relatedRecordCallbacks",null),l([u()],V.prototype,"relationshipId",null),l([u()],V.prototype,"spatialReference",null),l([u()],V.prototype,"strict",null),l([u()],V.prototype,"timeZone",null),l([u()],V.prototype,"view",null),l([u(),Qe(["value-change","submit"])],V.prototype,"viewModel",void 0),V=l([O("esri.widgets.FeatureForm")],V);const St=V,zt=Object.freeze(Object.defineProperty({__proto__:null,default:St},Symbol.toStringTag,{value:"Module"}));export{St as $,zt as F,Dt as J};
