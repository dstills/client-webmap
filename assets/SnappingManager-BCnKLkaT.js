function __vite__mapDeps(indexes) {
  if (!__vite__mapDeps.viteFileDeps) {
    __vite__mapDeps.viteFileDeps = ["assets/FeatureServiceSnappingSource-BsR_DWGA.js","assets/index-D2dWKXoe.js","assets/index-DvE0Cji0.css","assets/memoize-DsJmrG76.js","assets/angularMeasurementUtils-D3zeviIM.js","assets/geodesicUtils-0BUrW_mO.js","assets/geometry2dUtils-14ZJrqSH.js","assets/quantityUtils-D4B7S4Ay.js","assets/queryEngineUtils-DEysbqrw.js","assets/VertexSnappingCandidate-CC6WEMFf.js","assets/PointSnappingHint-BIO8m24G.js","assets/TileTreeDebugger-Cgg-XobY.js","assets/viewUtils-jOSSHAZP.js","assets/geometryEngine-Bmlaqucx.js","assets/geometryEngineBase-C1UOpB5A.js","assets/hydrated-CRFlPVgK.js","assets/geodesicMeasurementUtils-DzAxKO3X.js","assets/FeatureCollectionSnappingSource-D9JDQoWL.js","assets/symbologySnappingCandidates-BOEoGBMG.js","assets/GraphicsSnappingSource-C1JGV5dF.js","assets/normalizeUtilsSync-Dz5OSybT.js","assets/FeatureStore-BDDt6QCR.js","assets/BoundsStore-BqU0iVCZ.js","assets/PooledRBush-CAMpd6JN.js","assets/timeSupport-CPgUqEcA.js","assets/json-Wa8cmqdu.js","assets/optimizedFeatureQueryEngineAdapter-BkoAFv2c.js","assets/centroid-DdLmOD72.js","assets/QueryEngine-3rzOuYnJ.js","assets/WhereClause-mbTZq1Ug.js","assets/TimeOnly-D0utIrTg.js","assets/utils-BQwfAars.js","assets/utils-BQgBqKyD.js","assets/ClassBreaksDefinition-DsTASs_h.js","assets/SceneLayerSnappingSource-BIH6oaro.js"]
  }
  return indexes.map((i) => __vite__mapDeps.viteFileDeps[i])
}
import{qe as it,eK as Ae,eL as R,G as st,e$ as $e,g as Ne,E as p,F as f,J as q,O as H,bc as N,aU as je,y as nt,v7 as J,eM as rt,cP as at,br as W,by as ge,cX as qe,cM as ne,nR as ce,D as ot,Bd as lt,eq as ct,k8 as dt,av as de,nD as Z,d4 as He,kE as ht,fT as _,_ as K,eV as pt,o6 as ut,f0 as ft,zT as ye,Be as gt,Bf as Ge,mF as yt,fQ as ze,eT as vt,g2 as Q,fv as ve,fe as Pe,fw as _t,fx as St,fu as wt,f4 as Et,jf as mt,wH as xt,c4 as Tt,bs as Re,d3 as be,hU as $t,en as Pt}from"./index-D2dWKXoe.js";import{p as V,z as Ce,g as P,C as Rt,n as C,E as L,L as bt,s as ke,c as _e,F as v,f as g,D as Ue,G as Ct,H as G,I as We,J as re,K as ae,A as Ze,O as Lt,l as oe,r as Ft,b as Se,M as Vt,m as Mt,o as It,h as Y,k as Le}from"./angularMeasurementUtils-D3zeviIM.js";import{d as w}from"./viewUtils-jOSSHAZP.js";import{i as z,s as Xe,l as Be}from"./quantityUtils-D4B7S4Ay.js";import{geodesicLength as Je}from"./geometryEngine-Bmlaqucx.js";import{j as we,z as Dt,v as Ot}from"./geodesicUtils-0BUrW_mO.js";import{t as Ke}from"./geodesicMeasurementUtils-DzAxKO3X.js";import{j as At,I as he,N as Nt}from"./geometry2dUtils-14ZJrqSH.js";function jt({hasZ:n,spatialReference:e,paths:t},i,s=0){const r=it(e);if(r==null)return!1;const a=n?o=>o:o=>Ae(qt,o[0],o[1],s);for(const o of t){const c=[];for(const l of o){const d=[0,0,s];r(a(l),0,d,0),c.push(d)}i.push(c)}return!0}const qt=R();function _i(n){const{spatialReference:e}=n;return Ke(e,kt,Ut,Wt,n)}function Si(n,e){if(!st(n.spatialReference,e.spatialReference))return null;const{spatialReference:t}=n;return ee[0]=n.x,ee[1]=n.y,ee[2]=n.hasZ?n.z:0,te[0]=e.x,te[1]=e.y,te[2]=e.hasZ?e.z:0,Ee(ee,te,t)}function Ee(n,e,t){return Ke(t,Ht,Gt,zt,n,e,t)}function Ht(n,e,t){return z(we(me,n,e,t).distance,"meters")}function Gt(n,e,t){return z(Je(Zt(n,e,t),"meters"),"meters")}function zt(n,e,t){return $e(n,t,Fe)&&$e(e,t,Ve)?z(we(me,Fe,Ve,Ne.WGS84).distance,"meters"):null}function kt(n){return z(Ot([n],"meters")[0],"meters")}function Ut(n){return z(Je(n,"meters"),"meters")}function Wt(n){const e=[];if(!jt(n,e))return null;let t=0;for(const i of e){let s=0;for(let r=1;r<i.length;++r)s+=we(me,i[r-1],i[r],Ne.WGS84).distance;t+=s}return z(t,"meters")}function Zt(n,e,t){return{type:"polyline",spatialReference:t,paths:[[[...n],[...e]]]}}const me=new Dt,ee=R(),te=R(),Fe=R(),Ve=R();let I=class extends H{constructor(e){super(e),this.layer=null,this.enabled=!0,this.updating=!1,this.availability=1,this.sublayerSources=new N}};p([f({constructOnly:!0})],I.prototype,"layer",void 0),p([f()],I.prototype,"enabled",void 0),p([f()],I.prototype,"updating",void 0),p([f()],I.prototype,"availability",void 0),p([f()],I.prototype,"sublayerSources",void 0),I=p([q("esri.views.interactive.snapping.FeatureSnappingLayerSource")],I);const Qe=I;let S=class extends H{constructor(e){super(e),this.enabled=!1,this.enabledToggled=!1,this.forceDisabled=!1,this.selfEnabled=!0,this.featureEnabled=!0,this.featureSources=new N,this.distance=V.distance,this.touchSensitivityMultiplier=V.touchSensitivityMultiplier,this.constraintsActive=!1}get effectiveEnabled(){return!this.forceDisabled&&(this.enabledToggled?!this.enabled:this.enabled)}get effectiveSelfEnabled(){return this.effectiveEnabled&&this.selfEnabled}get effectiveFeatureEnabled(){return this.effectiveEnabled&&this.featureEnabled}get _effectiveFeatureSources(){var c;const e=this.featureSources;e.some(Me)&&je.getLogger(this).warnOnce("Do not configure SubtypeGroupLayer sources in SnappingOptions.featureSources directly. Create a FeatureSnappingLayerSource for each SubtypeSublayer.");const t=e.filter(Jt),i=((c=this._get("_effectiveFeatureSources"))==null?void 0:c.filter(Me))??new N;for(const l of t){const d=i.find(h=>h.layer===l.layer.parent);if(d)d.sublayerSources.includes(l)||d.sublayerSources.add(l);else if(l.layer.parent){const h=new Qe({layer:l.layer.parent});h.sublayerSources.add(l),i.add(h)}}for(const l of i){const d=l.sublayerSources.filter(h=>!t.includes(h));l.sublayerSources.removeMany(d)}i.removeMany(i.filter(l=>l.sublayerSources.length===0));const s=e.filter(Bt),r=this._get("_effectiveFeatureSources")??new N,{added:a,removed:o}=nt(r.toArray(),[...s,...i]);return r.removeMany(o),r.addMany(a),r}};p([f()],S.prototype,"enabled",void 0),p([f()],S.prototype,"enabledToggled",void 0),p([f()],S.prototype,"forceDisabled",void 0),p([f()],S.prototype,"selfEnabled",void 0),p([f()],S.prototype,"featureEnabled",void 0),p([f({type:N.ofType(Qe)})],S.prototype,"featureSources",void 0),p([f()],S.prototype,"distance",void 0),p([f()],S.prototype,"touchSensitivityMultiplier",void 0),p([f()],S.prototype,"constraintsActive",void 0),p([f({readOnly:!0})],S.prototype,"effectiveEnabled",null),p([f({readOnly:!0})],S.prototype,"effectiveSelfEnabled",null),p([f({readOnly:!0})],S.prototype,"effectiveFeatureEnabled",null),p([f({readOnly:!0})],S.prototype,"_effectiveFeatureSources",null),S=p([q("esri.views.interactive.snapping.SnappingOptions")],S);const Xt=S;function Me(n){return n.layer.type==="subtype-group"}function Bt(n){return n.layer.type!=="subtype-group"}function Jt(n){return n.layer.type==="subtype-sublayer"}let $=class extends H{get layerView(){var e,t;return(t=(e=this.view)==null?void 0:e.allLayerViews)==null?void 0:t.find(i=>i.layer===this.layer)}get valid(){return this._valid}get subtypeFilter(){var r,a;const{layer:e,snappingSource:t}=this;if(!J(e)||!((r=e.subtypes)!=null&&r.length))return{mode:"not-in-use",filter:null};const i=t.layerSource.sublayerSources.filter(o=>{var c;return o.enabled&&o.layer.visible&&rt((c=this.view)==null?void 0:c.scale,o.layer.effectiveScaleRange.minScale,o.layer.effectiveScaleRange.maxScale)}).map(o=>o.layer.subtypeCode);if(!i.length)return{mode:"none-visible",filter:null};if(i.length===e.subtypes.length)return{mode:"all-visible",filter:null};const s=((a=e.fieldsIndex.get(e.subtypeField))==null?void 0:a.name)??e.subtypeField;return i.length===1?{mode:"in-use",filter:`${s} = ${i.getItemAt(0)}`}:{mode:"in-use",filter:`${s} IN (${i.join(", ")})`}}get floorFilter(){const{view:e,layer:t}=this;return e&&t?at({view:e,layer:t}):null}constructor(e){super(e),this.rulesTable=null,this._valid=!1}initialize(){if(!this.snappingSource||!this.layer)return;const{layer:e,snappingSource:t}=this;if("refresh"in e){const i=e;this.addHandles(i.on("refresh",()=>t.refresh()))}this.loadRules(),this.addHandles([W(()=>t.updating,i=>t.layerSource.updating=i,ge),W(()=>t.availability,i=>t.layerSource.availability=i,ge)])}getFetchCandidatesParameters(e,t,i){var u,y,T,E,m;if(!this.valid)return[];const{layer:s,layerView:r,floorFilter:a,rulesTable:o,subtypeFilter:c}=this,l={distance:i,mode:((u=this.view)==null?void 0:u.type)??"2d",point:e,coordinateHelper:t.coordinateHelper,...this._types,filter:r&&"filter"in r?r.filter:null};if(a&&(l.filter=pe(l.filter,a)),c.mode!=="not-in-use"&&c.mode!=="all-visible"){if(c.mode==="none-visible")return[];l.filter?l.filter.where=qe(l.filter.where,c.mode):l.filter=new ne({where:c.filter})}const d=t.feature,h=((y=d==null?void 0:d.sourceLayer)==null?void 0:y.type)==="subtype-sublayer"?d.sourceLayer.parent:d==null?void 0:d.sourceLayer;if(o&&d&&Ce((T=this.view)==null?void 0:T.map)&&(ce(s)||J(s))&&s.layerId&&(ce(h)||J(h))&&((E=this.view.map.utilityNetworks)!=null&&E.find(x=>x.isUtilityLayer(h)))){if(o.loadStatus!=="loaded")return[];const x=[],X=s.layerId,M=(m=o.getFeatureSQL(h,d))==null?void 0:m[X];if(!M)return[];const B=M.anyVertex;let U=M.endVertex;return U&&B&&U===B&&(U=""),U&&x.push({...l,returnEdge:!1,vertexMode:"ends",filter:pe(l.filter,U)}),B&&x.push({...l,returnEdge:!1,vertexMode:"all",filter:pe(l.filter,B)}),x}return[l]}async loadRules(){var i,s;const{layer:e,view:t}=this;if(e&&t&&Ce(t==null?void 0:t.map)&&(ce(e)||J(e))){const r=(i=t.map.utilityNetworks)==null?void 0:i.find(a=>a.isUtilityLayer(e));if(r)try{this.rulesTable=await r.getRulesTable(),await((s=this.rulesTable)==null?void 0:s.load())}catch{return void je.getLogger("esri.views.interactive.snapping.FeatureSnappingSourceInfo").error("Failed to load rules table for snapping source",e.title)}}this._valid=!0}get _types(){return{returnEdge:!0,vertexMode:"all"}}remove(){this.destroy()}destroy(){var e;(e=this.snappingSource)==null||e.destroy()}};function pe(n,e){return n==null?new ne({where:e}):n.where?new ne({where:qe(n.where,e)}):new ne({where:e})}p([f({constructOnly:!0})],$.prototype,"layer",void 0),p([f({constructOnly:!0})],$.prototype,"snappingSource",void 0),p([f({constructOnly:!0})],$.prototype,"view",void 0),p([f()],$.prototype,"layerView",null),p([f()],$.prototype,"rulesTable",void 0),p([f()],$.prototype,"valid",null),p([f()],$.prototype,"subtypeFilter",null),p([f()],$.prototype,"floorFilter",null),p([f()],$.prototype,"_valid",void 0),$=p([q("esri.views.interactive.snapping.FeatureSnappingSourceInfo")],$);class k{constructor(e,t,i,s){this.targetPoint=e,this.constraint=t,this.isDraped=i,this.domain=s}}let xe=class extends k{constructor({targetPoint:e,objectId:t,constraint:i,isDraped:s}){super(e,i,s,P.FEATURE),this.objectId=t}},Kt=class extends xe{constructor(e){super({...e,isDraped:!0,constraint:new Rt(e.edgeStart,e.edgeEnd,e.getGroundElevation)})}get hints(){return[new C(L.REFERENCE,this.constraint.start,this.constraint.end,this.isDraped,this.domain)]}},Ye=class extends xe{constructor(e){super({...e,constraint:new bt(e.edgeStart,e.edgeEnd)})}get hints(){return[new C(L.REFERENCE,this.constraint.start,this.constraint.end,this.isDraped,this.domain)]}};class Te extends k{constructor({targetPoint:e,constraint:t,previousVertex:i,otherVertex:s,otherVertexType:r,objectId:a,isDraped:o}){super(e,t,o,P.SELF),this.previousVertex=i,this.otherVertex=s,this.otherVertexType=r,this.objectId=a}get hints(){const e=this.previousVertex,t=this.otherVertexType===j.CENTER?this.otherVertex:this.targetPoint,i=this.otherVertexType===j.CENTER?this.targetPoint:this.otherVertex;return[new C(L.TARGET,t,i,this.isDraped,this.domain),new C(L.REFERENCE,e,t,this.isDraped,this.domain),new ke(this.previousVertex,t,i,this.isDraped,this.domain)]}}var j;(function(n){n[n.NEXT=0]="NEXT",n[n.CENTER=1]="CENTER"})(j||(j={}));let D=class extends H{get updating(){return this._snappingSources.some(e=>e==null||e.valid&&e.snappingSource.updating)||this._updatingHandles.updating}constructor(e){super(e),this.options=null,this._domain=P.FEATURE,this._updatingHandles=new ot,this._sourceModules={featureService:{module:null,loader:null},featureCollection:{module:null,loader:null},graphics:{module:null,loader:null},notes:{module:null,loader:null},scene:{module:null,loader:null}}}initialize(){const e=lt(()=>{var t;return(t=this.options)==null?void 0:t._effectiveFeatureSources},(t,i)=>this._createSourceInfo(t,i));this._snappingSources=e,this.addHandles(ct(e))}destroy(){this._set("options",null),this._updatingHandles.destroy()}async fetchCandidates(e,t,i,s){var c;if(!(t&this._domain&&this.options!=null&&this.options.effectiveFeatureEnabled))return[];const r=[],a=this._computeScreenSizeDistanceParameters(e,i);for(const l of this._snappingSources){if(l==null||!l.valid||!l.snappingSource.layerSource.enabled||(c=l.layerView)!=null&&c.suspended)continue;const d=l.getFetchCandidatesParameters(e,i,a);for(const h of d)r.push(l.snappingSource.fetchCandidates(h,s).then(u=>u.filter(y=>!this._candidateIsExcluded(l.snappingSource,y,i.excludeFeature))))}const o=(await dt(r)).flat();return this._addRightAngleCandidates(o,e,a,i),de(s),_e(e,o),o}_addRightAngleCandidates(e,t,i,s){var h,u,y,T,E,m,x,X;const r=s.vertexHandle!=null?(u=(h=s.vertexHandle.rightEdge)==null?void 0:h.rightVertex)==null?void 0:u.pos:s.editGeometryOperations!=null&&s.editGeometryOperations.data.type==="polygon"?(T=(y=s.editGeometryOperations.data.components[0])==null?void 0:y.getFirstVertex())==null?void 0:T.pos:null,a=s.vertexHandle!=null?(m=(E=s.vertexHandle.leftEdge)==null?void 0:E.leftVertex)==null?void 0:m.pos:s.editGeometryOperations!=null?(X=(x=s.editGeometryOperations.data.components[0])==null?void 0:x.getLastVertex())==null?void 0:X.pos:null,{view:o}=this,c=v(r,o,s),l=v(a,o,s),d=e.length;for(let M=0;M<d;M++)this._addRightAngleCandidate(e[M],l,t,i,e),this._addRightAngleCandidate(e[M],c,t,i,e)}_addRightAngleCandidate(e,t,i,s,r){if(t==null||!Qt(e))return;const a=e.constraint.closestTo(t),o=(a[0]-i[0])/s.x,c=(a[1]-i[1])/s.y,{start:l,end:d}=e.constraint;if(o*o+c*c<=1){const h=new Te({targetPoint:a,otherVertex:t,otherVertexType:j.NEXT,previousVertex:Z(g(a),g(l))>Z(g(a),g(d))?l:d,constraint:new Ue(t,a),objectId:e.objectId,isDraped:e.isDraped});r.push(h)}}_computeScreenSizeDistanceParameters(e,t){let i=this.options!=null?this.options.distance*(t.pointer==="touch"?this.options.touchSensitivityMultiplier:1):0;return this.view==null?{x:i,y:i,z:i,distance:i}:this.view.type==="2d"?(i*=this.view.resolution,{x:i,y:i,z:i,distance:i}):this._computeScreenSizeDistanceParameters3D(e,i,this.view,t)}_computeScreenSizeDistanceParameters3D(e,t,i,s){const{spatialReference:r}=s;i.renderCoordsHelper.toRenderCoords(e,r,Ie);const a=i.state.camera.computeScreenPixelSizeAt(Ie),o=a*i.renderCoordsHelper.unitInMeters,c=o/He(r),l=o/ht(r),d=t*c,h=t*l,u=w(e,r,_,i),y=u?ue(u,e,c,0,0,i,s):0,T=u?ue(u,e,0,c,0,i,s):0,E=u?ue(u,e,0,0,l,i,s):0;return{x:y===0?0:d/y,y:T===0?0:d/T,z:E===0?0:h/E,distance:a*t}}_candidateIsExcluded(e,t,i){if(i==null)return!1;const s=this._getCandidateObjectId(t);if(s==null)return!1;const r=e.layerSource.layer;return r.type==="graphics"?i.uid===s:i.sourceLayer===r&&!(!i.attributes||!("objectIdField"in r))&&i.attributes[r.objectIdField]===s}_getCandidateObjectId(e){return e instanceof xe?e.objectId:null}async _createSourceInfo(e,t){const i=e.layer;i.loaded||(await i.load(),de(t));const{view:s}=this,r=await this._createFeatureSnappingSourceType(e);return de(t),new $(r==null?{}:{snappingSource:r,view:s,layer:i})}async _createFeatureSnappingSourceType(e){switch(e.layer.type){case"feature":case"geojson":case"csv":case"oriented-imagery":case"subtype-group":case"wfs":return this._createFeatureSnappingSourceFeatureLayer(e);case"graphics":return this._createFeatureSnappingSourceGraphicsLayer(e);case"map-notes":return this._createFeatureSnappingSourceMapNotesLayer(e);case"scene":case"building-scene":return this._createFeatureSnappingSourceSceneLayer(e)}return null}async _createFeatureSnappingSourceSceneLayer(e){const{view:t}=this;return t==null||t.type!=="3d"?null:new(await this._getSourceModule("scene")).SceneLayerSnappingSource({layerSource:e,view:t})}async _createFeatureSnappingSourceFeatureLayer(e){var t;switch((t=e.layer.source)==null?void 0:t.type){case"feature-layer":case"oriented-imagery":return new(await this._getSourceModule("featureService")).FeatureServiceSnappingSource({spatialReference:this.spatialReference,view:this.view,layerSource:e});case"memory":case"csv":case"geojson":case"wfs":return e.layer.geometryType==="mesh"?null:new(await this._getSourceModule("featureCollection")).FeatureCollectionSnappingSource({layerSource:e,view:this.view})}return null}async _createFeatureSnappingSourceGraphicsLayer(e){return new(await this._getSourceModule("graphics")).GraphicsSnappingSource({getGraphicsLayers:()=>[e.layer],spatialReference:this.spatialReference,view:this.view,layerSource:e})}async _createFeatureSnappingSourceMapNotesLayer(e){return new(await this._getSourceModule("notes")).GraphicsSnappingSource({getGraphicsLayers:()=>{var t;return((t=e.layer.sublayers)==null?void 0:t.toArray())??[]},spatialReference:this.spatialReference,view:this.view,layerSource:e})}async _getSourceModule(e){const t=this._sourceModules[e];if(t.loader==null){const i=this._loadSourceModule(e),s={module:null,loader:i};this._sourceModules[e]=s;const r=await i,a={module:r,loader:i};return this._sourceModules[e]=a,r}return t.module==null?t.loader:t.module}_loadSourceModule(e){const t=this._updatingHandles;switch(e){case"featureService":return t.addPromise(K(()=>import("./FeatureServiceSnappingSource-BsR_DWGA.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16])));case"featureCollection":return t.addPromise(K(()=>import("./FeatureCollectionSnappingSource-D9JDQoWL.js"),__vite__mapDeps([17,1,2,3,4,5,6,7,8,9,10,18,12,13,14,15,16])));case"graphics":case"notes":return t.addPromise(K(()=>import("./GraphicsSnappingSource-C1JGV5dF.js"),__vite__mapDeps([19,1,2,3,20,21,22,23,24,25,26,27,28,29,30,31,32,33,4,5,6,7,8,9,10,18,12,13,14,15,16])));case"scene":return t.addPromise(K(()=>import("./SceneLayerSnappingSource-BIH6oaro.js"),__vite__mapDeps([34,1,2,4,5,6,7,9,10,12,13,14,15,16])))}}get test(){return{snappingSources:this._snappingSources}}};function Qt(n){return(n instanceof Ye||n instanceof Kt)&&!Yt(n)}function Yt({constraint:{start:n,end:e}}){const t=pt(n,e),i=Z(g(n),g(e));return t<ut()||i/t<ti}function ue(n,e,t,i,s,r,{spatialReference:a}){const o=ft(ei,e);o[0]+=t,o[1]+=i,o[2]+=s;const c=w(o,a,_,r);return c?Ct(c,n):1/0}p([f({constructOnly:!0})],D.prototype,"spatialReference",void 0),p([f({constructOnly:!0})],D.prototype,"view",void 0),p([f()],D.prototype,"options",void 0),p([f({readOnly:!0})],D.prototype,"updating",null),p([f()],D.prototype,"_snappingSources",void 0),D=p([q("esri.views.interactive.snapping.FeatureSnappingEngine")],D);const Ie=R(),ei=R(),ti=1e-4;class le{constructor(e,t){this.view=e,this.options=t,this.squaredShortLineThreshold=V.shortLineThreshold*V.shortLineThreshold}snap(e,t){return t.vertexHandle!=null?t.vertexHandle.type!=="vertex"?[]:this.snapExistingVertex(e,t):this.snapNewVertex(e,t)}edgeExceedsShortLineThreshold(e,t){return this.exceedsShortLineThreshold(v(e.leftVertex.pos,this.view,t),v(e.rightVertex.pos,this.view,t),t)}exceedsShortLineThreshold(e,t,{spatialReference:i}){return this.squaredShortLineThreshold===0||G(w(t,i,_,this.view),w(e,i,_,this.view))>this.squaredShortLineThreshold}isVertical(e,t,{spatialReference:i}){const s=He(i);return ye(g(e),g(t))*s<V.verticalLineThresholdMeters}squaredProximityThreshold(e){return e==="touch"?this._squaredTouchProximityThreshold:this._squaredMouseProximityThreshold}get _squaredMouseProximityThreshold(){return this.options.distance*this.options.distance}get _squaredTouchProximityThreshold(){const{distance:e,touchSensitivityMultiplier:t}=this.options,i=e*t;return i*i}}let et=class extends k{constructor({lineStart:e,lineEnd:t,targetPoint:i,isDraped:s}){super(i,new We(e,t),s,P.SELF),this._referenceLineHint=new C(L.REFERENCE_EXTENSION,e,t,s,this.domain)}get hints(){return[this._referenceLineHint,new C(L.TARGET,this._lineEndClosestToTarget(),this.targetPoint,this.isDraped,this.domain)]}_lineEndClosestToTarget(){return this.constraint.closestEndTo(this.targetPoint)}},ii=class extends le{snapNewVertex(e,t){const i=t.editGeometryOperations.data.components[0],s=i.edges.length,r=[];if(s<1)return r;const{spatialReference:a}=t,o=w(e,a,_,this.view),{view:c}=this,l=i.edges[s-1];let d=l;do{if(this.edgeExceedsShortLineThreshold(d,t)){const h=re(d,c,t);this._processCandidateProposal(h.left,h.right,e,o,t,r)}d=d.leftVertex.leftEdge}while(d&&d!==l);return r}snapExistingVertex(e,t){const i=[],s=t.vertexHandle,r=s.component;if(r.edges.length<2)return i;const{view:a}=this,{spatialReference:o}=t,c=w(e,o,_,a),l=s.leftEdge,d=s.rightEdge;l&&d&&this.edgeExceedsShortLineThreshold(l,t)&&this.edgeExceedsShortLineThreshold(d,t)&&this._processCandidateProposal(v(l.leftVertex.pos,a,t),v(d.rightVertex.pos,a,t),e,c,t,i);const h=r.edges[0];let u=h;do{if(u!==s.leftEdge&&u!==s.rightEdge&&this.edgeExceedsShortLineThreshold(u,t)){const y=re(u,a,t);this._processCandidateProposal(y.left,y.right,e,c,t,i)}u=u.rightVertex.rightEdge}while(u&&u!==h);return i}_processCandidateProposal(e,t,i,s,r,a){var h;const{spatialReference:o,pointer:c}=r,l=R();this._projectedLine(l,e,t,i,r);const d=oe(l);G(s,w(d,o,_,this.view))<this.squaredProximityThreshold(c)&&a.push(new et({lineStart:e,lineEnd:t,targetPoint:d,isDraped:((h=r.elevationInfo)==null?void 0:h.mode)==="on-the-ground"}))}_projectedLine(e,t,i,s,r){this._projectToLineGeodesic(e,t,i,s,r)||this._projectToLinePlanar(e,s,t,i)}_projectToLineGeodesic(e,t,i,s,{spatialReference:r}){const a=ae(t,i,r,r);if(a==null)return!1;const o=ae(i,s,r,r);if(o==null)return!1;const c=Ee(i,s,r);if(c==null)return!1;const l=Math.abs(gt.shortestSignedDiff(a,o))>Math.PI/2?Ge.normalize(a+Math.PI):a;return Ze(e,i,r,Xe(c,"meters"),Be(l,"radians","geographic"),"geodesic"),e[2]=s[2],!0}_projectToLinePlanar(e,t,i,s){Lt(t,{start:i,end:s,type:At.LINE},e),e[2]=t[2]}},tt=class extends k{constructor({referenceLine:e,lineStart:t,targetPoint:i,isDraped:s}){const r=yt(t),{left:a,right:o}=e;ze(r,vt(r,r,o),a),super(i,new We(t,oe(r)),s,P.SELF),this._referenceLines=[{edge:e,fadeLeft:!0,fadeRight:!0}]}get hints(){return[new C(L.TARGET,this.constraint.start,this.targetPoint,this.isDraped,this.domain),new Ft(this.constraint.start,this.targetPoint,this.isDraped,this.domain),...this._referenceLines.map(e=>new C(L.REFERENCE,e.edge.left,e.edge.right,this.isDraped,this.domain,e.fadeLeft,e.fadeRight))]}addReferenceLine(e){const t={edge:e,fadeLeft:!0,fadeRight:!0};this._referenceLines.forEach(i=>{Q(e.right,i.edge.left)&&(i.fadeLeft=!1,t.fadeRight=!1),Q(e.right,i.edge.right)&&(i.fadeRight=!1,t.fadeRight=!1),Q(e.left,i.edge.right)&&(i.fadeRight=!1,t.fadeLeft=!1),Q(e.left,i.edge.left)&&(i.fadeLeft=!1,t.fadeLeft=!1)}),this._referenceLines.push(t)}},si=class extends le{snapNewVertex(e,t){const i=t.editGeometryOperations.data.components[0],s=i.edges.length,r=i.vertices.length,a=[];if(s<2)return a;const{view:o}=this,c=w(e,t.spatialReference,_,o),l=v(i.vertices[r-1].pos,o,t),d=v(i.vertices[0].pos,o,t),h=i.edges[s-1];let u=h;do{if(this.edgeExceedsShortLineThreshold(u,t)){const y=re(u,o,t);this._checkEdgeForParallelLines(y,l,e,c,t,a),this._checkEdgeForParallelLines(y,d,e,c,t,a)}u=u.leftVertex.leftEdge}while(u&&u!==h);return a}snapExistingVertex(e,t){const i=[],s=t.vertexHandle,r=s.component;if(r.edges.length<3)return i;const{view:a}=this,o=w(e,t.spatialReference,_,a),c=s.leftEdge,l=s.rightEdge,d=r.vertices[0],h=v(d.pos,a,t),u=r.vertices.length,y=r.vertices[u-1],T=v(y.pos,a,t),E=r.edges[0];let m=E;do{if(m!==c&&m!==l&&this.edgeExceedsShortLineThreshold(m,t)){const x=re(m,a,t);c&&this._checkEdgeForParallelLines(x,v(c.leftVertex.pos,a,t),e,o,t,i),l&&this._checkEdgeForParallelLines(x,v(l.rightVertex.pos,a,t),e,o,t,i),s===d?this._checkEdgeForParallelLines(x,T,e,o,t,i):s===y&&this._checkEdgeForParallelLines(x,h,e,o,t,i)}m=m.rightVertex.rightEdge}while(m&&m!==E);return i}_checkEdgeForParallelLines(e,t,i,s,r,a){var u;const o=e.left,c=e.right;if(he(O,g(t),g(o),g(c)),Z(O,g(t))<V.parallelLineThreshold)return;he(O,g(i),g(o),g(c),g(t));const{spatialReference:l,pointer:d}=r,h=Se(O[0],O[1],i[2]);if(G(s,w(h,l,_,this.view))<this.squaredProximityThreshold(d)){if(this.isVertical(h,t,r)||this.isVertical(o,c,r)||this._parallelToPreviousCandidate(e,a))return;a.push(new tt({referenceLine:e,lineStart:t,targetPoint:h,isDraped:((u=r.elevationInfo)==null?void 0:u.mode)==="on-the-ground"}))}}_parallelToPreviousCandidate(e,t){const i=e.left,s=e.right;for(const r of t)if(he(O,g(s),g(r.constraint.start),g(r.constraint.end),g(i)),Z(O,g(s))<V.parallelLineThreshold)return r.addReferenceLine(e),!0;return!1}};const O=ve();class ni extends le{snapNewVertex(e,t){const i=t.editGeometryOperations.data.components[0],s=[];if(i.vertices.length<2)return s;const{view:r}=this,a=w(e,t.spatialReference,_,r),o=i.vertices.at(-1);this._checkForSnappingCandidate(s,o.leftEdge,o,o.leftEdge.leftVertex,e,a,t);const c=i.vertices[0];return this._checkForSnappingCandidate(s,c.rightEdge,c,c.rightEdge.rightVertex,e,a,t),s}snapExistingVertex(e,t){const i=[],s=t.vertexHandle;if(s.component.vertices.length<3)return i;const{view:r}=this,a=w(e,t.spatialReference,_,r),o=s.leftEdge,c=s.rightEdge;if(o!=null&&o.leftVertex.leftEdge){const l=o.leftVertex.leftEdge;this._checkForSnappingCandidate(i,l,l.rightVertex,l.leftVertex,e,a,t)}if(c!=null&&c.rightVertex.rightEdge){const l=c.rightVertex.rightEdge;this._checkForSnappingCandidate(i,l,l.leftVertex,l.rightVertex,e,a,t)}return i}_checkForSnappingCandidate(e,t,i,s,r,a,o){if(!this.edgeExceedsShortLineThreshold(t,o))return;const c=this.view,l=v(i.pos,c,o),d=v(s.pos,c,o);this._checkForSnappingCandidateNormalized(e,d,l,r,a,o)}_checkForSnappingCandidateNormalized(e,t,i,s,r,a){this._projectionRay(De,t,i,s,a),this._checkForSnappingCandidateAlongProjectedRay(e,t,i,De,s,r,a)}_projectionRay(e,t,i,s,r){this._projectionRayGeodesic(e,t,i,s,r)||this._projectionRayPlanar(e,t,i)}_projectionRayGeodesic(e,t,i,s,{spatialReference:r}){const a=ae(t,i,r,r);if(a==null)return!1;const o=ae(i,s,r,r);if(o==null)return!1;const c=Math.sign(Ge.shortestSignedDiff(a,o))*Math.PI*.5,l=Be(a+c,"radians","geographic"),d=R(),h=Ee(i,s,r);return h!=null&&(Ze(d,i,r,Xe(h,"meters"),l,"geodesic"),ze(e,d,i),!0)}_projectionRayPlanar(e,t,i){const s=Pe(fe,g(i),g(t));Ae(e,s[1],-s[0],0)}_checkForSnappingCandidateAlongProjectedRay(e,t,i,s,r,a,o){var E;const{spatialReference:c,pointer:l}=o,d=Pe(fe,g(r),g(i)),h=_t(s,d)/St(s),u=wt(fe,g(i),s,h),y=Se(u[0],u[1],r[2]);if(G(a,w(y,c,_,this.view))>this.squaredProximityThreshold(l)||this.isVertical(y,i,o)||this.isVertical(i,t,o))return;const T=Et(R(),i,s,Math.sign(h));e.push(new Te({targetPoint:y,constraint:new Ue(i,oe(T)),previousVertex:t,otherVertex:i,otherVertexType:j.CENTER,isDraped:((E=o.elevationInfo)==null?void 0:E.mode)==="on-the-ground"}))}}const fe=ve(),De=R();class ri extends k{constructor({targetPoint:e,point1:t,point2:i,isDraped:s}){super(e,new Vt(oe(mt(R(),t,i,.5)),.5*ye(g(t),g(i))),s,P.SELF),this._p1=t,this._p2=i}get hints(){return[new C(L.REFERENCE,this.targetPoint,this._p1,this.isDraped,this.domain),new C(L.REFERENCE,this.targetPoint,this._p2,this.isDraped,this.domain),new ke(this._p1,this.targetPoint,this._p2,this.isDraped,this.domain)]}}class ai extends le{snapNewVertex(e,t){const i=t.editGeometryOperations.data.components[0],s=[],r=i.vertices.length;if(t.editGeometryOperations.data.type!=="polygon"||r<2)return s;const{view:a}=this,o=i.vertices[0],c=i.vertices[r-1],l=v(o.pos,a,t),d=v(c.pos,a,t);return this._processCandidateProposal(l,d,e,t,s),s}snapExistingVertex(e,t){const i=[],s=t.vertexHandle,r=s.component;if(r.edges.length<2||t.editGeometryOperations.data.type==="polyline"&&(s.index===0||s.index===r.vertices.length-1))return i;const{view:a}=this,o=v(s.leftEdge.leftVertex.pos,a,t),c=v(s.rightEdge.rightVertex.pos,a,t);return this._processCandidateProposal(o,c,e,t,i),i}_processCandidateProposal(e,t,i,s,r){var y;if(!this.exceedsShortLineThreshold(e,t,s))return;const a=xt(Oe,g(e),g(t),.5),o=.5*ye(g(e),g(t)),c=Nt(Oe,g(i),a,o),l=Se(c[0],c[1],i[2]),{spatialReference:d,pointer:h}=s,u=w(i,d,_,this.view);if(G(u,w(l,d,_,this.view))<this.squaredProximityThreshold(h)){if(this.isVertical(e,l,s)||this.isVertical(l,t,s))return;r.push(new ri({targetPoint:l,point1:e,point2:t,isDraped:((y=s.elevationInfo)==null?void 0:y.mode)==="on-the-ground"}))}}}const Oe=ve();let A=class extends H{constructor(n){super(n),this.updating=!1,this._snappers=new N,this._domain=P.SELF}initialize(){this._snappers.push(new si(this.view,this.options),new ii(this.view,this.options),new ni(this.view,this.options),new ai(this.view,this.options))}set options(n){this._set("options",n);for(const e of this._snappers)e.options=n}async fetchCandidates(n,e,t){if(!(e&this._domain&&this.options.effectiveSelfEnabled))return[];const i=[];for(const s of this._snappers.items)for(const r of s.snap(n,t))i.push(r);return _e(n,i),i}};p([f({readOnly:!0})],A.prototype,"updating",void 0),p([f({constructOnly:!0})],A.prototype,"view",void 0),p([f()],A.prototype,"options",null),A=p([q("esri.views.interactive.snapping.SelfSnappingEngine")],A);function oi(n,e){return[new A({view:n,options:e}),new D({view:n,options:e,spatialReference:n.spatialReference})]}class ie extends k{constructor(e,t,i,s){super(e,new Mt(e),s,P.ALL),this.first=t,this.second=i}get hints(){return this.first.targetPoint=this.targetPoint,this.second.targetPoint=this.targetPoint,[...this.first.hints,...this.second.hints,new It(this.targetPoint,this.isDraped,this.domain)]}}let b=class extends Tt.EventedMixin(H){constructor(n){super(n),this.options=new Xt,this.snappingEnginesFactory=oi,this._engines=[],this._currentMainCandidate=null,this._currentOtherActiveCandidates=[],this._currentSnappedType=F.MAIN}initialize(){this.addHandles([W(()=>{const{effectiveFeatureEnabled:n,effectiveSelfEnabled:e,touchSensitivityMultiplier:t,distance:i,constraintsActive:s}=this.options;return{effectiveFeatureEnabled:n,effectiveSelfEnabled:e,touchSensitivityMultiplier:t,distance:i,constraintsActive:s}},()=>{this.doneSnapping(),this.emit("changed")},Re),W(()=>this.options,n=>{for(const e of this._engines)e.options=n},Re),W(()=>({viewReady:this.view.ready,viewSpatialReference:this.view.spatialReference,snappingEnginesFactory:this.snappingEnginesFactory}),({viewReady:n,snappingEnginesFactory:e})=>this._recreateEngines(n,e),ge)])}destroy(){this._destroyEngines()}get updating(){return this._engines.some(n=>n.updating)}_recreateEngines(n,e){if(this._destroyEngines(),!n)return;const{view:t,options:i}=this;this._engines=e(t,i)}_destroyEngines(){for(const n of this._engines)n.destroy();this._engines=[]}get _squaredMouseProximityThreshold(){return this.options.distance*this.options.distance}get _squaredTouchProximityThreshold(){const{distance:n,touchSensitivityMultiplier:e}=this.options,t=n*e;return t*t}get _squaredSatisfiesConstraintThreshold(){return V.satisfiesConstraintScreenThreshold*V.satisfiesConstraintScreenThreshold}snap(n){return li(n)?this._snapMultiPoint(n):this._snapSinglePoint(n)}update(n){const{point:e,context:t}=n;this._removeVisualization();const i=this._currentMainCandidate;if(i==null)return e;const s=this._selectUpdateInput(n);if(s==null)return e;const{spatialReference:r}=t,a=be(s,r);if(a==null)return e;const{view:o}=this,{elevationInfo:c,visualizer:l}=t,d=[],h=Y(a,o,c),u=i.constraint.closestTo(h);if(!this._arePointsWithinScreenThreshold(h,u,t))return this._resetSnappingState(),e;i.targetPoint=u,d.push(...i.hints);for(const y of this._currentOtherActiveCandidates)y.targetPoint=u,d.push(...y.hints);return l!=null&&this.addHandles(l.draw(d,{spatialReference:r,elevationInfo:ci(t),view:o,selfSnappingZ:t.selfSnappingZ}),se),Le(u,o,e,t)}doneSnapping(){this._removeVisualization(),this._resetSnappingState()}_selectUpdateInput({point:n,scenePoint:e}){switch(this._currentSnappedType){case F.MAIN:return n;case F.SCENE:return e}}_resetSnappingState(){this._currentMainCandidate=null,this._currentOtherActiveCandidates=[],this._currentSnappedType=F.MAIN}_removeVisualization(){this.removeHandles(se)}async _snapSinglePoint({point:n,context:e,signal:t}){const{view:i}=this,{elevationInfo:s}=e,r=Y(n,i,s),a=await this._fetchCandidates(r,P.ALL,e,t);return this._createSnapResult(r,F.MAIN,a,i,n,e,t)}async _snapMultiPoint({point:n,scenePoint:e,context:t,signal:i}){const{view:s}=this,{coordinateHelper:r,elevationInfo:a,spatialReference:o}=t;await $t(e.spatialReference,o);const c=be(e,o),l=Y(c,s,a),d=await this._fetchCandidates(l,P.FEATURE,t,i);if(d.length>0){const y=await this._fetchCandidates(l,P.SELF,t,i);return this._createSnapResult(l,F.SCENE,[...d,...y],s,c,t,i)}const h=Y(n,s,a),u=await this._fetchCandidates(h,P.SELF,t,i);return this._createSnapResult(h,F.MAIN,u,s,{z:r.hasZ()&&n.hasZ?n.z??0:void 0,m:r.hasM()&&n.hasM?n.m??0:void 0},t,i)}async _fetchCandidates(n,e,t,i){return(await Promise.all(this._engines.map(s=>s.fetchCandidates(n,e,t,i)))).flat()}_createSnapResult(n,e,t,i,s,r,a){return{get valid(){return!Pt(a)},apply:()=>{const{spatialReference:o}=r,{snappedPoint:c,hints:l}=this._processCandidates(n,e,t,r);return this._removeVisualization(),r.visualizer!=null&&this.addHandles(r.visualizer.draw(l,{spatialReference:o,elevationInfo:_,view:i,selfSnappingZ:r.selfSnappingZ}),se),Le(c,i,s,r)}}}_processCandidates(n,e,t,i){if(t.length<1)return this.doneSnapping(),{snappedPoint:n,hints:[]};this._currentSnappedType!==e&&this._resetSnappingState(),_e(n,t);const s=this._currentMainCandidate;if(s!=null){const r=this._findOldConstraintInNewCandidates(s,t);if(r>=0){if(!(t[r]instanceof ie))return this._intersectWithOtherCandidates(r,t,n,e,i);if(this._arePointsWithinScreenThreshold(n,s.targetPoint,i))return this._updateSnappingCandidate(s,e,t,i)}}return this._intersectWithOtherCandidates(0,t,n,e,i)}_findOldConstraintInNewCandidates(n,e){return n instanceof ie?this._findOldCandidateIndex(e,n.first)>=0&&this._findOldCandidateIndex(e,n.second)>=0?0:-1:this._findOldCandidateIndex(e,n)}_intersectWithOtherCandidates(n,e,t,i,s){const{coordinateHelper:r}=s,a=e[n],o=[];for(let c=0;c<e.length;++c){if(c===n)continue;const l=e[c],d=a.constraint.intersect(l.constraint);if(d)for(const h of d.closestPoints(a.targetPoint))o.push([new ie(h,a,l,l.isDraped),this._squaredScreenDistance(t,h,r)])}return o.length>0&&(o.sort((c,l)=>c[1]-l[1]),o[0][1]<this._squaredPointProximityThreshold(s.pointer))?this._updateSnappingCandidate(o[0][0],i,e,s):this.options.constraintsActive&&(a instanceof et||a instanceof Ye||a instanceof Te||a instanceof tt)?{snappedPoint:t,hints:[]}:this._updateSnappingCandidate(a,i,e,s)}_updateSnappingCandidate(n,e,t,i){this.doneSnapping(),this._currentMainCandidate=n,this._currentSnappedType=e;const s=this._currentMainCandidate.targetPoint,r=[];r.push(...n.hints);for(const a of t){if(n instanceof ie){if(a.constraint.equals(n.first.constraint)||a.constraint.equals(n.second.constraint))continue}else if(a.constraint.equals(n.constraint))continue;const o=a.constraint.closestTo(s);this._squaredScreenDistance(o,s,i.coordinateHelper)<this._squaredSatisfiesConstraintThreshold&&(a.targetPoint=s,this._currentOtherActiveCandidates.push(a),r.push(...a.hints))}return{snappedPoint:s,hints:r}}_squaredPointProximityThreshold(n){return n==="touch"?this._squaredTouchProximityThreshold:this._squaredMouseProximityThreshold}_arePointsWithinScreenThreshold(n,e,t){return this._squaredScreenDistance(n,e,t.coordinateHelper)<this._squaredPointProximityThreshold(t.pointer)}_squaredScreenDistance(n,e,t){return G(this._toScreen(n,t),this._toScreen(e,t))}_toScreen(n,e){return w(n,e.spatialReference,_,this.view)}_findOldCandidateIndex(n,e){let t=-1;for(let i=0;i<n.length;++i)if(e.constraint.equals(n[i].constraint)){t=i;break}return t}get test(){return{visualizationsActive:this.hasHandles(se),engines:this._engines}}};var F;p([f({constructOnly:!0})],b.prototype,"view",void 0),p([f()],b.prototype,"options",void 0),p([f({readOnly:!0})],b.prototype,"updating",null),p([f()],b.prototype,"snappingEnginesFactory",void 0),p([f()],b.prototype,"_engines",void 0),p([f()],b.prototype,"_squaredMouseProximityThreshold",null),p([f()],b.prototype,"_squaredTouchProximityThreshold",null),p([f()],b.prototype,"_squaredSatisfiesConstraintThreshold",null),b=p([q("esri.views.interactive.snapping.SnappingManager")],b),function(n){n[n.MAIN=0]="MAIN",n[n.SCENE=1]="SCENE"}(F||(F={}));const se="visualization-handle";function li(n){return n.scenePoint!=null}function ci({coordinateHelper:n,elevationInfo:e}){return n.hasZ()?_:e}export{D as I,Ye as a,Xt as b,Qe as c,b as j,Si as l,xe as n,_i as p,Kt as r,Ee as u};
