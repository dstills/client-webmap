import{eF as j,t7 as ae,t8 as E,g7 as V,dB as K,dj as le,d8 as pe,t9 as ce,cS as g,mr as he,ta as R,tb as ue,p$ as de,tc as P,td as T,te as N,tf as me,mp as ge,tg as fe,mq as ve,th as ye,ti as _e,tj as xe,tk as X,tl as we,j9 as Te,S as Se,f as Ce,tm as Y,qr as be,hN as Pe,ar as C,s7 as Me,u as I,aH as k,hR as J,d2 as z,g as c,gU as Ve,tn as Re,at as A,y as h,i as Ie,be as $e,bU as Oe,dy as Ze,e9 as Q,qs as ee,d1 as te,dv as De,cF as w,to as G,tp as Ee,tq as He,iB as L,tr as $,d9 as Fe,dc as We,dk as ke,dl as ze,ts as Ae,tt as Ge,iA as B,v as Le}from"./index-BhDz4nJ7.js";import{t as U}from"./memoize-DsJmrG76.js";import{a as O,i as Z}from"./dehydratedFeatureComparison-pSIF2X6o.js";import{P as Be,V as Ue,p as qe,l as je}from"./EditGeometryOperations-DW-unpVk.js";import{x as D,Z as Ke}from"./InteractiveToolBase-DAZZuFBn.js";import{e as q}from"./SnappingContext-Cpn1WUY8.js";import{f as Ne}from"./SnappingDragPipelineStep-DWW1tTUQ.js";import{p as Xe}from"./SnappingOperation-CA7oDjr4.js";const _t=["freehand","hybrid","click"],ne="click";class Ye{constructor({consumesClicks:e,grabbableForEvent:n}){this.events=new j,this.interactive=!0,this.selectable=!1,this.cursor=null,this.grabbable=!0,this.consumesClicks=e,this.grabbableForEvent=n}destroy(){}intersectionDistance(e,n){return 0}attach(){}detach(){}onElevationChange(){}onViewChange(){}}function xt(t,e,n,i,o,r){let l="geodesic",s=ae(n);const a=E(t,e,i);return a[2]=0,s&&V(a,n,a,s)||(l="euclidean",s=n),{mode:l,view:e,elevationInfo:i,hasZ:o,directionMode:r,spatialReference:t.spatialReference,measurementSR:s,origin:a}}function Je(t,e,n){if(e==null||t==null)return;const i=he(n.measurementSR);if(i==null)return;const o=F(t,n);if(o==null)return;const r=R(e,i);return new ue(de(o),r)}function Qe(t,e,n,i){if(n==null||t==null)return;const o=F(t,i);if(o==null)return;const r=P(n),l=10,s=u=>{if(u==null)return;const d=g(),f=ye(u,"degrees","geographic");return _e(d,o,i.measurementSR,l,f,i.mode)?new xe(o,d):void 0},a=()=>{if(e!=null&&t!=null)return P(X(e,t))};switch(i.directionMode){case T.Absolute:return s(r);case T.Relative:{const u=a();return u==null?void 0:s(u+r)}case T.RelativeBilateral:{const u=a();return u==null?void 0:N([s(u+r),s(u-r)])}}}function H(t,e){const n=st(t,e);return n!=null?new me(n):void 0}function ie(t,e,n,i,o,r){if(n==null&&i==null&&o==null)return;if(e==null)return H(i,r);const{view:l,elevationInfo:s,measurementSR:a}=r,u=E(e,l,s);if(!a||!V(u,e.spatialReference,b,a))return;const d=[b[0],b[1]],f=n!=null?R(n,"meters"):void 0,v=rt(i,r),y=P(o),_=m=>{const x=new we(d,a,f,v,m);return f==null||m==null||v==null&&r.hasZ?x:new Te(x.closestTo(u))};if(y==null)return _(void 0);const S=()=>{if(t!=null&&e!=null)return P(X(t,e))};switch(r.directionMode){case T.Absolute:return _(y);case T.Relative:{const m=S();return m==null?void 0:_(m+y)}case T.RelativeBilateral:{const m=S();return m==null?void 0:N([_(m+y),_(m-y)])}}}function et(t,e){return e.mode==="geodesic"?ie(null,null,null,t,null,e):H(t,e)}function tt(t,e,n,i,o,r){return r.mode==="geodesic"?ie(e,t,n,o,i,r):nt([Je(t,n,r),Qe(t,e,i,r),H(o,r)])}function nt(t){let e;for(const n of t)n&&(e=(e==null?void 0:e.intersect(n))??n);return e}function F(t,e){const{view:n,elevationInfo:i,measurementSR:o,origin:r,mode:l}=e,s=E(t,n,i);if(V(s,t.spatialReference,s,o))return l!=="geodesic"&&K(s,s,r),s}function it(t,e,n){const{view:i,measurementSR:o,spatialReference:r,origin:l,mode:s}=n,a=b;if(s==="geodesic"?le(a,t):pe(a,t,l),V(a,o,a,r))return ce(a,i,e,n)}function st(t,e){var n;return((n=se(t,e))==null?void 0:n.value)??void 0}function rt(t,e){const n=se(t,e);return n!=null?R(n,"meters"):void 0}function se(t,{view:e,origin:n,elevationInfo:i,hasZ:o,measurementSR:r}){if(t==null||!o)return;const l=ge(r);if(l==null)return;const[s,a]=n,u=R(t,l),d=(e==null?void 0:e.type)==="3d"?fe(e,s,a,u,r,i):u;return d!=null?ve(d,l):void 0}const b=g(),ot="crosshair",at="progress";let p=class extends j.EventedMixin(Se){constructor(t){super(t),this._createOperationCompleted=!1,this._hideDefaultCursor=!1,this._pointerDownStates=new Set,this._stagedScreenPoint=null,this._stagedPointerType=null,this._stagedPointerId=null,this._updatingHandles=new Ce,this.constraintsEnabled=!1,this.constraintInfo=void 0,this._getPointConstraint=U(et),this._getPolylineOrPolygonConstraint=U(tt),this.constraintZ=null,this.defaultZ=null,this.isDraped=!0,this.labelOptions=new Y,this.cursor=null,this.loading=!1,this.snapToSceneEnabled=null,this.firstVertex=null,this.lastVertex=null,this.secondToLastVertex=null,t.elevationInfo==null&&(this.elevationInfo=be(!!t.hasZ))}initialize(){const{geometryType:t,view:e}=this,n=e.spatialReference,i="viewingMode"in e.state?e.state.viewingMode:Pe.Local,o=t==="segment"||t==="multipoint"?"polyline":t;this.coordinateHelper=Be(this.hasZ,this.hasM,n),this._editGeometryOperations=new Ue(new qe(o,this.coordinateHelper)),this._snappingOperation=new Xe({view:e}),this.addHandles([C(()=>({stagedPoint:this._snappingOperation.stagedPoint,constraint:this.constraint}),({stagedPoint:s,constraint:a},u)=>{var f,v;const{snappingOptions:d}=this;if(d&&(d.forceDisabled=a!=null&&Re(a),d.constraintsActive=((f=this.constraintInfo)==null?void 0:f.distance)!=null||((v=this.constraintInfo)==null?void 0:v.direction)!=null),u!=null&&s===u.stagedPoint&&a!==u.constraint)return this._onKeyboardBasedChange();this._processCursor(s??this._screenToMap(this._stagedScreenPoint))},{sync:!0,equals:(s,a)=>s.stagedPoint===a.stagedPoint&&Ve(s.constraint,a.constraint)}),C(()=>this.view.viewpoint,(s,a)=>{s&&a&&$e(s,a)&&this._onKeyboardBasedChange()})]),this._activeComponent=new je(n,i),this._editGeometryOperations.data.components.push(this._activeComponent);const r=this.segmentLabels;r!=null&&(r.context={view:e,editGeometryOperations:this._editGeometryOperations,elevationInfo:this.elevationInfo,labelOptions:this.labelOptions},this.addHandles(C(()=>this.labelOptions.enabled,s=>{r.visible=s},A))),this.addHandles(this._editGeometryOperations.on(["vertex-add","vertex-update","vertex-remove"],s=>{var y,_,S,m;const a=s.vertices.map(x=>({componentIndex:0,vertexIndex:x.index,coordinates:this.coordinateHelper.vectorToArray(x.pos)})),u=a.map(x=>x.coordinates),d=this.coordinateHelper.vectorToDehydratedPoint((y=this._activeComponent.getFirstVertex())==null?void 0:y.pos)??null;O(d,this.firstVertex)||(this.firstVertex=d);const f=this.coordinateHelper.vectorToDehydratedPoint((_=this._activeComponent.getLastVertex())==null?void 0:_.pos)??null;O(f,this.lastVertex)||(this.lastVertex=f);const v=this.coordinateHelper.vectorToDehydratedPoint((m=(S=this._activeComponent.edges.at(-1))==null?void 0:S.leftVertex)==null?void 0:m.pos)??null;switch(O(v,this.secondToLastVertex)||(this.secondToLastVertex=v),this._processCursor(this.cursorVertex),s.type){case"vertex-add":this.emit(s.type,{...s,added:u,vertices:a});break;case"vertex-update":this.emit(s.type,{...s,updated:u,vertices:a});break;case"vertex-remove":this.emit(s.type,{...s,removed:u,vertices:a})}}));const l=this._manipulator=new Ye({consumesClicks:!1,grabbableForEvent:s=>this.drawingMode!=="click"||s.pointerType==="touch"&&this._snappingEnabled&&this._pointerDownStates.size===1});this.manipulators.add(l),l.grabbable=t!=="point",this.addHandles([this._createManipulatorDragPipeline(l),l.events.on("immediate-click",s=>this._onImmediateClick(s)),l.events.on("immediate-double-click",s=>this._onImmediateDoubleClick(s)),C(()=>({effectiveCursor:this.effectiveCursor}),({effectiveCursor:s})=>{l.cursor=s},A)]),Me(this,()=>{const s=this.view.inputManager.latestPointerType??"mouse",a=this._getSnappingContext(s);this.snappingManager!=null&&this._updatingHandles.addPromise(z(this._snappingOperation.snapAgainNearPreviousMapPoint(this.snappingManager,a)))})}destroy(){I(this.segmentLabels),I(this._snappingOperation),this._editGeometryOperations=I(this._editGeometryOperations),this._updatingHandles.destroy()}get _snappingEnabled(){return this.snappingManager!=null&&this.snappingManager.options.effectiveEnabled}get _requiresScenePoint(){const t=this._updateAndGetEffectiveDrawSurface();return this.view.type==="3d"&&this.drawSurface!==t}get canRedo(){return this._editGeometryOperations.canRedo}get canUndo(){return this._editGeometryOperations.canUndo}get committedVertices(){return this._activeComponent.vertices.map(t=>this.coordinateHelper.vectorToArray(t.pos))}get constraint(){const{constraintInfo:t,constraintsEnabled:e}=this;if(t&&e)switch(this.geometryType){case"point":return this._getPointConstraint(t.elevation,t.context);case"polygon":case"polyline":return this._getPolylineOrPolygonConstraint(this.lastVertex,this.secondToLastVertex,t.distance,t.direction,t.elevation,t.context)}}set drawingMode(t){this._set("drawingMode",t??ne)}get effectiveCursor(){return this.loading?at:this._hideDefaultCursor?null:this.cursor||ot}get interactive(){return this._manipulator.interactive}set interactive(t){this._manipulator.interactive=t}get isCompleted(){return this._createOperationCompleted}get numCommittedVertices(){return this._activeComponent.vertices.length}get snappingOptions(){return this.snappingManager!=null?this.snappingManager.options:null}get cursorVertex(){return this._get("cursorVertex")}get visualizationCursorVertex(){return this._stagedPointerType==="mouse"?this.cursorVertex:null}get committableVertex(){const{cursorVertex:t,lastVertex:e,firstVertex:n,geometryType:i}=this;return i==="polygon"&&Z(t,n)||Z(t,e)?null:t}get updating(){return this._updatingHandles.updating}get geometryIncludingUncommittedVertices(){const{committedVertices:t,committableVertex:e,coordinateHelper:n}=this,i=t.slice();return e!=null&&i.push(n.pointToArray(e)),i}cancel(){this.complete({aborted:!0})}commitStagedVertex(){this._snappingOperation.abort();const{committableVertex:t}=this;t!=null&&this._editGeometryOperations.appendVertex(this.coordinateHelper.pointToVector(t))}complete(t){var r;const e=(t==null?void 0:t.aborted)||!1;this._snappingOperation.abort(),(r=this.snappingManager)==null||r.doneSnapping();const{geometryType:n,numCommittedVertices:i}=this,o=n==="multipoint"&&i===0||n==="polyline"&&i<2||n==="polygon"&&i<3;n!=="segment"&&n!=="point"||this.commitStagedVertex(),this._createOperationCompleted=!o,(this.isCompleted||e)&&(this._stagedScreenPoint=null,this._stagedPointerId=null,this._stagedPointerType=null,this._processCursor(null),this.emit("complete",{vertices:this.committedVertices.map((l,s)=>({componentIndex:0,vertexIndex:s,coordinates:l})),aborted:e,type:"complete"}))}onInputEvent(t){switch(t.type){case"pointer-down":this._pointerDownStates.add(t.pointerId);break;case"pointer-up":this._pointerDownStates.delete(t.pointerId)}switch(t.type){case"pointer-move":return this._onPointerMove(t);case"hold":return this._onHold(t)}}redo(){this._editGeometryOperations.redo()}undo(){this.snappingManager!=null&&this.snappingManager.doneSnapping(),this._editGeometryOperations.undo()}_processCursor(t){var l,s;const e=k(this.cursorVertex),n=k(t),i=n&&(((l=this._updateAndGetEffectiveDrawSurface())==null?void 0:l.constrainZ(n))??n),o=this._snapToClosingVertex(i),r=this._applyConstraints(o);Z(e,r)||(this._set("cursorVertex",r),(s=this.segmentLabels)==null||s.set("stagedVertex",r!=null?this.coordinateHelper.pointToVector(r):null),r==null||this._stagedPointerType!=="mouse"?this.emit("cursor-remove"):this.emit("cursor-update",{updated:null,vertices:[{componentIndex:0,vertexIndex:this._activeComponent.vertices.length,coordinates:this.coordinateHelper.pointToArray(r)}],operation:"apply",type:"vertex-update"}))}_snapToClosingVertex(t){if(t==null||this.geometryType!=="polygon"||this.numCommittedVertices<=2)return t;const e=this._mapToScreen(t);if(!e)return t;const n=this._activeComponent;return this._vertexWithinPointerDistance(n.vertices[0].pos,e)?this.firstVertex:this._vertexWithinPointerDistance(n.vertices.at(-1).pos,e)?this.lastVertex:t}_createManipulatorDragPipeline(t){switch(this.drawingMode){case"click":return this._createManipulatorDragPipelineClick(t);case"freehand":return this._createManipulatorDragPipelineFreehand(t);case"hybrid":return this._createManipulatorDragPipelineHybrid(t)}}_createManipulatorDragPipelineClick(t){return D(t,(e,n,i,o)=>{const r=o==="touch"&&this._snappingEnabled;if(this.isCompleted||!r)return;const{snappingStep:l,cancelSnapping:s}=Ne({predicate:()=>r,snappingManager:this.snappingManager,snappingContext:new q({editGeometryOperations:this._editGeometryOperations,elevationInfo:this.elevationInfo,feature:this.graphic,pointer:o,visualizer:this.snappingVisualizer}),updatingHandles:this._updatingHandles,useZ:!this._requiresScenePoint});i=i.next(a=>(r&&this.snappingManager!=null&&this.snappingManager.doneSnapping(),a)).next(s),n.next(this._screenToMapDragEventStep()).next(a=>(a.action==="start"&&(this._processCursor(a.mapStart),(this.geometryType==="segment"||r&&!this.numCommittedVertices)&&this.commitStagedVertex()),a)).next(Ke(this.view,this.elevationInfo)).next(...l).next(a=>(r&&(this._processCursor(a.mapEnd),a.action==="end"&&this.commitStagedVertex()),a)).next(a=>(a.action==="end"&&(this._stagedPointerType!=="mouse"&&this._snappingOperation.abort(),this.geometryType!=="segment"&&this.geometryType!=="point"||this.complete()),a))})}_createManipulatorDragPipelineFreehand(t){return D(t,(e,n)=>{this.isCompleted||n.next(this._screenToMapDragEventStep()).next(i=>(i.action==="start"&&(this._snappingOperation.abort(),this.committableVertex==null&&this._processCursor(i.mapStart),this.geometryType==="segment"&&this.commitStagedVertex()),i)).next(i=>{switch(i.action){case"start":case"update":this._processCursor(i.mapEnd),this.geometryType!=="polygon"&&this.geometryType!=="polyline"||this.commitStagedVertex();break;case"end":this.complete()}return i})})}_createManipulatorDragPipelineHybrid(t){return D(t,(e,n)=>{this.isCompleted||n.next(this._screenToMapDragEventStep()).next(i=>(i.action==="start"&&(this._snappingOperation.abort(),this._processCursor(i.mapStart),this.commitStagedVertex()),i)).next(i=>{switch(i.action){case"start":case"update":this._processCursor(i.mapEnd),this.geometryType!=="polygon"&&this.geometryType!=="polyline"||this.commitStagedVertex();break;case"end":this._stagedPointerType!=="mouse"&&this._snappingOperation.abort(),this.geometryType!=="segment"&&this.geometryType!=="point"||this.complete()}return i})})}get _drawAtFixedElevation(){const{constraintsEnabled:t,constraintZ:e,geometryType:n,numCommittedVertices:i}=this;return t?e!=null||n==="segment"&&i>0:(n==="segment"||n==="polygon")&&i>0}_updateAndGetEffectiveDrawSurface(){var a;const{constraintsEnabled:t,coordinateHelper:e,drawSurface:n,elevationDrawSurface:i,snapToSceneEnabled:o}=this;if(i==null)return n;if(!this.hasZ)return i.defaultZ=null,i;const r=(a=this.elevationInfo)==null?void 0:a.mode;let l=this.defaultZ,s=t||r==="absolute-height";return o!=null&&(s=o),r==="on-the-ground"&&(s=!1),this._drawAtFixedElevation&&(l=(t?this.constraintZ:null)??e.getZ(this._activeComponent.vertices[0].pos),s=!1),s?n:(i.defaultZ=l,i)}_mapToScreen(t){var e;return(e=this._updateAndGetEffectiveDrawSurface())==null?void 0:e.mapToScreen(t)}_onHold(t){this._snappingOperation.abort(),this.drawingMode==="click"&&t.pointerType==="touch"&&this._snappingEnabled&&this._processCursor(t.mapPoint),t.stopPropagation()}_onImmediateClick(t){if(!(t.pointerType==="mouse"&&t.button===2||this._manipulator.dragging))try{const{drawingMode:e,geometryType:n}=this;this._stagedPointerType=t.pointerType,this._stagedScreenPoint=t.screenPoint;const i=this._screenToMap(t.screenPoint);if(i==null||i==null||e==="freehand"&&n!=="point")return;if(this._snappingEnabled&&this.cursorVertex!=null||this._processCursor(i),this.committableVertex==null)return void this.complete();this.commitStagedVertex(),t.pointerType!=="mouse"&&this._processCursor(null),(e==="freehand"||n==="point"||n==="segment"&&this.numCommittedVertices===2||n==="segment"&&e==="hybrid"&&this.numCommittedVertices===1)&&this.complete()}finally{t.stopPropagation()}}_onImmediateDoubleClick(t){this._manipulator.dragging||this.geometryType==="point"||(this.complete(),t.stopPropagation())}_onPointerMove(t){const e=J(t.x,t.y);this._stagedScreenPoint=e,this._stagedPointerType=t.pointerType,this._stagedPointerId=t.pointerId;const n=this._snappingOperation,i=this._manipulator;this._pointerDownStates.has(t.pointerId)||i.grabbing||!i.interactive?n.abort():(t.stopPropagation(),this._processCursorMovementRelativeToSurface(e,t.pointerType))}_onKeyboardBasedChange(){const t=this._manipulator;this._stagedPointerType==="mouse"&&this._stagedScreenPoint&&this._stagedPointerId!=null&&!this._pointerDownStates.has(this._stagedPointerId)&&!t.grabbing&&t.interactive?this._processCursorMovementRelativeToSurface(this._stagedScreenPoint,this._stagedPointerType):this._snappingOperation.abort()}_processCursorMovementRelativeToSurface(t,e){var s;const n=this._snappingOperation,i=this._screenToMap(t),o=this._requiresScenePoint?(s=this.drawSurface)==null?void 0:s.screenToMap(t):null;if(i==null)return this._hideDefaultCursor=!0,this._processCursor(null),void n.abort();this._hideDefaultCursor=!1;const r=this.snappingManager;if(r==null)return this._processCursor(i),void n.abort();const l=this._getSnappingContext(e);this._updatingHandles.addPromise(z(n.snap({point:i,scenePoint:o},r,l)))}_applyConstraints(t){const{constraint:e,constraintInfo:n}=this;if(!t||!n||!e)return t;const{context:i}=n,o=F(t,i),r=o?e.closestTo(o):void 0;if(!r)return t;const l=it(r,t,i);return l!=null&&i.elevationInfo.mode!=="absolute-height"&&this.constraintZ!=null&&this.hasZ&&(l.z=this.constraintZ),l}_screenToMap(t){var e;return t?(e=this._updateAndGetEffectiveDrawSurface())==null?void 0:e.screenToMap(t):null}_screenToMapDragEventStep(){let t=null;return e=>{if(e.action==="start"&&(t=this._screenToMap(e.screenStart)),t==null)return null;const n=this._screenToMap(e.screenEnd);return n!=null?{...e,mapStart:t,mapEnd:n}:null}}_vertexWithinPointerDistance(t,e){const i=this._mapToScreen(this.coordinateHelper.vectorToDehydratedPoint(t));return i!=null&&lt(i,e,25)}_getSnappingContext(t){var n;const e=this._drawAtFixedElevation?(n=this.elevationDrawSurface)==null?void 0:n.defaultZ:null;return new q({editGeometryOperations:this._editGeometryOperations,elevationInfo:this.elevationInfo,pointer:t,feature:this.graphic,visualizer:this.snappingVisualizer,selfSnappingZ:e!=null?{value:e,elevationInfo:this.elevationInfo}:null})}};function lt(t,e,n){const i=t.x-e.x,o=t.y-e.y;return i*i+o*o<=n}c([h()],p.prototype,"_hideDefaultCursor",void 0),c([h()],p.prototype,"_snappingOperation",void 0),c([h()],p.prototype,"_snappingEnabled",null),c([h({constructOnly:!0})],p.prototype,"graphic",void 0),c([h()],p.prototype,"constraintsEnabled",void 0),c([h()],p.prototype,"constraintInfo",void 0),c([h()],p.prototype,"constraint",null),c([h()],p.prototype,"constraintZ",void 0),c([h()],p.prototype,"defaultZ",void 0),c([h()],p.prototype,"isDraped",void 0),c([h({value:ne})],p.prototype,"drawingMode",null),c([h({constructOnly:!0})],p.prototype,"elevationDrawSurface",void 0),c([h({constructOnly:!0})],p.prototype,"elevationInfo",void 0),c([h({constructOnly:!0,type:Y})],p.prototype,"labelOptions",void 0),c([h({constructOnly:!0})],p.prototype,"geometryType",void 0),c([h({constructOnly:!0})],p.prototype,"hasM",void 0),c([h({constructOnly:!0})],p.prototype,"hasZ",void 0),c([h()],p.prototype,"cursor",void 0),c([h()],p.prototype,"effectiveCursor",null),c([h()],p.prototype,"loading",void 0),c([h({constructOnly:!0})],p.prototype,"manipulators",void 0),c([h({constructOnly:!0})],p.prototype,"drawSurface",void 0),c([h({constructOnly:!0})],p.prototype,"segmentLabels",void 0),c([h({constructOnly:!0})],p.prototype,"snappingManager",void 0),c([h({constructOnly:!0})],p.prototype,"snappingVisualizer",void 0),c([h()],p.prototype,"snapToSceneEnabled",void 0),c([h({readOnly:!0})],p.prototype,"cursorVertex",null),c([h({readOnly:!0})],p.prototype,"visualizationCursorVertex",null),c([h()],p.prototype,"committableVertex",null),c([h()],p.prototype,"firstVertex",void 0),c([h()],p.prototype,"lastVertex",void 0),c([h()],p.prototype,"secondToLastVertex",void 0),c([h()],p.prototype,"updating",null),c([h({constructOnly:!0})],p.prototype,"view",void 0),p=c([Ie("esri.views.draw.DrawOperation")],p);class wt{constructor(e,n,i,o=null){this._elevationInfo=e,this.defaultZ=n,this._view=i,this._excludeGraphics=o}screenToMap(e){const{defaultZ:n,_view:i}=this,o=i.sceneIntersectionHelper.intersectElevationFromScreen(Ze(e.x,e.y),this._elevationInfo,n??0,this._excludeGraphics);return n==null&&o!=null&&(o.z=void 0),o}mapToScreen(e){const n=Q(e.x,e.y,ee(this._view,e,this._elevationInfo),e.spatialReference);return this._view.toScreen(n)}constrainZ(e){const{defaultZ:n}=this;return n!=null&&e.z!==n&&((e=te(e)).z=n),e}}let Tt=class{constructor(e,n,i=[]){this.view=e,this.elevationInfo=n,this.exclude=i}screenToMap(e){const n=this.view.toMap(e,{exclude:this.exclude,excludeHud:!0});return n!=null&&(n.z=De(n,this.view,this.elevationInfo)),n}mapToScreen(e){let n=e;return this.elevationInfo!=null&&(n=Q(e.x,e.y,ee(this.view,e,this.elevationInfo),e.spatialReference)),this.view.toScreen(n)}constrainZ(e){return e}};class Ct{constructor(e,n=!1,i=0){this.view=e,this.hasZ=n,this.defaultZ=i,this.mapToScreen=o=>e.toScreen(o),this.screenToMap=n?o=>{const r=e.toMap(o);return r.z=i,r}:o=>e.toMap(o)}constrainZ(e){const{defaultZ:n}=this;return this.hasZ&&e.z!==n&&((e=te(e)).z=n),e}}class W{screenToMap(e){const{x:n,y:i}=e;return new w({x:n,y:i,spatialReference:W.spatialReference})}mapToScreen(e){return J(e.x,e.y)}constrainZ(e){return e}}W.spatialReference=new Oe;function M(t,e,n=null){return n!=null?[t,e,n]:[t,e]}function re(t,e,n=null){return n!=null?{x:t,y:e,z:n}:{x:t,y:e}}class oe{constructor(e){this.spatialReference=e}mapToLocalMultiple(e){return e.map(n=>this.mapToLocal(n)).filter(Le)}get doUnnormalization(){return!1}}class pt extends oe{constructor(e,n,i=null){super(n),this._defaultZ=i,this.transform=G(),this.transformInv=G(),this.transform=Ee(e),He(this.transformInv,this.transform)}makeMapPoint(e,n){return M(e,n,this._defaultZ)}mapToLocal(e){return re(this.transform[0]*e[0]+this.transform[2]*e[1]+this.transform[4],this.transform[1]*e[0]+this.transform[3]*e[1]+this.transform[5])}localToMap(e){return M(this.transformInv[0]*e.x+this.transformInv[2]*e.y+this.transformInv[4],this.transformInv[1]*e.x+this.transformInv[3]*e.y+this.transformInv[5],this._defaultZ)}}class ct extends oe{constructor(e,n){super(e.spatialReference),this.view=e,this.defaultZ=null,this.pWS=g(),this.tangentFrameUpWS=g(),this.tangentFrameRightWS=g(),this.tangentFrameForwardWS=g(),this.localFrameRightWS=g(),this.localFrameUpWS=g(),this.worldToLocalTransform=L(),this.localToWorldTransform=L(),this.scale=1,this.scale=e.resolution,this.referenceMapPoint=n,this.defaultZ=n.hasZ?n.z:null;const i=e.state.camera.viewRight;this.view.renderCoordsHelper.toRenderCoords(this.referenceMapPoint,this.pWS),this.view.renderCoordsHelper.worldBasisAtPosition(this.pWS,$.X,this.tangentFrameRightWS),this.view.renderCoordsHelper.worldBasisAtPosition(this.pWS,$.Y,this.tangentFrameUpWS),this.view.renderCoordsHelper.worldBasisAtPosition(this.pWS,$.Z,this.tangentFrameForwardWS);const o=g();Fe(o,this.tangentFrameForwardWS,We(i,this.tangentFrameForwardWS)),K(this.localFrameRightWS,i,o),ke(this.localFrameRightWS,this.localFrameRightWS),ze(this.localFrameUpWS,this.tangentFrameForwardWS,this.localFrameRightWS),Ae(this.worldToLocalTransform,this.localFrameRightWS,this.tangentFrameRightWS),Ge(this.localToWorldTransform,this.worldToLocalTransform)}get doUnnormalization(){return this.view.viewingMode==="global"}makeMapPoint(e,n){return M(e,n,this.defaultZ)}mapToLocal(e){const n=g();this.view.renderCoordsHelper.toRenderCoords(new w({x:e[0],y:e[1],spatialReference:this.spatialReference}),n),B(n,n,this.worldToLocalTransform);const i=this.view.renderCoordsHelper.fromRenderCoords(n,new w({spatialReference:this.view.spatialReference}));return i!=null?re(i.x/this.scale,i.y/this.scale):null}localToMap(e){const n=g();this.view.renderCoordsHelper.toRenderCoords(new w({x:e.x*this.scale,y:e.y*this.scale,spatialReference:this.spatialReference}),n),B(n,n,this.localToWorldTransform);const i=this.view.renderCoordsHelper.fromRenderCoords(n,new w({spatialReference:this.view.spatialReference}));return i!=null?M(i.x,i.y,this.defaultZ):null}}function bt(t,e){if(t.type==="2d")return new pt(t.state.transform,t.spatialReference,e.length>2?e[2]:null);if(t.type==="3d"){const n=e.length>2?new w({x:e[0],y:e[1],z:e[2],spatialReference:t.spatialReference}):new w({x:e[0],y:e[1],spatialReference:t.spatialReference});return new ct(t,n)}return null}export{bt as F,p as L,xt as M,pt as W,_t as a,wt as c,ne as e,Ct as h,Tt as l,W as u,re as w};
