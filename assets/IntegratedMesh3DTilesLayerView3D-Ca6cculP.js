import{eC as Le,qx as be,qU as $,mx as A,fR as v,dI as De,dG as je,pZ as Be,aP as ke,qV as Ge,fJ as Ne,D as Z,qW as $e,ar as _e,P as qe,qX as D,qY as we,u as ve,k5 as ze,n8 as xe,hN as We,eP as Je,qZ as Xe,lB as Ze,q_ as Ye,fS as Te,q$ as Ke,r0 as Y,r1 as Qe,r2 as et,cS as K,lN as Ce,d8 as Pe,r3 as Me,r4 as tt,md as st,dZ as j,r5 as it,g7 as rt,e0 as at,r6 as nt,r7 as ot,r8 as Ee,fQ as lt,r9 as ct,ra as dt,rb as ht,rc as Q,rd as ut,re as mt,e7 as B,rf as pt,rg as ft,rh as gt,ri as Oe,rj as Ue,aK as Ae,g as k,y as ee,i as yt,e8 as Ie,rk as bt}from"./index-BhDz4nJ7.js";import{x as _t,f as wt}from"./LayerElevationProvider-bOov_xs8.js";import{r as M,a as te,S as G,N as O,e as g,m as vt,d as xt,g as se,t as P,n as ie,i as V}from"./ILyr3DWasmPerSceneView-vPx4somd.js";import{n as Tt}from"./LayerView3D-BKIbGugV.js";import{s as Ct}from"./RenderTexture-Caq6jnTc.js";import{u as Pt}from"./LayerView-C77uL6vR.js";class Mt extends Le{constructor(e,l,a,d,r,n,m){super(e,0,0,0,l),this.nodesCached=a,this.vboMB=d,this.textureMB=r,this.vboMBCached=n,this.textureMBCached=m}}const Et={[M.Points]:null,[M.Lines]:null,[M.LineStrip]:null,[M.Triangles]:be.TRIANGLES,[M.TriangleStrip]:be.TRIANGLE_STRIP,[M.NotSet]:null},Re={[te.Opaque]:$.Opaque,[te.Mask]:$.Mask,[te.Blend]:$.Blend},Ot={[G.Back]:A.Back,[G.Front]:A.Front,[G.None]:A.None,[G.NotSet]:A.Back},Ut={[O.WrapYBit]:{s:v.CLAMP_TO_EDGE,t:v.REPEAT},[O.WrapXBit]:{s:v.REPEAT,t:v.CLAMP_TO_EDGE},[O.WrapXy]:{s:v.REPEAT,t:v.REPEAT},[O.None]:{s:v.CLAMP_TO_EDGE,t:v.CLAMP_TO_EDGE},[O.NotSet]:{s:v.CLAMP_TO_EDGE,t:v.CLAMP_TO_EDGE}},At={[g.U8]:1,[g.I8]:1,[g.U16]:2,[g.I16]:2,[g.U32]:4,[g.I32]:4,[g.F32]:4,[g.F64]:8,[g.Utf8String]:1,[g.NotSet]:1};class It{constructor(e){this.layerUid=[],this.type=De.TILES3D,this.slicePlaneEnabled=!1,this.isGround=!0,this.layerView=e,this.layerUid.push(e.layer.uid)}intersect(e,l,a,d){const r=e.results,n=e.options.store===je.ALL;if(e.options.filteredLayerUids.includes(this.layerView.layer.uid))return;const m=this.layerView.view._stage.renderView.componentObjectCollection;this.layerView.objects.forEach(b=>{b.visible&&b.intersectionGeometry&&m.intersect(b,a,d,e.tolerance,null,(x,u,f,c)=>{if(u>=0){if(l!=null&&!l(a,d,u))return;const o=s=>{const p=new Ge(this.layerView.layer.uid,()=>this._createTiles3DGraphic(this.layerView.layer,{}));s.set(this.type,p,u,f)};if(this.isGround&&(r.ground.dist==null||u<r.ground.dist)&&o(r.ground),e.options.isFiltered)return;if((r.min.dist==null||u<r.min.dist)&&o(r.min),(r.max.dist==null||u>r.max.dist)&&o(r.max),n){const s=Be(e.ray);o(s),e.results.all.push(s)}}})})}_createTiles3DGraphic(e,l){return new ke({layer:e,sourceLayer:e,attributes:l})}}var y;(function(t){t[t.API=1]="API",t[t.VerboseAPI=2]="VerboseAPI",t[t.Error=3]="Error"})(y||(y={}));class Rt{constructor(){this.handle=0,this.isVisible=!1,this.components=[],this.texMemoryUsage=0,this.vboMemoryUsage=0,this.cpuMemoryUsage=0,this.textures=[]}totalMemory(){return this.texMemoryUsage+this.vboMemoryUsage+this.cpuMemoryUsage}}function N(t){return Math.round(t/1048.576)/1e3}let U=class extends Tt(Pt){constructor(){super(...arguments),this.type="integrated-mesh-3dtiles",this._visibleGeometryChangedSchedulerHandle=null,this._wasmLayerId=-1,this.ignoresMemoryFactor=!1,this.drapeTargetType=Ne.WithoutRasterImage,this._lyrHandleToObjects=new Map,this._initialCullFace=new Map,this._suspendedHandle=null,this._dbgFlags=new Set}initialize(){if(this._dbgFlags.add(y.Error),this._dbg(y.VerboseAPI,"Tiles3DLayerView3D initialize() called"),!this._canProjectWithoutEngine())throw new Z("layerview:spatial-reference-incompatible","The spatial reference of this scene layer is incompatible with the spatial reference of the view",{});const t=$e(this).then(e=>{this._intersectionHandler=new It(this),this.view.sceneIntersectionHelper.addIntersectionHandler(this._intersectionHandler),this._updatingHandles.add(()=>this.slicePlaneEnabled,a=>this._slicePlaneEnabledChange(a)),this._elevationProvider=new _t({view:this.view,layerElevationSource:this,intersectionHandler:this._intersectionHandler}),this.view.elevationProvider.register("im",this._elevationProvider),this.view.basemapTerrain.overlayManager.registerDrapeTarget(this),this._wasmLayerId=e;const l=this.view.resourceController.memoryController.newCache(`t3d-${this.uid}`,a=>this._onRemoveFromCache(a));this._memCache=l,this._suspendedHandle=_e(()=>this.suspended,a=>{const d=D(this.view);d&&d.setEnabled(this,!a)},qe),this.addHandles([_e(()=>this.layer.elevationInfo,a=>this._elevationInfoChanged(a))])}).catch(e=>{if(we(this),this._wasmLayerId=-1,e===vt)throw new Z("tiles3d:addLayer-failure","The 3d tiles layer description was invalid.",{});if(e===xt)throw new Z("tiles3d:addLayer-failure","The 3d tiles layer web assembly module failed to download.",{})});this.addResolvingPromise(t)}destroy(){this._dbg(y.VerboseAPI,"Tiles3DLayerView3D destroy() called"),we(this),this._suspendedHandle&&(this._suspendedHandle.remove(),this._suspendedHandle=null),this._intersectionHandler&&(this.view.sceneIntersectionHelper.removeIntersectionHandler(this._intersectionHandler),this._intersectionHandler=null),this._elevationProvider&&(this._elevationProvider.objectsChanged(this._obbs),this.view.elevationProvider.unregister(this._elevationProvider),this._elevationProvider=null),this.view.basemapTerrain.overlayManager.unregisterDrapeTarget(this),this._lyrHandleToObjects.forEach(t=>this.freeObject(t)),this._lyrHandleToObjects.clear(),this._initialCullFace.clear(),this._memCache=ve(this._memCache),this._updatingHandles=ve(this._updatingHandles),this.emit("visible-geometry-changed"),this._visibleGeometryChangedSchedulerHandle&&(this._visibleGeometryChangedSchedulerHandle.remove(),this._visibleGeometryChangedSchedulerHandle=null)}_visibleGeometryChanged(){this._visibleGeometryChangedSchedulerHandle==null&&(this._visibleGeometryChangedSchedulerHandle=ze(()=>{this.emit("visible-geometry-changed"),this._visibleGeometryChangedSchedulerHandle=null}))}_slicePlaneEnabledChange(t){this._intersectionHandler&&(this._intersectionHandler.slicePlaneEnabled=t),this.objects.forEach(e=>{const l=this._collection.getMaterial(e);l.commonMaterialParameters.hasSlicePlane=t,l.commonMaterialParameters.cullFace=t?A.None:this._initialCullFace.get(e)})}_elevationInfoChanged(t){const e=(t==null?void 0:t.offset)??0,l=t!=null&&t.unit?xe(t==null?void 0:t.unit):1,a=D(this.view);a&&a.setLayerOffset(this,e*l)}get _obbs(){return this.objects.map(t=>this._collection.getComponentObb(t))}get wasmLayerId(){return this._wasmLayerId}get usedMemory(){let t=0;return this._lyrHandleToObjects.forEach(e=>{e.isVisible&&(t+=e.totalMemory())}),t}get unloadedMemory(){let t=0;return this._lyrHandleToObjects.forEach(e=>{e.isVisible||(t+=e.totalMemory())}),t}get performanceInfo(){let t=0,e=0,l=0,a=0,d=0,r=0;return this._lyrHandleToObjects.forEach(n=>{n.isVisible?(t+=n.texMemoryUsage,e+=n.vboMemoryUsage,d++):(l+=n.texMemoryUsage,a+=n.vboMemoryUsage,r++)}),new Mt(this.usedMemory,d,r,N(e),N(t),N(a),N(l))}_canProjectWithoutEngine(){var t,e;if(this.view.state.viewingMode===We.Local){const l=(t=this.view.renderSpatialReference)!=null&&t.isWebMercator?3857:((e=this.view.renderSpatialReference)==null?void 0:e.wkid)??-1;if(l!==3857&&l!==32662)return!1}return!0}get _stage(){return this.view._stage}get _collection(){return this._stage.renderView.componentObjectCollection}get elevationOffset(){var t,e;return(((t=this.layer.elevationInfo)==null?void 0:t.offset)??0)*((e=this.layer.elevationInfo)!=null&&e.unit?xe(this.layer.elevationInfo.unit):1)}get elevationRange(){const t=this.fullExtent;return t!=null&&t.zmin&&(t!=null&&t.zmax)?new Je(t.zmin,t.zmax):null}getElevationRange(t){return null}get fullExtent(){return this.layer.fullExtent}get objects(){return Array.from(this._lyrHandleToObjects.values()).reduce((t,e)=>t.concat(e.components),new Array)}isUpdating(){const t=D(this.view);return!(this._wasmLayerId<0||t==null)&&t.isUpdating(this._wasmLayerId)}updatingFlagChanged(){this.notifyChange("updating")}async createRenderable(t){var o;const e=t.meshData;if(e.data==null)throw new Error("meshData.data undefined");if(e.desc=JSON.parse(e.desc),e.desc==null)throw new Error("meshData.desc undefined");const l=Xe(e.desc.origin),a=new Array,d=new Map,r=new Rt;r.handle=t.handle,this._lyrHandleToObjects.set(t.handle,r);const n=this.view.basemapTerrain.spatialReference;let m,b;if(this.view.viewingMode==="global"){const s=Ie();Ze(bt,l,s,n),m=Ye(Te(),s),b=Ke(Te(),m)}else m=Y,b=Y;const x=Ie();Qe(x,x,l);const u=et(K(),x);let f=null;const c=K();for(let s=0;s<e.desc.prims.length;s++){const p=e.desc.prims[s];if(p.ptype!==M.Lines||e.data==null)continue;const{positionView:h,positionAttr:E,indicesView:T}=this.getBufferViews(p,e.data.buffer,m,!1);E!=null&&h!=null&&T!=null&&(f=Ce(E),Pe(c,f.center,l),f.center=c)}for(let s=0;s<e.desc.prims.length;s++){const p=e.desc.prims[s];if(this._dbg(y.VerboseAPI,JSON.stringify(p)),p.ptype===M.Lines)continue;if(Et[p.ptype]==null||e.data==null){this._dbg(y.VerboseAPI,"[Unsupported Feature] Unsupported primitive mode ("+p.ptype+"). Skipping primitive.");continue}const h=(o=e.desc)!=null&&o.materials&&p.materialId!=null?e.desc.materials[p.materialId]:null,E=h!=null?h.lightingModel:se.Unlit,T=E!==se.Unlit,{positionView:_,positionAttr:C,normalsView:Ve,normalsAttr:q,colorAttr:S,texCoord0Attr:F,indicesView:I}=this.getBufferViews(p,e.data.buffer,m,T);if(C==null||_==null||I==null)continue;const re={colors:S!=null,textureCoordinates:F!=null?Me.Default:Me.None,hasNormals:Ve!=null,needsNormals:T},Se=C.data.length/C.size,z=(i,w)=>!i||i.data.length/i.size===Se||(this._dbg(y.Error,`${w} !== numPos. Skipping primitive.`),!1);if(!z(F,"numTexcoord")||!z(S,"numColors")||!z(q,"normals"))continue;const ae=tt(re);let R;if(f!=null?R=f.clone():(R=Ce(C),Pe(c,R.center,l),R.center=c),m!==Y)for(let i=0;i<_.count;i++)_.getVec(i,c),st(c,c,m),_.setVec(i,c);const W=ae.createBuffer(C.data.length),H=new Map([[j.POSITION,C]]);F!=null&&H.set(j.UV0,F),S!=null&&H.set(j.COLOR,S),q!=null&&H.set(j.NORMALCOMPRESSED,q),H.forEach((i,w)=>{i!=null&&it(w,i,null,null,W,0)});const Fe=new Uint32Array([0,I.typedBuffer.length]),He={vertices:{data:W.buffer,count:W.byteLength/ae.stride,layoutParameters:re},positionData:{positions:_.typedBuffer,indices:I.typedBuffer},indices:I.typedBuffer,componentOffsets:Fe};r.cpuMemoryUsage+=_.count,r.cpuMemoryUsage+=I.count;const ne=this.view.renderSpatialReference,J=K(),X=[1,1,1];wt(u,ne,X,n)||this._dbg(y.Error,"Unsupported coordinate system for IM overlay"),rt(u,ne,J,n);const L=this._collection.createObject({toMapSpace:at(J[0],J[1],X[0],X[1]),geometry:He,obb:R,transform:{position:u,rotationScale:b}});h&&this._collection.updateMaterial(L,i=>{i.baseColor=h.baseColorFactor,i.usePBR=E===se.Pbr,i.hasParametersFromSource=!1,i.baseColorTexture=this._getTexture(h.baseColorTex,e,d),i.usePBR&&(i.mrrFactors=[h.metallicFactor,h.roughnessFactor,0],i.emissiveFactor=h.emissiveFactor??[0,0,0],i.metallicRoughnessTexture=this._getTexture(h.metalTex,e,d),i.emissionTexture=this._getTexture(h.emissiveTex,e,d),i.occlusionTexture=this._getTexture(h.occlusionTex,e,d),i.normalTexture=this._getTexture(h.normalTex,e,d)),i.objectOpacity=0,i.alphaDiscardMode=$.Mask;const w=[];i.baseColorTexture&&w.push(i.baseColorTexture.loadPromise),i.usePBR&&i.metallicRoughnessTexture&&w.push(i.metallicRoughnessTexture.loadPromise),i.usePBR&&i.emissionTexture&&w.push(i.emissionTexture.loadPromise),i.usePBR&&i.occlusionTexture&&w.push(i.occlusionTexture.loadPromise),i.usePBR&&i.normalTexture&&w.push(i.normalTexture.loadPromise);const oe=Promise.all(w);a.push(oe),oe.then(()=>{var le,ce,de,he,ue,me,pe,fe,ge,ye;i.alphaDiscardMode=Re[h.alphaMode],i.objectOpacity=1,r.texMemoryUsage+=((ce=(le=i.baseColorTexture)==null?void 0:le.glTexture)==null?void 0:ce.usedMemory)||0,i.usePBR&&(r.texMemoryUsage+=((he=(de=i.metallicRoughnessTexture)==null?void 0:de.glTexture)==null?void 0:he.usedMemory)||0,r.texMemoryUsage+=((me=(ue=i.emissionTexture)==null?void 0:ue.glTexture)==null?void 0:me.usedMemory)||0,r.texMemoryUsage+=((fe=(pe=i.occlusionTexture)==null?void 0:pe.glTexture)==null?void 0:fe.usedMemory)||0,r.texMemoryUsage+=((ye=(ge=i.normalTexture)==null?void 0:ge.glTexture)==null?void 0:ye.usedMemory)||0)}),i.commonMaterialParameters.doubleSided=h.isDoubleSided,i.commonMaterialParameters.cullFace=h.faceCulling?Ot[h.faceCulling]:A.Back,this._initialCullFace.set(L,i.commonMaterialParameters.cullFace),i.commonMaterialParameters.hasSlicePlane=this.slicePlaneEnabled,i.componentParameters.castShadows=nt.All,i.textureAlphaCutoff=h.alphaCutoff??.1,i.alphaDiscardMode=Re[h.alphaMode],i.isIntegratedMesh=!0,i.polygonOffsetEnabled=!1,i.hasOccludees=!1,i.ellipsoidMode=ot(this.view.spatialReference)}),r.components.push(L),r.vboMemoryUsage+=this._collection.getObjectGPUMemoryUsage(L)}if(await Promise.all(a),d.forEach(s=>{r.textures.push(s)}),!this._memCache)throw new Error("no memCache");return this._memCache.put(`${r.handle}`,r,r.totalMemory()),{memUsageBytes:r.totalMemory()}}freeRenderable(t){const e=this._lyrHandleToObjects.get(t);e&&(this.freeObject(e),this._lyrHandleToObjects.delete(t))}freeObject(t){this._memCache&&this._memCache.pop(`${t.handle}`),t.components.forEach(e=>{t.textures.forEach(l=>{this._stage.remove(l)}),this._collection.destroyObject(e),this._initialCullFace.delete(e)})}setRenderableVisibility(t,e,l){if(this._memCache){for(let a=0;a<l;++a){const d=t[a],r=e[a];if(!r)continue;const n=this._lyrHandleToObjects.get(d);n&&(this._visibleGeometryChanged(),n.isVisible=r,n.components.forEach(m=>{this._collection.setObjectVisibility(m,r),this._elevationProvider.objectChanged(this._collection.getComponentObb(m))}),this._memCache.pop(`${d}`))}for(let a=0;a<l;++a){const d=t[a],r=e[a];if(r)continue;const n=this._lyrHandleToObjects.get(d);n&&(this._visibleGeometryChanged(),n.isVisible=r,n.components.forEach(m=>{this._collection.setObjectVisibility(m,r),this._elevationProvider.objectChanged(this._collection.getComponentObb(m))}),this._memCache.put(`${d}`,n,n.totalMemory()))}}}_getTexture(t,e,l){var d,r;let a=null;if(t&&((d=e.desc)!=null&&d.images)&&((r=e.data)!=null&&r.buffer)){const n=e.desc.images[t==null?void 0:t.imageId];if(a=l.get(n),!a&&n){const m=this._stage.renderView.renderingContext.parameters.maxMaxAnisotropy,b=m>1,x=Ut[t.wrapMode??O.None];let u=n.alpha?4:3;const f=new Uint8Array(e.data.buffer,n.data.byteOffset,n.data.byteCount);let c=null,o=null,s=null;switch(n.format){case P.Raw:n.pixelFormat===ie.R8?(c=f.buffer,u=1,o=""):n.pixelFormat===ie.Rgb8?(c=f.buffer,u=3,o=""):n.pixelFormat===ie.Rgba8&&(c=f.buffer,u=4,o="");break;case P.Dxt1:c=f.buffer,u=3,o=Ee.DDS_ENCODING;break;case P.Dxt5:c=f.buffer,u=4,o=Ee.DDS_ENCODING;break;case P.Png:o="image/png",s=document.createElement("img");break;case P.Jpeg:o="image/jpeg",s=document.createElement("img");break;case P.Etc2:o="image/ktx",s=document.createElement("img");break;case P.Astc:this._dbg(y.Error,"Astc texture not supported");break;case P.Pvrtc:this._dbg(y.Error,"Pvrtc texture not supported")}if(s&&o){const p=new Blob([f],{type:o});s.src=URL.createObjectURL(p),c=s}c&&o!=null&&(a=new lt(c,{mipmap:b,maxAnisotropy:m,encoding:o,wrap:x,components:u,noUnpackFlip:!0,width:n.mip0Width,height:n.mip0Height}),this._stage.add(a),l.set(n,a))}}return a?new Ct(this.view._stage.renderView.textureRepository,a.id):null}getBufferViews(t,e,l,a){let d,r,n,m,b,x,u,f=null;for(let c=0;c<t.atrbs.length;c++){const o=t.atrbs[c],s=o.view,p=void 0,h=s.byteOffset+s.byteCount,E=s.byteCount/At[s.type],T=[...Array(E).keys()].map(_=>_);try{switch(o.sem){case V.Position:s.ncomp!==3||s.type!==g.F32?this._dbg(y.Error,"[Unsupported Feature] Unsupported view for Position ("+s+")"):(d=new Q(e,s.byteOffset,p,h),r=new B(d.typedBuffer,T,3));break;case V.Normal:if(s.ncomp!==3||s.type!==g.F32)this._dbg(y.Error,"[Unsupported Feature] Unsupported view for Normal ("+s+")");else if(a){const _=new Q(e,s.byteOffset,p,h),C=ft(_.typedBuffer,l);b=new gt(C),x=new B(b.typedBuffer,T,2)}break;case V.TexCoord:s.ncomp!==2||s.type!==g.F32?this._dbg(y.Error,"[Unsupported Feature] Unsupported view for Texcoord ("+s+")"):m===void 0&&(m=new B(new pt(e,s.byteOffset,p,h).typedBuffer,T,2));break;case V.Color:s.ncomp===4?(s.type===g.F32&&(f=new ct(e,s.byteOffset,p,h)),s.type===g.U8&&(f=new dt(e,s.byteOffset,p,h)),s.type===g.U16&&(f=new ht(e,s.byteOffset,p,h))):s.ncomp===3&&(s.type===g.F32&&(f=new Q(e,s.byteOffset,p,h)),s.type===g.U8&&(f=new ut(e,s.byteOffset,p,h)),s.type===g.U16&&(f=new mt(e,s.byteOffset,p,h))),f==null?this._dbg(y.VerboseAPI,"[Unsupported Feature] Unsupported view for Color ("+s+")"):n=new B(f.typedBuffer,T,s.ncomp);break;case V.FeatureIndex:break;default:this._dbg(y.VerboseAPI,"[Unsupported Feature] Unsupported semantic ("+o.sem+"). Skipping vertex attribute.")}}catch(_){this._dbg(y.VerboseAPI,"Error Creating buffer ("+_+"). Skipping vertex attribute.")}}if(t.index){const c=t.index.view,o=void 0,s=c.byteOffset+c.byteCount;switch(t.index.view.type){case g.U16:u=new Ue(e,c.byteOffset,o,s);break;case g.U32:u=new Oe(e,c.byteOffset,o,s);break;case g.U8:default:this._dbg(y.Error,"[Unsupported Feature] index type not supported ("+c.type+").")}}if(u==null&&d!=null){const c=d.count;if(c<65535){const o=new Uint16Array(c);u=new Ue(o)}else{const o=new Uint32Array(c);u=new Oe(o)}for(let o=0;o<c;o++)u.set(o,o)}return{positionView:d,positionAttr:r,colorAttr:n,texCoord0Attr:m,indicesView:u,normalsView:b,normalsAttr:x}}_onRemoveFromCache(t){const e=D(this.view);e&&e.onRenderableEvicted(this,t.handle,t.totalMemory()),this.freeRenderable(t.handle)}_dbg(t,e){this._dbgFlags.has(t)&&(t===y.Error?Ae.getLogger(this).error(e):Ae.getLogger(this).warn(e))}};k([ee()],U.prototype,"_visibleGeometryChangedSchedulerHandle",void 0),k([ee()],U.prototype,"layer",void 0),k([ee()],U.prototype,"elevationOffset",null),U=k([yt("esri.views.3d.layers.Tiles3DLayerView3D")],U);const jt=U;export{jt as default};
