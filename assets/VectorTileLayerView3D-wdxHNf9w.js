import{sX as N,sY as R,sW as V,kJ as A,ax as U,cC as F,t5 as W,tP as G,tQ as j,qv as k,s$ as y,pQ as Q,qw as L,bC as E,D as Y,tR as Z,tS as K,aw as J,ar as X,at as ee,az as te,au as ie,u as H,g,y as m,i as se}from"./index-BhDz4nJ7.js";import{n as le,e as ae,l as re,h as ne,t as oe}from"./TileInfoViewPOT-UT1HGCmB.js";import{u as he,f as ce,s as de,n as ue,d as ge}from"./WGLBrushVTLSymbol-DtHTPLWt.js";import{p as me}from"./VTLMaterialManager-D3r1bGOa.js";import{l as P}from"./StyleRepository-B-GKJQlU.js";import{n as ye}from"./LayerView3D-BKIbGugV.js";import{c as pe}from"./TiledLayerView3D-yNlB3ZCT.js";import{u as fe}from"./LayerView-C77uL6vR.js";import"./pbf-7bahT4Qy.js";import"./rasterizingUtils-Dtc6Jkjk.js";import"./constants-D5zmR9t2.js";import"./vec4f32-CjrfB-0a.js";import"./ShaderCompiler-G2XYGDs6.js";import"./programUtils-CwiKxPbA.js";import"./unitBezier-BX6NeAEr.js";class _e{constructor(e,t,s){this._scale=e,this._shift=t,this._levelShift=s}getLevelRowColumn(e){const t=this.getLevelShift(e[0]),s=this._shift+t;return s?[e[0]-t,e[1]>>s,e[2]>>s]:e}getLevelShift(e){return Math.min(e,this._levelShift)}getOffset(e,t){let s=0,a=0;const l=this._shift+this.getLevelShift(e[0]);if(l){const i=(1<<l)-1,r=t/(this._scale*(1<<l-1));s=(e[2]&i)*r,a=(e[1]&i)*r}return[s,a]}getScale(e){return this._scale*(1<<this._shift+this.getLevelShift(e))}}function ve(n){const e=[],t=new le(4096,e,()=>{const a=new V;return a.show=!1,a.parts.push({startTime:0,startOpacity:0,targetOpacity:0,show:!1}),a.parts.push({startTime:0,startOpacity:0,targetOpacity:0,show:!1}),a}),s=new ae(e,t,(a,l,i)=>new re(a,l,i,n.styleRepository,n.key.level,0),(a,l)=>{N(a,l,!1)},()=>0,a=>{const l=n.styleRepository.getStyleLayerByUID(a).getLayoutProperty("visibility");return!l||l.getValue()!==R.NONE});e.push(n),t.add(n),s.setScreenSize(512,512),s.continue(1/0)}class D extends ne{constructor(e,t,s,a){super(e,t,s,e.tileInfo.lods.length-1),this._memCache=a,this._ongoingTileRequests=new Map,this._ongoingRequestToController=new Map,this._tileInfoView=new oe(e.tileInfo,e.fullExtent)}destroy(){super.destroy(),this._ongoingRequestToController.forEach(e=>e.abort()),this._ongoingRequestToController.clear(),this._ongoingTileRequests.clear()}async getVectorTile(e,t,s,a){const l=new A(e,t,s,0);let i=this._memCache.get(l.id);if(i!=null)return i.retain(),i;const r=await this._getVectorTileData(l);if(U(a),!this._layer)return null;if(i=this._memCache.get(l.id),i!=null)return i.retain(),i;const o=this._layer.tileInfo.getTileBounds(F(),l),d=this._tileInfoView.getTileResolution(e);return i=new W(l,d,o[0],o[3],512,512,this._styleRepository,this._memCache),r?(i.setData(r),i.retain(),this._memCache.put(l.id,i,i.usedMemory,G)):i.setData(null),i.neededForCoverage=!0,i.transforms.tileUnitsToPixels=j(1/8,0,0,0,1/8,0,0,0,1),ve(i),i}_getVectorTileData(e){const t=e.id;if(this._ongoingTileRequests.has(t))return this._ongoingTileRequests.get(t);const s=new AbortController,a={signal:s.signal},l=this._getParsedVectorTileData(e,a).then(i=>(this._ongoingTileRequests.delete(t),this._ongoingRequestToController.delete(t),i)).catch(()=>(this._ongoingTileRequests.delete(t),this._ongoingRequestToController.delete(t),null));return this._ongoingTileRequests.set(t,l),this._ongoingRequestToController.set(t,s),l}_getParsedVectorTileData(e,t){return this.fetchTileData(e,t).then(s=>this.parseTileData({key:e,data:s},t))}}const Ce={vtlBackground:he,vtlFill:ce,vtlLine:de,vtlCircle:ue,vtlSymbol:ge},_=1e-6;class O{constructor(e,t){this.spriteMosaic=e,this.glyphMosaic=t,this._brushCache=new Map,this._vtlMaterialManager=new me}dispose(){this._brushCache&&(this._brushCache.forEach(e=>e.dispose()),this._brushCache=null),this._vtlMaterialManager=k(this._vtlMaterialManager),this.spriteMosaic.dispose(),this.glyphMosaic.dispose()}get vectorTilesMaterialManager(){return this._vtlMaterialManager}drawSymbols(e,t,s){const a=s.layers;e.renderPass="translucent";for(let l=0;l<a.length;l++){const i=a[l];if(i.type!==y.SYMBOL)continue;const r=i.getLayoutProperty("visibility");if(r&&r.getValue()===R.NONE)continue;const o=e.displayLevel;i.minzoom!==void 0&&i.minzoom>o+_||i.maxzoom!==void 0&&i.maxzoom<=o-_||(e.styleLayerUID=i.uid,e.styleLayer=i,this._drawWithBrush(e,t,"vtlSymbol"))}}drawBackground(e,t,s){if(s.backgroundBucketIds.length===0)return;const{context:a,displayLevel:l,requiredLevel:i}=e;t.key.level=i,a.setBlendingEnabled(!0),a.setDepthTestEnabled(!1),a.setStencilTestEnabled(!1),e.renderPass="background",s.backgroundBucketIds.forEach(r=>{const o=s.getLayerById(r);if(o.type!==y.BACKGROUND)return;const d=o.getLayoutProperty("visibility");d&&d.getValue()===R.NONE||o.minzoom!==void 0&&o.minzoom>l+_||o.maxzoom!==void 0&&o.maxzoom<=l-_||(e.styleLayerUID=o.uid,e.styleLayer=o,this._drawWithBrush(e,t,"vtlBackground"))})}drawTile(e,t,s,a){const{context:l}=e,i=s.layers;l.setBlendingEnabled(!1),l.setDepthTestEnabled(!0),l.setDepthWriteEnabled(!0),l.setDepthFunction(Q.LEQUAL),e.renderPass="opaque";for(let r=i.length-1;r>=0;r--){const o=i[r];a!=null&&a!==o.type||this._renderStyleLayer(o,e,t,!1)}l.setDepthWriteEnabled(!1),l.setBlendingEnabled(!0),l.setBlendFunctionSeparate(L.ONE,L.ONE_MINUS_SRC_ALPHA,L.ONE,L.ONE_MINUS_SRC_ALPHA),e.renderPass="translucent";for(let r=0;r<i.length;r++){const o=i[r];a!=null&&a!==o.type||this._renderStyleLayer(o,e,t,!1)}l.setDepthTestEnabled(!1),l.bindVAO()}_renderStyleLayer(e,t,s,a){if(!(a||e&&s.layerData.has(e.uid)))return;const l=e.getLayoutProperty("visibility");if(l&&l.getValue()===R.NONE)return;const{renderPass:i}=t;let r;switch(e.type){case y.BACKGROUND:if(i!=="background")return;r="vtlBackground";break;case y.FILL:if(i!=="opaque"&&t.renderPass!=="translucent")return;r="vtlFill";break;case y.LINE:if(i!=="translucent")return;r="vtlLine";break;case y.CIRCLE:if(i!=="translucent")return;r="vtlCircle";break;case y.SYMBOL:if(i!=="translucent")return;r="vtlSymbol"}const o=t.displayLevel;if(e.minzoom!==void 0&&e.minzoom>o+_||e.maxzoom!==void 0&&e.maxzoom<=o-_)return;const{context:d}=t;d.setStencilTestEnabled(!1),d.setStencilWriteMask(0),t.styleLayerUID=e.uid,t.styleLayer=e,this._drawWithBrush(t,s,r)}_drawWithBrush(e,t,s){if(!this._brushCache.has(s)){const a=Ce[s];this._brushCache.set(s,new a)}this._brushCache.get(s).drawMany(e,[t])}}let c=class extends pe(ye(fe)){constructor(){super(...arguments),this._tileHandlerController=null,this.type="vector-tile-3d",this.levelShift=E("disable-feature:vtl-level-shift")?0:1}initialize(){if(this.layer.fullExtent==null)return void this.addResolvingPromise(Promise.reject(new Y("vectortilelayerview:full-extent-undefined","This layer view's layer does not define a fullExtent.")));const{basemapTerrain:n,spatialReference:e,state:t,viewingMode:s}=this.view,a=s==="local"&&!Z(e)||K.force512VTL,l=this.layer.tileInfo.spatialReference.isGeographic,i=a?this.layer.tileInfo:this.layer.tileInfo.getOrCreateCompatible(256,l?1:2),r=this._getTileInfoSupportError(i,this.layer.fullExtent);if(r!=null)return this.addResolvingPromise(Promise.reject(r));const o=J(()=>{var h,u;return(u=(h=this.view)==null?void 0:h.basemapTerrain)==null?void 0:u.tilingSchemeLocked}).then(()=>{var S,v,M;const h=n.tilingScheme,u=h.pixelSize,b=u===256?1:2,p=(S=n.spatialReference)!=null&&S.isGeographic&&u===256?1:0,C=(v=n.spatialReference)!=null&&v.isGeographic||u!==256?0:1;let f;if(this.schemaHelper=new _e(b,p,this.levelShift+C),u===256){const z=this.layer.tileInfo.spatialReference.isGeographic;f=this.layer.tileInfo.getOrCreateCompatible(256,z?1:2)}else f=(M=this.view.spatialReference)!=null&&M.isGeographic?this.layer.tileInfo.getOrCreateCompatible(512,.5):this.layer.tileInfo;const w=this._getTileInfoCompatibilityError(f,h);if(w)throw w;this.tileInfo=f});this._tileHandlerController=new AbortController;const d=this.view.resourceController;this._memCache=d.memoryController.newCache(`vtl-${this.layer.uid}`,h=>{h.release()}),this.addHandles(X(()=>this.view.qualitySettings.memoryLimit,h=>this._memCache.maxSize=Math.ceil(h/10*1048576),ee));const B=new P(this.layer.currentStyleInfo.style);this._tileHandler=new D(this.layer,B,t.contentPixelRatio,this._memCache);const T=this._tileHandlerController.signal,x=we(d),I=this._tileHandler.start({signal:T,schedule:x}),$=this._tileHandler.spriteMosaic;$.then(h=>{!te(T)&&this._tileHandler&&(this.painter=new O(h,this._tileHandler.glyphMosaic))}),I.then(()=>this._tileHandlerController=null),this._updatingHandles.add(()=>{var h;return{style:this.layer.currentStyleInfo.style,pixelRatio:(h=this.view.state)==null?void 0:h.contentPixelRatio}},({style:h,pixelRatio:u})=>{this._tileHandlerController&&this._tileHandlerController.abort(),this._tileHandlerController=new AbortController,this._memCache.clear();const b=new P(h),p=new D(this.layer,b,u,this._memCache),C=p.start({signal:this._tileHandlerController.signal,schedule:x}),f=p.spriteMosaic;C.then(()=>this._tileHandlerController=null),this._updatingHandles.addPromise(Promise.all([C,f]).then(([,w])=>{const S=this._tileHandler,v=this.painter;this.painter=new O(w,p.glyphMosaic),this._tileHandler=p,this.emit("data-changed"),S.destroy(),v&&v.dispose()}))});const q=Promise.all([o,I,$]);this.addResolvingPromise(q)}destroy(){this.painter=k(this.painter),this._tileHandlerController=ie(this._tileHandlerController),this._tileHandler=H(this._tileHandler),this._memCache=H(this._memCache)}get contentZoom(){return E("disable-feature:vtl-level-shift")?1:this.view.qualitySettings.tiledSurface.vtlContentZoom}get displayLevelRange(){const n=this.tileInfo.lods,e=this.layer.minScale||n[0].scale,t=this.layer.maxScale||n[n.length-1].scale,s=this.levelRangeFromScaleRange(e,t);return this.layer.maxScale?s.maxLevel++:s.maxLevel+=this.levelShift,s}get dataScaleRange(){const n=this.tileInfo.lods;return{minScale:n[0].scale,maxScale:n[n.length-1].scale}}get dataLevelRange(){const{minScale:n,maxScale:e}=this.dataScaleRange,t=this.levelRangeFromScaleRange(n,e);return t.minLevel===1&&this.tileInfo.size[0]===256&&(t.minLevel=0),t.maxLevel+=this.levelShift,t}async fetchTile(n,e,t,s){return this._tileHandler.getVectorTile(n,e,t,s)}};g([m()],c.prototype,"layer",void 0),g([m()],c.prototype,"levelShift",void 0),g([m()],c.prototype,"contentZoom",null),g([m()],c.prototype,"displayLevelRange",null),g([m()],c.prototype,"tileInfo",void 0),g([m()],c.prototype,"dataScaleRange",null),g([m()],c.prototype,"dataLevelRange",null),g([m()],c.prototype,"updatingProgressValue",void 0),c=g([se("esri.views.3d.layers.VectorTileLayerView3D")],c);const Be=c;function we(n){return e=>n.immediate.schedule(e)}export{Be as default};
