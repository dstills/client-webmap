import{aE as o,c7 as l,E as m,J as h}from"./index-BS4ejk0L.js";import{N as p}from"./DynamicLayerView3D-CzDm9nsl.js";import{u}from"./ImageryLayerView-F4nwc3lg.js";import"./LayerView3D-CyxA26u0.js";import"./projectExtentUtils-BkTF27Em.js";import"./ImageMaterial.glsl-Bc9gQoIe.js";import"./LayerView-BXe9D6EI.js";import"./RefreshableLayerView-DHxrfAue.js";import"./popupUtils-D7QL1g2A.js";let r=class extends u(p){constructor(){super(...arguments),this.type="imagery-3d",this.redrawDebounced=o(async e=>{this.redraw((a,t)=>this._redrawImage(a,t),e)},2e3)}initialize(){this.addHandles([l(()=>this.view.basemapTerrain.ready,()=>this._initializeMaximumDataResolution(),{once:!0,initial:!0}),this.layer.on("redraw",()=>this._updatingHandles.addPromise(this.redrawDebounced()))]),this._updatingHandles.add(()=>{var e,a;return(a=(e=this.layer)==null?void 0:e.exportImageServiceParameters)==null?void 0:a.version},()=>{this._updatingHandles.addPromise(this.refreshDebounced())}),this._updatingHandles.add(()=>{var e;return(e=this.layer)==null?void 0:e.renderer},()=>{this._updatingHandles.addPromise(this.refreshDebounced())}),this._updatingHandles.add(()=>this.timeExtent,()=>this._updatingHandles.addPromise(this.refreshDebounced()))}_initializeMaximumDataResolution(){this.maximumDataResolution=this.layer.loaded?this.layer.serviceRasterInfo.pixelSize:null}getFetchOptions(){return{timeExtent:this.timeExtent}}async processResult(e,a,t){a.imageOrCanvasElement?e.image=a.imageOrCanvasElement:(e.image=document.createElement("canvas"),e.pixelData=a.pixelData,await this._redrawImage(e,t))}async _redrawImage(e,a){if(!(e.image instanceof HTMLCanvasElement)||e.pixelData==null)throw new Error;const t=e.image,s=t.getContext("2d"),d=await this.layer.applyRenderer(e.pixelData,{signal:a}),i=this.layer.applyFilter(d).pixelBlock;if(i==null)throw new Error;t.width=i.width,t.height=i.height;const n=s.createImageData(i.width,i.height);n.data.set(i.getAsRGBA()),s.putImageData(n,0,0)}};r=m([h("esri.views.3d.layers.ImageryLayerView3D")],r);const v=r;export{v as default};
